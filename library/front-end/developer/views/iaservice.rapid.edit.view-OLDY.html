<!DOCTYPE html>
<html>
<head>
    <base href="/javascripts/blockly/demos/code/">
    <meta charset="utf-8">
    <title>Blockly Demo: Resizable Blockly (Part 2)</title>

<!--    <link rel="stylesheet" href="//cdn.materialdesignicons.com/3.6.95/css/materialdesignicons.min.css">-->
    <link rel="stylesheet" href="../../../../share/mdi/css/materialdesignicons.min.css">
    <!-- Bootstrap Core Css -->
    <link href="../../../../share/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <!-- Custom Css -->
    <link href="../../../../share/css/style-x2.css" rel="stylesheet">
    <!--"https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.6/ace.js"-->
    <script src="../../../../share/plugins/ace/ace.js" type="text/javascript"
            charset="utf-8"></script>
    <style>
        .blocklySvg {
            /*background-color: #95c5d9 !important;*/
            /*fill: url(sprites.svg);*/
        }

        /*div#blocklyDiv .blocklyToolboxDiv {
            background: #292929;
            color: white;
        }*/

        .blocklyTreeRow {
            /*color: #777;*/
            height: 40px;
            padding: 10px;
        }

        .blocklyMainBackground {
             stroke-width: 0;
             /*stroke: tr;*/
        }

        .service.nav-tabs > li.active > a, .nav-tabs > li.active > a:hover, .nav-tabs > li.active > a:focus {
            background-color: transparent !important;
        }

        /*.nav-tabs {
            border-bottom: 1px solid;
        }*/

        html, body {
            height: 100%;
            margin: 0;
            background-color: transparent !important;
            /*color: white !important;*/
        }

        body {
            font-family: sans-serif;
            overflow: hidden;
        }

        h1 {
            font-weight: normal;
            font-size: 140%;
        }

        table#blockly {
            height: 90%;
            width: 100%;
            margin-bottom: 2pc;
        }

        #blocklyArea {
            height: 90%;
        }


        #editor {
            /*position: absolute;*/
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            height: 200px;
            font-size: inherit;
        }

        .servicesection {
            outline: 3px solid #d42021;
        }

        input, textarea {

            padding-left: 5px;
            text-indent: 5px;
        }

        input:focus, textarea:focus {
            background-color: white !important;
            color: #2e1c0d !important;
            padding-left: 5px;
            text-indent: 5px;
        }

        select {
            background-color: #EEEEEE !important;
            /*color: #93fbff !important;*/
        }


        .blocklyToolboxDiv {
            color: black;
        }



        .accordion span {
            float: left;
            font-size: x-large;
            margin-top: -6px;
            /*font-xweight: bold;*/
        }

        /*.accordion {
            background-color: #efefef;
        }

        .accordion.collapsed {
            background-color: white;
        }*/

        .accordion span, .accordion div {
            color: #d42021;
        }

        .accordion.collapsed div {
            color: inherit;
        }
        .accordion.collapsed span {
            transform: rotate(-90deg);
            color: inherit;
        }

        .correspondence-list {
            padding-left: 24%;
        }

        /*.correspondence-list > div {
            !* border: 2px solid; *!
            width: 70%;
            margin-left: 24%;
        }*/

        .correspondence-list div.user-text{
            padding: .5pc;
            margin: .3pc;
            font-weight: normal;
            color: #6e6b5e;
            /*background-color: #f9f9f9;*/
        }
    </style>


    <!--moment.js Plugin Js-->
    <script src="../../../../share/plugins/momentjs/moment.js" ></script>
</head>

<body class="" >
<div class="" sspage-load-json="/iaservice/[sspagesearch.id]" sspage-load-json-var="oldservice" id="serviceload"
     sspage-load-after="setTimeout(function(){initPage()}, 10)"></div>

<!-- Nav tabs -->
<ul class="nav nav-tabs tab-col-red service" role="tablist">
    <li role="presentation" class="">
        <a href="#srvmain" data-toggle="tab" aria-expanded="true">
            <i class="mdiX Xmdi-home "></i> Profile
        </a>
    </li>
    <li role="presentation" class="active">
        <a href="#srvblockly" data-toggle="tab" aria-expanded="false">
            <i class="mdiX Xmdi-video-input-component "></i> Blocks
        </a>
    </li>
    <li role="presentation" class="">
        <a href="#srvcode" data-toggle="tab" aria-expanded="false">
            <i class="mdiX Xmdi-code-tags "></i> Code
        </a>
    </li>
    <!-- <li role="presentation" class="">
         <a href="#srvbuttons" data-toggle="tab" aria-expanded="false">
             <i class="mdi mdi-gesture-tap "></i> TAPS
         </a>
     </li>-->
    <li role="presentation" class="">
        <a href="#srvpayment" data-toggle="tab" aria-expanded="false">
            <i class="Xmdi-credit-card-settings  mdiX"></i> Payment
        </a>
    </li>
    <li role="presentation" class="hidden" ssif="oldservice.Publish.CurrentVersion > 0 ">
        <a href="#srvpublish" data-toggle="tab" aria-expanded="false">
            <i class="Xmdi-credit-card-settings  mdiX"></i> Publish
        </a>
    </li>

    <!--<a href="#srvpublish" data-toggle="tab" aria-expanded="false" style="border: 2px solid green !important;
    border-radius: 20px; line-height: 1;position: absolute;
    right: 1.5pc; color: green !important;" class="btn btn-link col-green srvpublish">
        Publish
    </a>-->
    <li class="dropdown" style="position: absolute;line-height: 1; right: 0; left: auto; color: white !important;">
        <a href="javascript:void(0);" class="dropdown-toggle btn btn-link" data-toggle="dropdown" role="button"
           aria-haspopup="true" aria-expanded="false" style="line-height: 1;padding: 0">
            <i style="font-size: larger; font-weight: bold;
            line-height: 1 !important;transform: rotate(90deg);display: block">...</i>
        </a>
        <ul style="position: relative; top: 15px;" class="dropdown-menu pull-right ">
            <li><a href="#" onclick="$('.nav-tabs a[href=\'#srvpublish\']').tab('show');return false;"
                   class=" waves-effect waves-block ">
                Publish
            </a></li>
            <li><a href="#" onclick="installForMe();return false"
                   sspage-group="menu"
                   class=" waves-effect waves-block ">
                Install for me
            </a></li>
            <li><a href="javascript:deleteIAService(); void(0);" class=" waves-effect waves-block col-red"

            >Delete Service</a></li>
        </ul>
    </li>
</ul>


<table id="blockly">
    <tr>
        <td id="blocklyArea">
            <div id="blocklyDiv" style="position: absolute"></div>
        </td>
    </tr>
    <tr>
        <td> </td>
    </tr>
</table>
<!-- Tab panes -->
<div class="tab-content m-t-10">
    <div role="tabpanel" class="tab-pane fade active in" id="srvmain">
        <!--<b class="ia-big-title">Main Information of BKC Service</b>-->
        <div class="row">
            <div class="col-sm-4">
                <!--<label for="name"><span class=" ia-big-title col-red">Name of Service</span></label>-->
                <label class="form-label" for="name">Service Name</label>
                <div class="form-group form-float">
                    <div class="form-line">
                        <input type="text" name="Name" id="name" placeholder="An alphanumeric name"
                               class="form-control" required onchange="this.value=this.value.trim()"
                               ssbind="value:newservice.Name">

                    </div>
                </div>
            </div>

            <div class="col-sm-4 hidden">
                <label class="form-label" for="copyright">Copyright</label>
                <div class="form-group form-float">
                    <div class="form-line">
                        <input type="hidden" id="copyright" class="form-control" required
                               ssbind="value:newservice.Copyright">
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <label class="form-label" for="category">Category</label>
                <div class="form-group form-float">
                    <div class="form-line">
                        <select class="form-control"
                                id="category">
                            <option ssfor="ServiceCategories"
                                    ssbind="text:ServiceCategories[ssIndex]; value:ServiceCategories[ssIndex]; selected:ServiceCategories[ssIndex]==newservice.Category"></option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-sm-12">
                <label class="form-label" for="description">Description</label>
                <div class="form-group form-float">
                    <div class="form-line">
                                            <textarea type="text" name="Description" id="description"
                                                      ssbind="value:newservice.Description"
                                                      class="form-control" placeholder="Describe your service here ..."
                                                      rows="3"></textarea>
                    </div>
                </div>
            </div>


            <div class="col-sm-3">
                <label for="srviconfile">Logo</label><br>
                <small class="col-grey">Add an Icon or Logo for your service</small>
                <div class="form-group form-float">
                    <div class="service">
                        <input type="file" accept="image/x-png,image/gif,image/jpeg" id="srviconfile"
                               class="form-control"
                               required style="background-color: transparent;">
                    </div>
                </div>
                <small class="col-grey">Your file must be .JPG or .PNG format,<br>Recommended size is 512x512
                    pixels.
                </small>
            </div>
            <div class="col-sm-2 service">

                <label for="srviconfile" id="drop-area"><img id="srviconpreview" class="img-responsive b-1"
                                                             ssbind="src:newservice.Icon || defaulticon"></label>
                <div class="text-center hidden"><span id="iconwidth">512</span> X <span
                        id="iconheight">512</span>
                </div>


            </div>
        </div>
    </div>

    <div role="tabpanel" class="tab-pane fade" id="srvcode">
        <!--//code editor from https://ace.c9.io-->
        <div class="">
            <b class=" ia-big-title col-red">Service Code</b>
            <span class="col-red">(Read Only)</span>
            <div class="ace-solarized_dark">
                <div id="editor" ssbind="html:newservice.Code">
                </div>
            </div>
        </div>
    </div>
    <div role="tabpanel" class="tab-pane fade" id="srvpayment">
        <br>
        <div class="row">
            <div class="col-sm-5">
                <label class="form-label ia-big-title col-red" for="priceadd">Install Price</label>
                <div class="form-group form-float">
                    <small class="col-grey ">How many BKCs would be paid for Installing this service?</small>
                    <div class="m-t-10 ">
                        <input type="number" min="0" max="100000" id="priceadd"
                               class="form-control ia-bigger-title b-1  " required value="0"
                               ssbind="value:oldservice.Price.Add" sslevel="oldserv">

                    </div>
                    <!--<label for="priceadd" style=" position: relative;top: -28px;left: 70%; width: 50px;">BKC</label>-->
                </div>
            </div>
            <div class="col-sm-5">
                <label class="form-label ia-big-title col-red" for="pricerun">Run Price</label>
                <div class="form-group form-float">
                    <small class="col-grey">How many BKCs would be paid when every run of this service?</small>
                    <div class="m-t-10">
                        <input type="number" min="0" max="100000" id="pricerun"
                               class="form-control ia-bigger-title b-1 " required value="0"
                               ssbind="value:oldservice.Price.Run" sslevel="oldserv">
                    </div>
                    <!--<label for="pricerun" style=" position: relative;top: -28px;left: 70%; width: 50px;">BKC</label>-->
                </div>
            </div>
        </div>
    </div>
    <div role="tabpanel" class="tab-pane fade" id="srvsetting">
        <div class="form-group form-float">
            <div class="">
                <b class=" ia-big-title col-red">Security</b>
                <br>
                <small class="col-grey">Which access need your new service?<br><br></small>

                <ul style="list-style: none">
                    <li ssfor="home_accesses" sslevel="srvaccess">
                        <!--<input name="srvaccess" ssbind="value:home_accesses[ssIndex]" type="checkbox">
                        <span ssbind="text:home_accesses[ssIndex]"></span>-->

                        <input type="checkbox" name="srvaccess" class="filled-in chk-col-red"
                               sslevel="srvaccess"
                               ssbind="id :'acc'+ssIndex; value:home_accesses[ssIndex]; checked: newservice.NeedAccesses.indexOf(home_accesses[ssIndex])>-1">
                        <label ssbind="for:'acc'+ssIndex; text:home_accesses[ssIndex]" sslevel="srvaccess">Access</label>
                    </li>
                </ul>

            </div>
        </div>
        <div class="form-group form-float">
            <div class=" m-t-10">
                <b class=" ia-big-title col-red">Schedule</b>
                <br>
                <!--<small class="col-grey">Check if this service runs schedully</small>-->
                <!--<br><br>-->
                <ul>
                    <input type="checkbox" name="Cron" id="cron" class="filled-in chk-col-red"
                           ssbind="checked: newservice.Cron"
                           value="true"> <label for="cron">This service runs on the
                    schedule</label>
                </ul>
            </div>
        </div>
    </div>
    <div role="tabpanel" class="tab-pane fade" id="srvpublish">
        <b class=" ia-big-title col-red">Publish in Service Market</b>
        <br>
        <!--<small class="col-grey">Taps are buttons in the service box, Define them with their title and bind to a
            function in code,
        </small>-->
        <!--<div class="switch s">
            <label><span class="col-grey">Unpublished</span><input type="checkbox"
                                                                   ssbind="checked:newservice.Published"
                                                                   id="srvpublished"><span
                    class="lever switch-col-green"></span><span class="col-green">Published</span> </label>
        </div>

        <br>-->

        <div class="alert bg-amber col-red hidden" ssif="oldservice.Publish && oldservice.Publish.PublishedVersion" sslevel="releases">This service is published at release version
            <span ssbind="text:oldservice.Publish.PublishedVersion" sslevel="releases" class="font-bold badge bg-red font-20"></span>
        </div>

        <div>
            If you want publish your service in the BKC Service Market to other users could install it, you have to add a new release for your service.
            Then after reviewing the release, if there was not any issue, the BKC admin will publish your service in the BKC Service Market.
            <br><br>
            <button sslevel="releases" ssbindXX="disabled:oldservice.Publish && oldservice.Publish.SubmittedVersion"
                    onclick="addRelease();" class=" btn btn-primary-ia ia-big-title">add Release</button>
        </div>


        <!--<div class="p-t-10 p-l-20 p-r-20 p-b-15 m-t-20 m-b-20 bg-danger">

            <div class="col-black">
                For adding new Release click
                <button sslevel="releases" ssbind="disabled:oldservice.Publish && oldservice.Publish.SubmittedVersion"
                    onclick="addRelease();" class=" btn btn-primary-ia ">add Release</button>
            </div>
            <ul class="m-t-15">
                <li class="font-small col-grey">If you already have requested a release to review, you could not add another release until you wait for it's review result, or you cancel it.</li>
            </ul>
        </div>-->

        <!--<h6>Releases</h6>-->
        <div role="tabpanel" class="tab-pane fade active in panel-group p-b-10" id="accordion" style="height: 270px; overflow-y: auto">
            <!--header-->
            <div class="m-b-10 b-b-1 col-grey hidden-xs">
                <div class="panel-heading m-l--15">

                    <!--<h4 class="panel-title p-l-0 p-r-0">-->
                    <!--<a data-toggle="" data-parent=""  class=" ">-->
                        <div class="row">
                            <div class="col-sm-1 col-xs-1 "><span class="mdi mdi-play col-white"></span></div>
                            <div class="col-sm-2 col-xs-4 font-bold">Version</div>
                            <div class="col-sm-4 col-xs-5 font-bold align-right">Release Time</div>
                            <div class="col-sm-4 col-xs-5 font-bold align-right">Status</div>
                        </div>
                    <!--</a>-->
                    <!--</h4>-->
                </div>
            </div>
            <!--list-->
            <div class="panel panel-default1" ssfor="oldservice.Publish.Releases" ssforreverse="ssforreverse" sslevel="releases" ssemptylist="You have not created any release yet.">
                <div class="panel-heading m-l--15">
                    <a data-toggle="collapse" data-parent="#accordion" class="accordion collapsed btn-link waves-effectXX m-b--5" ssbind="href:'#'+oldservice.Publish.Releases[ssIndex]._id" sslevel="releases">

                        <div ssbind="class: oldservice.Publish.Releases[ssIndex].OnPublish?'row col-green':'row'" sslevel="releases">
                            <div class="col-sm-1 col-xs-1 font-13 col-grey ">
                                <span class="mdi mdi-chevron-down"></span>
                            </div>
                            <div class="col-sm-2 col-xs-10 font-13 font-bold" ssbind="text:oldservice.Publish.Releases[ssIndex].Version" sslevel="releases"></div>
                            <div class="col-sm-4 col-xs-12 font-13 Status align-right" ssbind="text:moment(oldservice.Publish.Releases[ssIndex].ReleaseTime).format('YYYY-MMM-DD dd HH:mm')" sslevel="releases"></div>
                            <div class="col-sm-4 col-xs-12 font-13 Status align-right" ssbind="text:(oldservice.Publish.Releases[ssIndex].UnPublishTime?'Unpublished after ':'') + (oldservice.Publish.Releases[ssIndex].SurveyResult || '')" sslevel="releases"></div>
                            <!--<div class="col-sm-2 col-xs-12 font-13 col-grey align-right" ssbind="text:moment(releases[ssIndex].updatedAt).fromNow();title:releases[ssIndex].updatedAt" sslevel="releases"></div>-->
                        </div>
                    </a>
                </div>
                <div class="panel-collapse collapse " ssbind="id:oldservice.Publish.Releases[ssIndex]._id" sslevel="releases" >
                    <!--<pre ssbind="text:JSON.stringify(oldservice.Publish.Releases[ssIndex],null,'\t')" sslevel="releases"></pre>-->

                    <div ssif="oldservice.Publish.Releases[ssIndex].SurveyTime" sslevel="releases"
                         class="bg-black bg-red col-amber p-b-10 p-l-20 p-r-20 p-t-10" style="border-top: 7px solid #FFC107;" >

                        <li class="hidden" ssif="oldservice.Publish.Releases[ssIndex].CheckingTime" sslevel="releases"> Checked at <span ssbind="text:moment(oldservice.Publish.Releases[ssIndex].CheckingTime).format('YYYY-MMM-DD dd HH:mm')" sslevel="releases"></span></li>

                        <li>
                            Status changed to
                            <span ssbind="text:oldservice.Publish.Releases[ssIndex].SurveyResult" sslevel="releases"></span>
                            at
                            <span ssbind="text:moment(oldservice.Publish.Releases[ssIndex].SurveyTime).format('YYYY-MMM-DD dd HH:mm')" sslevel="releases"></span>
                        </li>

                        <li class="hidden" ssif="oldservice.Publish.Releases[ssIndex].PublishTime" sslevel="releases"> Published at <span ssbind="text:moment(oldservice.Publish.Releases[ssIndex].PublishTime).format('YYYY-MMM-DD dd HH:mm')" sslevel="releases"></span></li>
                        <li class="hidden" ssif="oldservice.Publish.Releases[ssIndex].UnPublishTime" sslevel="releases"> Unpublished to version <span ssbind="text:oldservice.Publish.Releases[ssIndex].UnPublishToVersion" sslevel="releases"></span> at <span ssbind="text:moment(oldservice.Publish.Releases[ssIndex].UnPublishTime).format('YYYY-MMM-DD dd HH:mm')" sslevel="releases"></span></li>

                    </div>
                    <button ssif="oldservice.Publish.Releases[ssIndex].SurveyResult==='Requested'" sslevel="releases" onclick="deleteRelease(oldservice.Publish.Releases[ssIndex]._id,'delete')" class="btn btn-primary-ia hidden float-right m-t--50 m-r-20">Delete Release</button>
                    <button ssif="oldservice.Publish.Releases[ssIndex].SurveyResult==='Published' && oldservice.Publish.Releases[ssIndex].OnPublish" sslevel="releases" onclick="deleteRelease(oldservice.Publish.Releases[ssIndex]._id,'unpublish')" class="btn btn-primary-ia hidden float-right m-t--50 m-r-20">Unpublish Release</button>

                </div>
            </div>

            <br><br><br>
        </div>

    </div>
</div>

<xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">

    <category name="Logic" colour="%{BKY_LOGIC_HUE}">
        <block type="controls_if"></block>
        <block type="logic_compare"></block>
        <block type="logic_operation"></block>
        <block type="logic_negate"></block>
        <block type="logic_boolean"></block>
    </category>
    <category name="BKC Devices" colour="#d46668">
        <!--<block type="variables_get"><field name="VAR">k</field></block>-->
        <label text="Sensors:" web-class="myLabelStyle"></label>
        <sep gap="10"></sep>
        <block type="MOTION_DETECTOR"></block>
        <block type="DOOR_SENSOR"></block>
        <block type="SMART_BUTTON"></block>
        <block type="TEMP_HUM"></block>
<!--        <block type="IA_SHORTCUT"></block>-->
        <label text="Actuators:" web-class="myLabelStyle"></label>
        <sep gap="10"></sep>
        <block type="LIGHT_SWITCH"></block>
        <block type="POWER_PLUG"></block>
        <block type="POWER_PLUG_STATE"></block>
        <block type="SMART_SPEAKER"></block>
        <block type="SMART_SPEAKER_STATE"></block>

        <!--TODO <block ssfor="Object.keys(devicetemps)" ssbind="type: Object.keys(devicetemps)[ssIndex]"></block>-->
    </category>
    <category name="Service Contract" colour="#373737">
        <block type="BKC_TRANSFER"></block>
    </category>
    <category name="Messages" colour="#64a0d4">
        <block type="IAMessage_sendEmail"></block>
        <block type="IAMessage_sendSMS" disabled="true"></block>
        <block type="IAMessage_pushNotification"></block>
    </category>
    <category name="Utils" colour="#ffb03e">
        <!--<block type="Current_Time"></block>-->
        <block type="IA_Cron"></block>
        <block type="Home_Guard"></block>
        <block type="Service_Button"></block>
    </category>
    <category name="Loops" colour="%{BKY_LOOPS_HUE}">
        <block type="controls_repeat_ext">
            <value name="TIMES">
                <block type="math_number">
                    <field name="NUM">10</field>
                </block>
            </value>
        </block>
        <!--<block type="controls_whileUntil"></block>-->
    </category>
    <category name="Functions" custom="PROCEDURE" colour="%{BKY_PROCEDURES_HUE}">
        <block type="function"></block>
    </category>
    <category name="Math" colour="%{BKY_MATH_HUE}">
        <block type="math_number">
            <field name="NUM">123</field>
        </block>
        <block type="math_arithmetic"></block>
        <block type="math_single"></block>
    </category>
    <category name="Text" colour="%{BKY_TEXTS_HUE}">
        <block type="text"></block>
        <block type="text_length"></block>
<!--        <block type="text_print"></block>-->
    </category>

</xml>

<div class="text-right button-pan" id="buttonpanelrsrv" style="right: 0pc;
  bottom: 0pc;">
    <button class="btn btn-link col-red waves-effect-x2  align-right ia-big-title"
            onclick="window.parent.show_sspage('/developer/views/iaservice.developer.page.view.html')">
        Back
    </button>
    <button class="btn btn-primary-ia waves-effect-x2 align-right ia-big-title"
            onclick="updateIAServiceRapid()">
        Save Changes
    </button>
</div>

<!-- Jquery Core Js -->
<script src="../../../../share/plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap Core Js -->
<script src="../../../../share/plugins/bootstrap/js/bootstrap.js"></script>

<!--ssbind-->
<script src="../../../../share/js/ssbind.js"></script>
<!--sspage navigator-->
<script src="../../../../share/js/sspages.js"></script>

<!--share js-->
<script src="../../../../share/js/share.js"></script>
<!--blockly-->
<script src="../../blockly_compressed.js"></script>
<script src="../../blocks_compressed.js"></script>
<script src="../../javascript_compressed.js"></script>
<script src="../../msg/js/en.js"></script>

<script>
    /*define("DynHighlightRules", [], function(require, exports, module) {
     "use strict";

     var oop = require("ace/lib/oop");
     var TextHighlightRules = require("ace/mode/javascript_highlight_rules").TextHighlightRules;

     var DynHighlightRules = function() {
     this.setKeywords = function(kwMap) {
     this.keywordRule.onMatch = this.createKeywordMapper(kwMap, "identifier")
     }
     this.keywordRule = {
     regex : "\\w+",
     onMatch : function() {return "text"}
     }

     this.$rules = {
     "start" : [
     {
     token: "string",
     start: '"',
     end: '"',
     next: [{ token : "constant.language.escape.lsl", regex : /\\[tn"\\]/}]
     },
     this.keywordRule
     ]
     };
     this.normalizeRules()
     };

     //oop.inherits(DynHighlightRules, TextHighlightRules);

     exports.DynHighlightRules = DynHighlightRules;

     });*/
    var editor_;
    function initEditor() {
        editor_ = ace.edit("editor");
//            editor_.setTheme("ace/theme/solarized_dark");

        editor_.session.setMode("ace/mode/javascript");

        editor_.setReadOnly(true);
        /*var jsMode = require("ace/mode/javascript").Mode;
         var IOTLMode = new jsMode();
         IOTLMode.HighlightRules = require("DynHighlightRules").DynHighlightRules;

         IOTLMode.$highlightRules.setKeywords({"keywords": "first|items|editor"})

         editor_.session.setMode(IOTLMode);

         var keywords = /syntax|highlighted/g
         editor_.findAll(keywords, {
         //caseSensitive: false,
         //wholeWord: true,
         regExp: true
         });*/
    }

    //icon to base64:
    // Check for the File API support.
    var srviconbase64 = '';
    var srviconvalid = true;
    var srviconmessage = '';

    function handleFileSelectRapid(evt) {
        var f = evt.target.files[0]; // FileList object
        if (!f.type.startsWith('image')) {
            let iconimg = document.getElementById('srviconpreview');
            iconimg.src = defaulticon;
            srviconbase64 = '';
            srviconmessage = 'Bad file type is selected, please select a true image file with extension .PNG or .JPG';
            window.parent.swal.fire({
                title: 'Service Icon',
                text: srviconmessage,
                //html: true,
                timer: 3000,
                //icon: "warning",
                imageUrl: "images/error.png",
                imageWidth: 50,
                showConfirmButton: true
            });
            return;
        }
        var reader = new FileReader();
        // Closure to capture the file information.
        reader.onload = (function (theFile) {
            return function (e) {
                var binaryData = e.target.result;
                //Converting Binary Data to base 64
                var base64String = window.btoa(binaryData);
                //showing file converted to base64
                srviconbase64 = 'data:image/png;base64,' + base64String;
                let iconimg = document.getElementById('srviconpreview');
                $('#srviconpreview').removeClass('img-responsive')
                iconimg.src = srviconbase64;
                setTimeout(() => iconFileChanged(iconimg), 200);
            };
        })(f);
        // Read in the image file as a data URL.
        reader.readAsBinaryString(f);
    }

    function iconFileChanged(iconimg) {
        console.log('srviconbase64', iconimg.clientWidth, iconimg.clientHeight);

        $('#iconwidth').text(iconimg.clientWidth);
        $('#iconheight').text(iconimg.clientHeight);

        srviconvalid = true;
        srviconmessage = '';
        /*if(iconimg.clientWidth != iconimg.clientHeight) {
         srviconvalid = false;
         srviconmessage = 'Width and Height of icon must be equal'
         }*/
        if (iconimg.clientWidth > 512 || iconimg.clientHeight > 512) {
            srviconvalid = false;
            srviconmessage = 'Width and Height of icon must be <= 512 px'
        }

        $('#srviconpreview').addClass('img-responsive')

        if (!srviconvalid) {
            window.parent.swal.fire({
                title: 'Service Icon',
                text: srviconmessage,
                //html: true,
                //                    timer: 2000,
                //icon: "warning",
                imageUrl: "images/error.png",
                imageWidth: 50,
                showConfirmButton: true
            });
        }
    }

    function updateIAServiceRapid() {
        var nsrv = {};
        var isvalid = true;
        var validatemessage = '';
        var messagetitle = '';

//        nsrv.Published = document.querySelector('#srvpublished').checked;


        if (!document.querySelector('#name').checkValidity()) {
            isvalid = false;
            validatemessage = document.querySelector('#name').validationMessage;
            messagetitle = "Service Name";
        } else if (document.querySelector('[name="Description"]').value === '' && nsrv.Published) {
            isvalid = false;
            validatemessage = 'Please describe your service briefly by filling Description field';
            messagetitle = "Description";
            $('.nav-tabs a[href="#srvmain"]').tab('show');
            $('#description').focus();
        } else if (!document.querySelector('#priceadd').checkValidity()) {
            isvalid = false;
            validatemessage = document.querySelector('#priceadd').validationMessage;
            messagetitle = "Install Price";
        } else if (!document.querySelector('#pricerun').checkValidity()) {
            isvalid = false;
            validatemessage = document.querySelector('#pricerun').validationMessage;
            messagetitle = "Run Price";
        }

        if (!isvalid) {
            window.parent.swal.fire({
                title: messagetitle,
                text: validatemessage,
                //html: true,
                //                    timer: 2000,
                //icon: "warning",
                imageUrl: "images/error.png",
                imageWidth: 50,
                showConfirmButton: true
            });
            return;
        }

        if (!srviconvalid) {
            window.parent.swal.fire({
                title: 'Service Icon',
                text: srviconmessage,
                //html: true,
                //                    timer: 2000,
                //icon: "warning",
                imageUrl: "images/error.png",
                imageWidth: 50,
                showConfirmButton: true
            });
            return;
        }

        nsrv.Name = $('#name').val();
        nsrv.Description = $('#description').val();

        //Cron
        var ia_crons = demoWorkspace.getBlocksByType("IA_Cron");
        if(ia_crons.length > 1){
//            alert('No need more than one schedule block in the workspace!')

            window.parent.swal.fire({
                title: 'Warning',
                text: 'No need more than one schedule block in the workspace!',
                //html: true,
                //                    timer: 2000,
                //icon: "warning",
                imageUrl: "images/error.png",
                imageWidth: 50,
                showConfirmButton: true
            });
            return;
        }

        if(ia_crons.length > 0){
            var hascronfunc = demoWorkspace.getBlocksByType("procedures_defnoreturn").filter((f)=>f.getProcedureDef()[0]==='cron').length === 1
            if(!hascronfunc){
//                alert('Because you have a Schedule block in workspace, then you need a function with name "cron" to run in scheduled times!')
                window.parent.swal.fire({
                    title: 'Warning',
                    text: 'Because you have a Schedule block in workspace, then you need a function with name "cron" to run in scheduled times!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });

                return;
            }
        }

        nsrv.Cron = ia_crons.length > 0;
        nsrv.Copyright = document.querySelector('#copyright').value;
        nsrv.Category = document.querySelector('#category').value;

        nsrv.Vars = newservice.Vars;


        nsrv.Code = editor_.getValue();
        nsrv.BlocklyXML = getWorkspaceXml();
        //add device types
//            restoreWorkspace(nsrv.BlocklyXML);//for deleting removed vars from getAllVariables

        //service.Devices
        newservice.Devices = [];
        var devs = Blockly.Variables.allUsedVarModels(demoWorkspace);
        for(var d of devs) {
            newservice.Devices.push({
                'Name': d.name,
                'DeviceType': d.type,
                'Invoker': devicetemps[d.type].type === "SENSOR",
                'TransferTo': transfers.includes(d.name)
            });
        }

        nsrv.Devices = newservice.Devices;

        //service.Buttons
        newservice.Buttons = [];
        var buttons = demoWorkspace.getBlocksByType("Service_Button");
        for(var b of buttons) {


            var title = b.getFieldValue('TITLE');
            if(title===''){
//                alert('Please set a title for Button!');
                window.parent.swal.fire({
                    title: 'Warning',
                    text: 'Please set a title for Button!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            var nextBlock = b.getNextBlock();
            if(!nextBlock){
//                alert('Button '+title+' need a function in next block!')
                window.parent.swal.fire({
                    title: 'Warning',
                    text: 'Button '+title+' need a function in next block!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            newservice.Buttons.push({
                'Title': title,
                'Function': nextBlock.getProcedureCall()
            });
        }
        nsrv.Buttons = newservice.Buttons;

        nsrv.NeedAccesses = Array.from(document.querySelectorAll('input[name="srvaccess"][type="checkbox"]'))
            .filter((checkbox) => checkbox.checked)
            .map((checkbox) => checkbox.value);
        nsrv.Icon = srviconbase64;
        nsrv.Iconpadding = false;

        nsrv.Price = {
            Add: $('#priceadd').val(),
            Run: $('#pricerun').val()
        };



        console.log('new service', nsrv);

        $.ajax({
            url: '/iaservice/' + newservice._id,
            data: nsrv,
//            async: !1,
            type: "put",
            dataType: "json",
            success: function (response) {
                window.parent.swal.fire("Success", response.message, "success").then((value) => {
                    //window.location = '/customer/logout'
                });
            },
            error: function (xhr, ajaxOptions, thrownError) {
                console.error(xhr, ajaxOptions, thrownError);
                //alert(thrownError + " - " + ajaxOptions);
            }
        }).fail(function (response) {
            window.parent.swal.fire("Error", response.responseJSON.message || response.statusText, "error");
        });
    }

    function deleteIAService() {
        /*window.parent.swal.fire("Attention", "Do you want to Delete this service?", "warning",{
         buttons: {
         Yes: "Yes Delete",
         Cancel: {
         text: "Cancel",
         value: "Cancel",
         }
         }
         }).then((value) => {
         switch (value) {

         case "Yes":*/
        if(confirm("Do you want to delete this service?")) {
            $.ajax({
                url: '/iaservice/' + oldservice._id,
                type: 'DELETE',
                success: function (result) {
                    window.parent.swal.fire("BKC Service Deleted", "BKC Service removed successfully","success");
                    window.parent.show_sspage("/developer/views/iaservice.developer.page.view.html")
                }
            }).fail(function (response) {
                window.parent.swal.fire("Error", response.responseJSON.message || response.statusText, "error");
            });;
        }
        /*break;

         case "Cancel":
         break;
         }
         });*/
    }

    function addRelease() {
        if(oldservice.Publish && oldservice.Publish.SubmittedVersion) {
//            alert("If you already have requested a release to review, you could not add another release until you wait for it's review result, or you cancel it");
            window.parent.swal.fire({
                title: 'Warning',
                text: "If you already have requested a release to review, you could not add another release until you wait for it's review result, or you cancel it",
                //html: true,
                //                    timer: 2000,
                //icon: "warning",
                imageUrl: "images/error.png",
                imageWidth: 50,
                showConfirmButton: true
            });
            return;
        }

        window.parent.swal.fire({
//            title: "Attention",
            html: "Do you want to add new release to this service?",
            icon: "question",
//            imageUrl: "images/error.png",
//            imageWidth: 50,
            showCancelButton: true,
            confirmButtonText: 'Yes'
        }).then((result) => {
            if (result.value) {
//        if(confirm("Do you want to add new release to this service?")) {
                $.ajax({
                    url: '/iaservice/release/' + oldservice._id,
                    type: 'POST',
                    success: function (result) {
                        window.parent.swal.fire("BKC Service Release", "New release added successfully", "success");
                        load_sspage($('#serviceload'));
                    }
                }).fail(function (response) {
                    window.parent.swal.fire("Error", response.responseJSON.message || response.statusText, "error");
                });
            }
        })
    }

    function deleteRelease(releaseId, action) {
        if(confirm(`Do you want to ${action} this release?`)) {
            $.ajax({
                url: '/iaservice/release/' + oldservice._id+'/'+releaseId,
                type: 'DELETE',
                success: function (result) {
                    window.parent.swal.fire("BKC Service Release", result.message,"success");
                    load_sspage($('#serviceload'));
                }
            }).fail(function (response) {
                window.parent.swal.fire("Error", response.responseJSON.message || response.statusText, "error");
            });
        }
    }

    function installForMe() {
        window.parent.swal.fire("Warning", "You are installing this service via \"Install for Me\" button, Please note that if in future you change the service source code through the \"Service Creator\" page, the  installed version will be changed too. ", "warning").then((result) => {
            if (result.value) {
                window.parent.swal.fire({
                    title: "",
                    width: '80vw',
                    html: '<div id="inlinegallery">...</div>',
//                    timer: 2000,
//                icon: "warning",
                    showConfirmButton: false
                });
                window.parent.show_sspage('../customer/views/iaservice.gallery.customer.view.html?serviceId='+oldservice._id , null , '#inlinegallery')
            }
        });

    }


    //TODO ssbindRender();

//    var _id = (new URLSearchParams(window.location.search)).get('id');

    //blockly visible
    //    $('#blockly').hide();
    //tab change
    $(document).on('shown.bs.tab', 'a[data-toggle="tab"]', function (e) {
        if($(e.target).attr('href')==='#srvblockly'){
            $('#blockly').show();
        } else {
            $('#blockly').hide();
        }

        if($(e.target).attr('href')==='#srvpublish'){
            $('#buttonpanelrsrv').hide();
        } else {
            $('#buttonpanelrsrv').show();
        }
    });

    var blocklyArea = document.getElementById('blocklyArea');
    var blocklyDiv = document.getElementById('blocklyDiv');
    var transfers = [];

    function initBlocks() {
        /**** BKC DEVICES ***************/
        //MOTION_DETECTOR
        Blockly.Blocks['MOTION_DETECTOR'] = {
            init: function () {
                this.jsonInit({
                    "message0": '%3 BKC Motion Detector %1 is %2',
                    "args0": [
                        {
                            "type": "field_variable",
                            "name": "DEVICE",
                            "variable": "Motion1",
                            "defaultType": "MOTION_DETECTOR",
                            "variableTypes": ["MOTION_DETECTOR"]
                        },
                        {
                            "type": "field_dropdown",
                            "name": "STATE",
                            "check": "String",
                            "options": [
                                ["Detected", "Detected"],
                                ["not Detected", "NoOne"],
                            ]
                        },
                        {
                            "type": "field_image",
                            "src": "../../../../share/images/devices/motion-detector.svg",
                            "width": 20,
                            "height": 20,
                            "alt": "MD"
                        }
                    ],
                    /*"message1": '%1',
                    "args1": [
                        {
                            "type": "field_checkbox",
                            "name": "INVOKER",
                            "checked": false
                        }
                    ],*/
                    "output": "Boolean",
                    "colour": "#d46668",
//                "nextStatement": "Action",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['MOTION_DETECTOR'] = function (block) {
            // String or array length.
            var device = Blockly.JavaScript.variableDB_.getName(block.getFieldValue('DEVICE'), Blockly.Variables.NAME_TYPE);
            var state = block.getFieldValue('STATE');
            var code = '(' + device + '.PAYLOAD.state === \'' + state + '\')';
            return [code, Blockly.JavaScript.ORDER_MEMBER];
        };

        //DOOR_SENSOR
        Blockly.Blocks['DOOR_SENSOR'] = {
            init: function () {
                this.jsonInit({
                    "message0": '%3 BKC Door Sensor %1 \n is %2',
                    "args0": [
                        {
                            "type": "field_variable",
                            "name": "DEVICE",
                            "variable": "Door1",
                            "defaultType": "DOOR_SENSOR",
                            "variableTypes": ["DOOR_SENSOR"]
                        },
                        {
                            "type": "field_dropdown",
                            "name": "STATE",
                            "check": "String",
                            "options": [
                                ["Open", "OPEN"],
                                ["Closed", "CLOSED"],
                            ]
                        },
                        {
                            "type": "field_image",
                            "src": "../../../../share/images/devices/door-sensor.svg",
                            "width": 20,
                            "height": 20,
                            "alt": "MD"
                        }

                    ],
                    "output": "Boolean",
                    "colour": "#d46668",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['DOOR_SENSOR'] = function (block) {
            // String or array length.
            var device = Blockly.JavaScript.variableDB_.getName(block.getFieldValue('DEVICE'), Blockly.Variables.NAME_TYPE);
            var state = block.getFieldValue('STATE');
            var code = '(' + device + '.PAYLOAD.state === \'' + state + '\')';
            return [code, Blockly.JavaScript.ORDER_MEMBER];
        };

        //SMART_BUTTON
        Blockly.Blocks['SMART_BUTTON'] = {
            init: function () {
                this.jsonInit({
                    "message0": '%2 BKC Smart Button %1  %3',
                    "args0": [
                        {
                            "type": "field_variable",
                            "name": "DEVICE",
                            "variable": "Button1",
                            "defaultType": "SMART_BUTTON",
                            "variableTypes": ["SMART_BUTTON"]
                        },
                        {
                            "type": "field_image",
                            "src": "../../../../share/images/devices/ia-shortcut.svg",
                            "width": 20,
                            "height": 20,
                            "alt": "DS"
                        },
                        {
                            "type": "field_dropdown",
                            "name": "STATE",
                            "check": "String",
                            "options": [
                                ["Pressed", "pressed"],
                                ["Double Pressed", "double"],
                                ["Holded", "hold"],
                            ]
                        }
                    ],
                    "output": "Boolean",
                    "colour": "#d46668",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['SMART_BUTTON'] = function (block) {
            // String or array length.
            var device = Blockly.JavaScript.variableDB_.getName(block.getFieldValue('DEVICE'), Blockly.Variables.NAME_TYPE);
            var state = block.getFieldValue('STATE');
            var code = '(' + device + '.PAYLOAD.state === \'' + state + '\')';
            return [code, Blockly.JavaScript.ORDER_MEMBER];
        };

        //TEMP_HUM
        Blockly.Blocks['TEMP_HUM'] = {
            init: function () {
                this.jsonInit({
                    "message0": '%3 BKC Thermo Hygrometer %1 \n last %2',
                    "args0": [
                        {
                            "type": "field_variable",
                            "name": "DEVICE",
                            "variable": "Thermo_Hygrometer1",
                            "defaultType": "TEMP_HUM",
                            "variableTypes": ["TEMP_HUM"]
                        },
                        {
                            "type": "field_dropdown",
                            "name": "OUTPUT",
                            "check": "String",
                            "options": [
                                ["Temperature", "TEMP"],
                                ["Humidity", "HUM"],
                            ]
                        },
                        {
                            "type": "field_image",
                            "src": "../../../../share/images/devices/temp_hum.svg",
                            "width": 20,
                            "height": 20,
                            "alt": "MD"
                        }

                    ],
                    "output": "Number",
                    "colour": "#d45686",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['TEMP_HUM'] = function (block) {
            // String or array length.
            var device = Blockly.JavaScript.variableDB_.getName(block.getFieldValue('DEVICE'), Blockly.Variables.NAME_TYPE);
            var output = block.getFieldValue('OUTPUT');
            var code = '';
            if(output==='TEMP')
                code =  device + '.PAYLOAD.temperature';
            if(output==='HUM')
                code =  device + '.PAYLOAD.humidity';
            return [code, Blockly.JavaScript.ORDER_MEMBER];
        };


        /*

            //IA_SHORTCUT
            Blockly.Blocks['IA_SHORTCUT'] = {
                init: function() {
                    this.jsonInit({
                        "message0": '%2 BKC ShortCut %1  %3',
                        "args0": [
                            {
                                "type": "field_variable",
                                "name": "DEVICE",
                                "variable": "Shortcut1",
                                "defaultType":"IA_SHORTCUT",
                                "variableTypes": ["IA_SHORTCUT"]
                            },
                            {
                                "type": "field_image",
                                "src": "../../../../share/images/devices/ia-shortcut.svg",
                                "width": 20,
                                "height": 20,
                                "alt": "DS"
                            },
                            {
                                "type": "field_dropdown",
                                "name": "STATE",
                                "check": "String",
                                "options": [
                                    ["Pressed", "pressed"],
                                    ["Double Pressed", "double"],
                                    ["Holded", "hold"],
                                ]
                            }
                        ],
                        "output": "Boolean",
                        "colour": "#d46668",
        //                "tooltip": "Returns number of letters in the provided text.",
        //                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                    });
                }
            };

            Blockly.JavaScript['IA_SHORTCUT'] = function(block) {
                // String or array length.
                var device = Blockly.JavaScript.variableDB_.getName(block.getFieldValue('DEVICE'), Blockly.Variables.NAME_TYPE);
                var state = block.getFieldValue('STATE');
                var code = '('+device +'.PAYLOAD.state === \''+ state+'\')';
                return [code, Blockly.JavaScript.ORDER_MEMBER];
            };

        */


        //LIGHT_SWITCH
        Blockly.Blocks['LIGHT_SWITCH'] = {
            init: function () {
                this.jsonInit({
                    "message0": '%3 BKC Light Switch %1 %2',
                    "args0": [
                        {
                            "type": "field_variable",
                            "name": "DEVICE",
                            "variable": "Light1",
                            "defaultType": "LIGHT_SWITCH",
                            "variableTypes": ["LIGHT_SWITCH"]
                        },
                        {
                            "type": "field_dropdown",
                            "name": "COMMAND",
                            "check": "String",
                            "options": [
                                ["Turns On", "TURN_ON"],
                                ["Turns Off", "TURN_OFF"],
                            ]
                        },
                        {
                            "type": "field_image",
                            "src": "../../../../share/images/devices/light-switch.svg",
                            "width": 20,
                            "height": 20,
                            "alt": "DS"
                        }
                    ],
//                "output": "Boolean",
                    "colour": "#d45686",
                    "previousStatement": "Action",
                    "nextStatement": "Action",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['LIGHT_SWITCH'] = function (block) {
            // String or array length.
            /*var argument0 = Blockly.JavaScript.valueToCode(block, 'VALUE2',
                    Blockly.JavaScript.ORDER_FUNCTION_CALL) || '\'\'';*/
            var device = Blockly.JavaScript.variableDB_.getName(block.getFieldValue('DEVICE'), Blockly.Variables.NAME_TYPE);
            var command = block.getFieldValue('COMMAND');
            var code = device + '.SEND_COMMAND(\'' + command + '\');';
            return code;
        };

        //POWER_PLUG
        Blockly.Blocks['POWER_PLUG'] = {
            init: function () {
                this.jsonInit({
                    "message0": '%3 BKC Smart Plug %1 %2',
                    "args0": [
                        {
                            "type": "field_variable",
                            "name": "DEVICE",
                            "variable": "Power1",
                            "defaultType": "POWER_PLUG",
                            "variableTypes": ["POWER_PLUG"]
                        },
                        {
                            "type": "field_dropdown",
                            "name": "COMMAND",
                            "check": "String",
                            "options": [
                                ["Turns On", "TURN_ON"],
                                ["Turns Off", "TURN_OFF"],
                            ]
                        },
                        {
                            "type": "field_image",
                            "src": "../../../../share/images/devices/power-plug.svg",
                            "width": 20,
                            "height": 20,
                            "alt": "DS"
                        }
                    ],
//                "output": "Boolean",
                    "colour": "#d45686",
                    "previousStatement": "Action",
                    "nextStatement": "Boolean",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['POWER_PLUG'] = function (block) {
            // String or array length.
            /*var argument0 = Blockly.JavaScript.valueToCode(block, 'VALUE2',
             Blockly.JavaScript.ORDER_FUNCTION_CALL) || '\'\'';*/
            var device = Blockly.JavaScript.variableDB_.getName(block.getFieldValue('DEVICE'), Blockly.Variables.NAME_TYPE);
            var command = block.getFieldValue('COMMAND');
            var code = device + '.SEND_COMMAND(\'' + command + '\');';
            return code;
        };

        //POWER_PLUG_STATE
        Blockly.Blocks['POWER_PLUG_STATE'] = {
            init: function () {
                this.jsonInit({
                    "message0": '%3 BKC Smart Plug %1 \n is %2',
                    "args0": [
                        {
                            "type": "field_variable",
                            "name": "DEVICE",
                            "variable": "Power1",
                            "defaultType": "POWER_PLUG",
                            "variableTypes": ["POWER_PLUG"]
                        },
                        {
                            "type": "field_dropdown",
                            "name": "STATE",
                            "check": "String",
                            "options": [
                                ["On", "ON"],
                                ["Off", "OFF"],
                                ["Over Current", "OVER_CURRENT"],
                                ["Over Voltage", "OVER_VOLTAGE"],
                                ["Under Voltage", "UNDER_VOLTAGE"],
                            ]
                        },
                        {
                            "type": "field_image",
                            "src": "../../../../share/images/devices/power-plug.svg",
                            "width": 20,
                            "height": 20,
                            "alt": "MD"
                        }

                    ],
                    "output": "Boolean",
                    "colour": "#d45686",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['POWER_PLUG_STATE'] = function (block) {
            // String or array length.
            var device = Blockly.JavaScript.variableDB_.getName(block.getFieldValue('DEVICE'), Blockly.Variables.NAME_TYPE);
            var state = block.getFieldValue('STATE');
            var code = '(' + device + '.PAYLOAD.state === \'' + state + '\' )';
            return [code, Blockly.JavaScript.ORDER_MEMBER];
        };


        //SMART_SPEAKER
        /* Blockly.Blocks['SMART_SPEAKER'] = {
             init: function() {
                 this.jsonInit({
                     "message0": '%3 BKC Speaker %1 %2',
                     "args0": [
                         {
                             "type": "field_variable",
                             "name": "DEVICE",
                             "variable": "Speaker1",
                             "defaultType":"SMART_SPEAKER",
                             "variableTypes": ["SMART_SPEAKER"]
                         },
                         {
                             "type": "field_dropdown",
                             "name": "COMMAND",
                             "check": "String",
                             "options": [
     //                            ["Mute", "SILENT"],
     //                            ["Unmute", "NO-SILENT"],
     //                            ["Set volume", "VOLUME_TO"],
     //                            ["Turn up", "VOLUME_UP"],
     //                            ["Turn down", "VOLUME_DOWN"],
     //                            ["Turn off", "TURN_OFF"],
     //                            ["Turn on", "TURN_ON"],
     //                            ["Pause", "PAUSE"],
                                 ["Play", "PLAY"],
                                 ["Pause", "PAUSE"],
                             ]
                         },
                         {
                             "type": "field_image",
                             "src": "../../../../share/images/devices/ia-speaker.svg",
                             "width": 20,
                             "height": 20,
                             "alt": "DS"
                         }
                     ],
                     "message1": 'play file/url %1 by volume %2',
                     "args1": [
                         {
                             "type": "field_input",
                             "name": "FILE",
                             "src": "../../../../share/images/devices/ia-speaker.svg",
                             "width": 50,
                             "height": 50,
                             "alt": "File to play",
                             "onClick": "onn"
                         },
                         {
                             "type": "field_dropdown",
                             "name": "VOLUME",
                             "check": "String",
                             "options": [
                                 ["100%", "100"],
                                 ["90%", "90"],
                                 ["80%", "80"],
                                 ["70%", "70"],
                                 ["60%", "60"],
                                 ["50%", "50"],
                                 ["40%", "40"],
                                 ["30%", "30"],
                                 ["20%", "20"],
                                 ["10%", "10"],
                             ]
                         }
                     ],
     //                "output": "Boolean",
                     "colour": "#d45686",
                     "previousStatement": "Action",
                     "nextStatement": "Action",
     //                "tooltip": "Returns number of letters in the provided text.",
     //                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                 });
             }
         };*/

        Blockly.Blocks['SMART_SPEAKER'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField(new Blockly.FieldImage("../../../../share/images/devices/ia-speaker.svg", 20, 20, "DS"))
                    .appendField('BKC Speaker')
                    .appendField(new Blockly.FieldVariable(
                        'Speaker1',
                        null,
                        ['SMART_SPEAKER'],
                        'SMART_SPEAKER'
                    ), 'DEVICE')
                    .appendField(new Blockly.FieldDropdown([
                        ["Play", "PLAY"],
                        ["Pause", "PAUSE"]
                    ]), 'COMMAND')
                    .appendField(new Blockly.FieldLabelSerializable("audio file"), "AUDIOFILE")
                    .appendField(new Blockly.FieldLabelSerializable("audio file"), "AUDIOFILETITLE")
                    .appendField(new Blockly.FieldImage("../../../../share/images/playlist-dialog.svg", 20, 20, "*", onSelectAudio), "FILEBTN")
                    .appendField(new Blockly.FieldDropdown([
                        ["Device Volume", "CURRENT"],
                        ["100%", "100"],
                        ["90%", "90"],
                        ["80%", "80"],
                        ["70%", "70"],
                        ["60%", "60"],
                        ["50%", "50"],
                        ["40%", "40"],
                        ["30%", "30"],
                        ["20%", "20"],
                        ["10%", "10"],
                    ]), 'VOLUME')
                ;
                this.getField('AUDIOFILE').setVisible(false);
                this.setColour("#d45686");
                this.setTooltip("");
                this.setHelpUrl("");
                this.setPreviousStatement("Action");
                this.setNextStatement("Action");
            },
            onchange: function (ev) {
                if (this.getFieldValue('COMMAND') === 'PAUSE') {
//                this.getField('AUDIOFILETITLE').setVisible(false);
                    this.getField('AUDIOFILETITLE').setValue('');
                    this.getField('FILEBTN').setVisible(false);
                    this.getField('VOLUME').setVisible(false);
                } else if (this.getFieldValue('COMMAND') === 'PLAY') {
                    this.getField('FILEBTN').setVisible(true);
                    this.getField('VOLUME').setVisible(true);
//                this.getField('AUDIOFILETITLE').setVisible(true);
//                console.warn(this.getFieldValue('AUDIOFILE'))
                    try {
                        if (this.getFieldValue('AUDIOFILE').toString() !== '')
                            this.getField('AUDIOFILETITLE').setValue(JSON.parse(this.getFieldValue('AUDIOFILE').toString())['file-name']);
                    } catch (e) {

                    }
                }
            }
        };

        Blockly.JavaScript['SMART_SPEAKER'] = function (block) {
            // String or array length.
            /*var argument0 = Blockly.JavaScript.valueToCode(block, 'VALUE2',
             Blockly.JavaScript.ORDER_FUNCTION_CALL) || '\'\'';*/
            var device = Blockly.JavaScript.variableDB_.getName(block.getFieldValue('DEVICE'), Blockly.Variables.NAME_TYPE);
            var command = block.getFieldValue('COMMAND');
            var file = block.getFieldValue('AUDIOFILE');
            var code = device + '.SEND_COMMAND(\'' + command + '\');';
            if (file !== '') {
                try {
                    var options = JSON.parse(file);
                    if (options.command)
                        options.command = JSON.parse(options.command);
                    options['file-name'] = 'service:/' + newservice.Name;
                    var volume = block.getFieldValue('VOLUME');
                    if (volume !== 'CURRENT') {
                        options.volume = volume;
                    }

                    code = device + '.SEND_COMMAND(\'' + command + '\', ' + JSON.stringify(options) + ');';

                } catch (e) {
                    console.error('SMART_SPEAKER service', e);
                }
            }
            return code;
        };

        //SMART_SPEAKER_STATE
        Blockly.Blocks['SMART_SPEAKER_STATE'] = {
            init: function () {
                this.jsonInit({
                    "message0": '%3 BKC Speaker %1 \n is %2',
                    "args0": [
                        {
                            "type": "field_variable",
                            "name": "DEVICE",
                            "variable": "Speaker1",
                            "defaultType": "SMART_SPEAKER",
                            "variableTypes": ["SMART_SPEAKER"]
                        },
                        {
                            "type": "field_dropdown",
                            "name": "STATE",
                            "check": "String",
                            "options": [
                                ["Playing", "PLAYING"],
                                ["Paused", "PAUSED"],
                                ["Idle", "IDLE"],
                                ["Error", "ERROR"],
                            ]
                        },
                        {
                            "type": "field_image",
                            "src": "../../../../share/images/devices/ia-speaker.svg",
                            "width": 20,
                            "height": 20,
                            "alt": "MD"
                        }

                    ],
                    "output": "Boolean",
                    "colour": "#d45686",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['SMART_SPEAKER_STATE'] = function (block) {
            // String or array length.
            var device = Blockly.JavaScript.variableDB_.getName(block.getFieldValue('DEVICE'), Blockly.Variables.NAME_TYPE);
            var state = block.getFieldValue('STATE');
            var code = '(' + device + '.PAYLOAD.state === \'' + state + '\' )';
            return [code, Blockly.JavaScript.ORDER_MEMBER];
        };

        /***** BKC UTILS *********/
        //Current_Time
        Blockly.Blocks['Current_Time'] = {
            init: function () {
                this.jsonInit({
                    "message0": 'Home Current Time ',
                    "output": "String",
                    "colour": 240,
//                "previousStatement": "Action",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['Current_Time'] = function (block) {
            return ['Home.GetCurrentTime()', Blockly.JavaScript.ORDER_MEMBER];
        };

        //Home_Guard
        Blockly.Blocks['Home_Guard'] = {
            "style": {
                "hat": "cap"
            },
            init: function () {
                this.jsonInit({
                    "message0": '%1 Home is in Guard ',
                    "args0": [
                        {
                            "type": "field_image",
                            "src": "../../../../share/images/devices/guard.svg",
                            "width": 20,
                            "height": 20,
                            "alt": "GR"
                        }

                    ],
                    "output": "Boolean",
                    "colour": '#ffb03e',

//                "previousStatement": "Action",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['Home_Guard'] = function (block) {
            return ['Home.Guard', Blockly.JavaScript.ORDER_MEMBER];
        };

        //Service_Button
        Blockly.Blocks['Service_Button'] = {
            init: function () {
                this.jsonInit({
                    "message0": '%1 Service Button %2',
                    "args0": [
                        {
                            "type": "field_image",
                            "src": "../../../../share/images/devices/service-button.svg",
                            /*"width": 55,
                            "height": 45,*/
                            "width": 20,
                            "height": 20,
                            "alt": "Button"
                        },
                        {
                            "type": "field_input",
                            "name": "TITLE"
                        }
                    ],
//                "output": "Boolean",
                    "colour": '#ffb03e',
                    "nextStatement": "Function"
//                "previousStatement": "Action",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['Service_Button'] = function (block) {
//        var code = Blockly.JavaScript.statementToCode(block, 'nextStatement');
//        return [code, Blockly.JavaScript.ORDER_ADDITION];
            var title = block.getFieldValue('TITLE');
            return "//when click Service_Button " + title + " do ";
        };

        //IA_Cron
        Blockly.Blocks['IA_Cron'] = {
            init: function () {
                this.jsonInit({
                    "message0": '%1 On Scheduled Time run cron()',
                    "args0": [
                        {
                            "type": "field_image",
                            "src": "../../../../share/images/devices/ia-schedule.svg",
                            "width": 20,
                            "height": 20,
                            "alt": "GR"
                        }
                    ],
//                "output": "Boolean",
                    "colour": '#ffb03e',
//                "nextStatement": "Function"
//                "previousStatement": "Action",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['IA_Cron'] = function (block) {
//        var code = Blockly.JavaScript.statementToCode(block, 'nextStatement');
//        return [code, Blockly.JavaScript.ORDER_ADDITION];
            var title = block.getFieldValue('TITLE');
            return "//when service invoked at schedule time method \"cron()\" is called ";
        };

        //IAMessage.sendEmail
        Blockly.Blocks['IAMessage_sendEmail'] = {
            init: function () {
                this.jsonInit({
                    "message0": '%3 Send email by subject: %1 and text: %2',
                    "args0": [
                        {
                            "type": "field_input",
                            "name": "SUBJECT"
                        },
                        {
                            "type": "field_input",
                            "name": "TEXT"
                        },
                        {
                            "type": "field_image",
                            "src": "../../../../share/images/devices/Blockly_send_email.svg",
                            "width": 20,
                            "height": 20,
                            "alt": "Email"
                        }
                    ],
                    "inputsInline": true,
//                "output": "String",
                    "colour": '#64a0d4',
                    "previousStatement": "Action",
                    "nextStatement": "Action",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['IAMessage_sendEmail'] = function (block) {
            var subject = block.getFieldValue('SUBJECT');
            var text = block.getFieldValue('TEXT');
            var z = {subject: subject, text: text};
            z = JSON.stringify(z);
            return 'IAMessage.sendMail(' + z + ');';
        };

        //IAMessage.sendSMS
        Blockly.Blocks['IAMessage_sendSMS'] = {
            init: function () {
                this.jsonInit({
                    "message0": '%2 Send SMS with text: %1',
                    "args0": [
                        {
                            "type": "field_input",
                            "name": "TEXT"
                        },
                        {
                            "type": "field_image",
                            "src": "../../../../share/images/devices/Blockly_send_sms.svg",
                            "width": 20,
                            "height": 20,
                            "alt": "Email"
                        }
                    ],
//                "output": "String",
                    "colour": '#64a0d4',
                    "previousStatement": "Action",
                    "nextStatement": "Action",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['IAMessage_sendSMS'] = function (block) {
            var text = block.getFieldValue('TEXT');
            var z = {message: text};
            z = JSON.stringify(z);
            return 'IAMessage.sendSMS(' + z + ');';
        };

        //IAMessage.pushNotification
        Blockly.Blocks['IAMessage_pushNotification'] = {
            init: function () {
                this.jsonInit({
                    "message0": '%2 Push notification by message: %1',
                    "args0": [
                        {
                            "type": "field_input",
                            "name": "MESSAGE"
                        },
                        {
                            "type": "field_image",
                            "src": "../../../../share/images/devices/Blockly_notification.svg",
                            "width": 20,
                            "height": 20,
                            "alt": "Push"
                        }
                    ],
//                "output": "String",
                    "colour": '#64a0d4',
                    "previousStatement": "Action",
                    "nextStatement": "Action",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['IAMessage_pushNotification'] = function (block) {
            var message = block.getFieldValue('MESSAGE');
            var z = {message: message};
            z = JSON.stringify(z);
            return 'IAMessage.pushNotification(' + z + ');';
        };

        /******** Service Contract *******/
        //BKC_TRANSFER
        Blockly.Blocks['BKC_TRANSFER'] = {
            init: function () {
                this.jsonInit({
                    "message0": '%1 BKC Transfer',
                    "args0": [
                        {
                            "type": "field_image",
                            "src": "../../../../share/images/Logo_BKC_polygon2.svg",
                            "width": 20,
                            "height": 20,
                            "alt": "Service Contract"
                        }
                    ],
                    //todo now transfer just is from installer of service
                    "message1": 'Send tokens from INSTALLER OF SERVICE to owner of %1',
                    "args1": [
                        /*{
                            "type": "field_variable",
                            "name": "DEVICE1",
                            "variable": "Installer of service",
                            "enabled": false,
                            // "defaultType":"POWER_PLUG",
                            // "variableTypes": ["LIGHT_SWITCH","MOTION_DETECTOR","DOOR_SENSOR","SMART_BUTTON","POWER_PLUG","SMART_SPEAKER","POWER_PLUG_STATE","SMART_SPEAKER_STATE"]
                        },*/
                        {
                            "type": "field_variable",
                            "name": "DEVICE2",
                            "variable": "Choose",
                            // "defaultType":"POWER_PLUG",
                            // "variableTypes": ["LIGHT_SWITCH","MOTION_DETECTOR","DOOR_SENSOR","SMART_BUTTON","POWER_PLUG","SMART_SPEAKER","POWER_PLUG_STATE","SMART_SPEAKER_STATE"]
                        }
                    ],
//                "output": "Boolean",
                    "colour": "#373737",
                    "previousStatement": "Action",
                    "nextStatement": "Action",
//                "tooltip": "Returns number of letters in the provided text.",
//                "helpUrl": "http://www.w3schools.com/jsref/jsref_length_string.asp"
                });
            }
        };

        Blockly.JavaScript['BKC_TRANSFER'] = function (block) {
            // String or array length.
            /*var argument0 = Blockly.JavaScript.valueToCode(block, 'VALUE2',
                    Blockly.JavaScript.ORDER_FUNCTION_CALL) || '\'\'';*/
            //todo already just could transfer from installer of service
            // var device1 = Blockly.JavaScript.variableDB_.getName(block.getFieldValue('DEVICE1'), Blockly.Variables.NAME_TYPE);
            var device2 = Blockly.JavaScript.variableDB_.getName(block.getFieldValue('DEVICE2'), Blockly.Variables.NAME_TYPE);
            //add this device to transfer targets
            transfers.push(device2);

            var code = '\r  Service_Contract.transfer(null , \'' + device2 + '\' );\r';
            return code;
        };

    }


    //theme
    /*let blockStyles = {
        "list_blocks": {
            "colourPrimary": "#4a148c",
            "colourSecondary":"#AD7BE9",
            "colourTertiary":"#CDB6E9"
        },
        "logic_blocks": {
            "colourPrimary": "#01579b",
            "colourSecondary":"#64C7FF",
            "colourTertiary":"#C5EAFF"
        }
    };

    let categoryStyles = {
        "list_category": {
            "colours": "#4a148c"
        },
        "logic_category": {
            "colour": "#01579b",
        }
    };*/


    var demoWorkspace = Blockly.inject(blocklyDiv,
        {
            media: '../../media/',
            toolbox: document.getElementById('toolbox'),
            grid:
                {spacing: 20,
                    length: 3,
                    colour: '#ccc',
                    snap: true},
            toolboxPosition: "start",
            trashcan: true,
//            theme: Blockly.Theme(blockStyles, categoryStyles)
        });

    initBlocks();

    var onresize = function (e) {
        // Compute the absolute coordinates and dimensions of blocklyArea.
        var element = blocklyArea;
        var x = 0;
        var y = 0;
        do {
            x += element.offsetLeft;
            y += element.offsetTop;
            element = element.offsetParent;
        } while (element);
        // Position blocklyDiv over blocklyArea.
        blocklyDiv.style.left = x + 'px';
        blocklyDiv.style.top = y + 'px';
        blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
        blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
        Blockly.svgResize(demoWorkspace);
    };

    function createvar() {
        Blockly.Variables.createVariable(demoWorkspace, 'sssss', 'panda');
//        demoWorkspace.createVariable(----------------)
    }

    function genCode() {
        // Generate JavaScript code and display it.
        Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
        var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
        return code;
    }

    function runCode() {
        // Generate JavaScript code and run it.
        window.LoopTrap = 1000;
        Blockly.JavaScript.INFINITE_LOOP_TRAP =
            'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
        var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
        Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
        try {
            eval(code);
        } catch (e) {
            alert(e);
        }
    }

    function getWorkspaceXml() {
        var xml = Blockly.Xml.workspaceToDom(demoWorkspace);
        var xml_text = Blockly.Xml.domToText(xml);
        return xml_text;
    }

    function restoreWorkspace(xml_text) {
        try {
            if(xml_text) {
                var xml = Blockly.Xml.textToDom(xml_text);
                Blockly.Xml.domToWorkspace(xml, demoWorkspace);
            }
        }catch (e){
            console.error(e);
        }
    }

    ///resize
    window.addEventListener('resize', onresize, false);
    onresize();
    Blockly.svgResize(demoWorkspace);

    //onchange
    function workspaceChange(event) {
        var code = genCode();
        var codes = code.split('\n');
        if(codes[0].startsWith('var')){
            codes[0] = "";
        }
        code = codes.join('\n');
        editor_.setValue(code);
        newservice.Code = code;



        /*if (event.type == Blockly.Events.CHANGE &&
            event.element == 'comment' &&
            !event.oldValue && event.newValue) {
            alert('Congratulations on creating your first comment!')
            workspace.removeChangeListener(onFirstComment);
        }*/
    }

    var newservice = {};
    function initPage() {
        console.log('inintpage======================')
        newservice = {
            Devices: [],
            Vars: [],
            Buttons: [],
            Price: {Add:0, Run:0}
        };

        if (typeof oldservice !== 'undefined') {
            Object.assign(newservice, oldservice)
        }
        if (!newservice.Devices) newservice.Devices = [];
        if (!newservice.Vars) newservice.Vars = [];
        if (!newservice.Buttons) newservice.Buttons = [];
        srviconbase64 = newservice.Icon || '';

        //change title of page in container
        window.parent.document.getElementById('rapidservicetitle').innerHTML = newservice.Name + " (Visual Console)";

        ssbindRender();

        restoreWorkspace(newservice.BlocklyXML);

        /*$("#addDevice").click(() => {
            let name = $('#newdevicename').val().trim();
            if (name === '') {
                window.parent.swal.fire({
                    title: 'New Device Binder',
                    text: 'Please set a name for new device binder!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            if (newservice.Devices.some(v => v.Name === name) || newservice.Vars.some(v => v.Name === name)) {
                window.parent.swal.fire({
                    title: 'New Device Binder',
                    text: 'New device binder is duplicated!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            newservice.Devices.push({
                'Name': name,
                'DeviceType': $('#newdevicetype').val(),
                Invoker: document.querySelector('#newdeviceinvoker').checked
            });
            $('#newdevicename').val('');
            document.querySelector('#newdeviceinvoker').checked = false;
            ssbindRenderLevel('srvdevices1');
        });

        $("#addVar").click(() => {
            let name = $('#newvarname').val().trim();
            if (name === '') {
                window.parent.swal.fire({
                    title: 'New Variable',
                    text: 'Please set a name for new variable!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            if (newservice.Devices.some(v => v.Name === name) || newservice.Vars.some(v => v.Name === name)) {
                window.parent.swal.fire({
                    title: 'New Variable',
                    text: 'New variable name is duplicated!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            newservice.Vars.push({'Name': name, 'Type': $('#newvartype').val()});
            $('#newvarname').val('');
            ssbindRenderLevel('srvvars');
        });

        $("#addButton").click(() => {
            let title = $('#newbuttontitle').val().trim();
            let funx = $('#newbuttonfunction').val().trim();
            /!*if(name==='') {
             window.parent.swal.fire({
             title: 'New Variable',
             text: 'Please set a name for new variable!',
             //html: true,
             //                    timer: 2000,
             icon: "warning",
             showConfirmButton: true
             });
             return;
             }*!/
            if (title === '') {
                window.parent.swal.fire({
                    title: 'New Button',
                    text: 'Please set a title for new Button!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            if (funx === '') {
                window.parent.swal.fire({
                    title: 'New Button',
                    text: 'Please set a function name for new Button!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            if (newservice.Buttons.some(v => v.Title === title)) {
                window.parent.swal.fire({
                    title: 'New Tap command',
                    text: 'New Tap title is duplicated',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            if (newservice.Buttons.some(v => v.Function === funx)) {
                window.parent.swal.fire({
                    title: 'New Tap command',
                    text: 'New Tap function name is duplicated',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            newservice.Buttons.push({'Title': title, 'Function': $('#newbuttonfunction').val()});
            $('#newbuttontitle').val('');
            $('#newbuttonfunction').val('');
            ssbindRenderLevel('srvbuttons');
        });*/

        ssbindRenderLevel('srvbuttons');
        ssbindRenderLevel('srvpublishes');
        ssbindRenderLevel('srvaccess');
        ssbindRenderLevel('oldserv');
        ssbindRenderLevel('srvdevices1');
        ssbindRenderLevel('releases');


        //drop-area
        var dropArea = document.getElementById('drop-area')

        dropArea.addEventListener('dragenter', handleFileSelectRapid, false)
        dropArea.addEventListener('dragleave', handleFileSelectRapid, false)
        dropArea.addEventListener('dragover', handleFileSelectRapid, false)
        dropArea.addEventListener('drop', handleFileSelectRapid, false)

        initEditor();
        demoWorkspace.addChangeListener(workspaceChange);

        /*if(newservice._Installed) {
            window.parent.swal.fire({
                title: 'Warning',
                text: 'This service has already been installed '+newservice._Installed+' time' + (newservice._Installed>1 ? 's':'') + ', If you change this service just those installations with version 0 will be affected (which you have installed for yourself via "Install for Me")' ,
                //html: true,
                //                    timer: 2000,
                //icon: "warning",
                imageUrl: "images/error.png",
                imageWidth: 50,
                showConfirmButton: true
            });
        }*/

    }

    if (window.File && window.FileReader && window.FileList && window.Blob) {
        document.getElementById('srviconfile').addEventListener('change', handleFileSelectRapid, false);
    } else {
//        alert('The File APIs are not fully supported in this browser.');
        window.parent.swal.fire({
            title: 'Warning',
            text: 'The File APIs are not fully supported in this browser.',
            //html: true,
            //                    timer: 2000,
            //icon: "warning",
            imageUrl: "images/error.png",
            imageWidth: 50,
            showConfirmButton: true
        });
    }

    function onSelectAudio() {
        var thess = this;
        window.parent.showAudioDialog(function (file) {
            thess.getSourceBlock().setFieldValue(JSON.stringify(file),'AUDIOFILE');
            thess.getSourceBlock().setFieldValue(file['file-name'],'AUDIOFILETITLE');
        });
    }

    // Blockly.JavaScript.variableDB_.setVariableMap(demoWorkspace.getVariableMap());

</script>

</body>
</html>
