<!--uses ssbind and sspage tags-->
<style>
    .card .header .header-dropdown {
        position: absolute;
        top: 5px;
        right: 10px;
        list-style: none;
    }

    .device .data {
        font-size: 2pc;
        font-weight: bold;
        margin: 1pc 0 1pc 0
    }

    .device > .body {
        height: 170px;
    }

    .device > .footer {
        height: 65px;
        padding: 0 10px 10px;
    }

    .device div.commands {
        margin: 1pc 0 1pc 0;
    }

    .log {
        overflow-wrap: break-word;
        font-size: small;
        background-color: #a2a1a17d;
        padding: .5pc;
        margin-top: .5pc;
        border-radius: .3pc;
    }

    /*span.online, span.offline {
        display: inline-block;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        !*box-shadow: 1px 1px 2px 0px rgba(94, 92, 96, 0.77);*!
    }*/

    span.onoffline.online {
        background-color: limegreen !important;
    }

    span.onoffline {
        display: inline-block;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        float: right;
    }

    span.onoffline.SENSOR {
        background-color: transparent;
    }

    span.onoffline.ACTUATOR {
        background-color: red;
    }

    div.devicelist {
        /*background-image: url("images/illustration_device.svg");*/
        /*background-repeat: no-repeat;*/
        /*background-size: 50%;*/
        /*background-position: center;*/
        /*height: 100vh;*/

    }

    div.devicelist > div {
        /*min-width: 280px;*/
        height: 18pc;
    }

    /*span.offline:after {
        content: "Offline";
        display: inline-block;
        position: relative;
        left: 20px;
        top: -3px;
        color: red;
    }*/

    .commands.offline {
        pointer-events: none;
        opacity: .35;
    }

    ul.devices {
        position: absolute;
    }

    .devices li {
        font-size: small;
        color: grey;
        white-space: nowrap;
    }

    .devices li b {
        font-size: smaller;
        color: black;
    }

    .device.onmessage {
        box-shadow: 0px 0px 18px 0px #2196f3;
    }

    div.devicedata {
        width: 200px;
        overflow: auto;
    }

    .device-share {
        position: absolute;
        right: 30px;
    }


</style>
<script>
    var home_audio_files = devices
</script>
<div class="">
    <section class="card"><!--centerpan col-lg-9 col-md-10 col-sm-10 col-xs-9-->
        <div class="header">
            <span class="ia-head">
                <span class="icon2 device-icon"></span>
                <span class="hidden-xs">My Home Devices</span>
                <span class="badge"
                      ssbind="text:(devices.length) +' Device' + (devices.length>1 ?'s':'')"></span>
                <span id="mqttconnectionicon" ssbind="text:mqttconnected ? '' : 'Connecting...'"></span>

            </span>
            <!--<span class=" btn btn-link m-t&#45;&#45;5" style="top: 20px"
                  sspage="../customer/views/iadevice.customer.register.new.view.html"
                  sspage-back="/customer/views/iadevice.customer.list.view.html"
                  sspage-load-after="ssbindRender();checkhashome()">
                    <span class="icon1  "></span>
                <b class="device-name hidden-xs ">-</b></span>-->
            <!--sspage="../customer/views/iadevice.customer.register.new.view.html"-->
            <span class="header-dropdown btn btn-link m-t--5 " style="top: 20px"
                  sspage="../customer/views/iadevice.customer.register.bytoken.view.html"
                  sspage-back="/customer/views/iadevice.customer.list.view.html"
                  sspage-load-after="ssbindRender();checkhashome()">
                    <span class="icon1 icon-newdevice "></span>
                    <b class="device-name hidden-xs ">Add Device</b>
            </span>
            <!--<span><a href="javascript:void(0);"
                    sspage="../customer/views/iadevice.customer.register.bytoken.view.html"
                   sspage-back="/customer/views/iadevice.customer.list.view.html"
                   sspage-load-after="ssbindRender();checkhashome()">Add Device with Token</a></span>-->
        </div>
        <div class="body row devicelist collapse">
            <div class="col-lg-3 col-md-3 col-sm-4 col-xs-12"
                 ssfor="devices" ssnextlevelxxx="datalevel"
                 ssemptylist='<center><button sspage="../customer/views/iadevice.customer.register.bytoken.view.html"
                  sspage-back="/customer/views/iadevice.customer.list.view.html"
                  sspage-load-after="ssbindRender();checkhashome()" class= "btn btn-primary-ia ia-bigger-title"><span class="icon2 icon-newdevice-white "></span> Add New Device</button><div class="col-grey m-t-5">Click here to install your first device</div><br> <img class=bgimg src=images/illustration_device.svg></center>'
                 Xsspage-load-jsonX="/iadevice/home/"
                 sspage-load-json-varX="devices"
                 sspage-load-afterX="ssbindRenderThis('devices');$('.devicelist').show();ssbindRenderLevel('commands', true)">

                <div class="device card" ssbind="topicbox:devices[ssIndex]._encid ; device:devices[ssIndex].DeviceType">
                    <!--<div ssbind1="class: (devices[ssIndex].IsActive ? 'body '+devicetemps[devices[ssIndex].DeviceType || 'UNKNOWN'].color : 'body bg-grey') + (devices[ssIndex]._online ? ' animatedborder online ':'')">-->
                    <div class="header icon text-left">
                        <div class="row">
                            <div class="col-sm-3 col-xs-3 icon">
                                <img ssbind="src:devicetemps[devices[ssIndex].DeviceType || 'UNKNOWN'].icon">
                            </div>
                            <div class="col-sm-9 p-l-0 m-t-5">
                                <span ssbind="class: (devices[ssIndex]._online ? 'onoffline online ' : 'onoffline offline ') + devicetemps[devices[ssIndex].DeviceType].type"></span>
                                <div class="m-t--15 mdi-24px m-r-10 col-blue device-share mdi mdi-eye-outline " ssif="(devices[ssIndex].Share && devices[ssIndex].Share.Tokens)"></div>
                                <div class="device-name ia-big-title text-ellipsis font-bold" ssbind="text:devices[ssIndex].Name"></div>
                                <div class="device-type" ssbind="text: devicetemps[devices[ssIndex].DeviceType].title || 'UNKNOWN DEVICE'"></div>
                            </div>
                        </div>
                    </div>
                    <div class="body"
                         ssbind1="class: 'info-box-2 hover-expand-effect ' + devicetemps[devices[ssIndex].DeviceType || 'UNKNOWN'].color">



                        <div class="icon">
                            <!--<i ssbind="class:devicetemps[devices[ssIndex].DeviceType || 'UNKNOWN'].icon"></i>-->



                        </div>



                        <!--state section-->
                        <div ssif="devicetemps[devices[ssIndex].DeviceType].type=='SENSOR' && !devicetemps[devices[ssIndex].DeviceType].controllers" class="text-center data"
                             data="state"
                             ssbind="text:getmyval(devices[ssIndex]._encid,'state')||'&nbsp;' ; data-value:getmyval(devices[ssIndex]._encid,'state')"></div>


                        <!--commands section-->
                        <div class="commands"
                             ssif="devicetemps[devices[ssIndex].DeviceType].commands && !devicetemps[devices[ssIndex].DeviceType].controllers"
                             ssbind="class: (devices[ssIndex]._online ? 'commands ' : 'commands offline ')">
                            <div class="text-center">
                                <!--button command-->
                                <button ssif="devicetemps[devices[ssIndex].DeviceType].commandsoptions && devicetemps[devices[ssIndex].DeviceType].commandsoptions.type=='button'"
                                        ssfor="devicetemps[devices[ssIndex].DeviceType].commands with ssIndex3"
                                        ssbind="text:devicetemps[devices[ssIndex].DeviceType].commands[ssIndex3].command"
                                        onclick="publishCommand( devices[ssIndex]._encid , devicetemps[devices[ssIndex].DeviceType].commands[ssIndex3].command, this)"
                                        sslevel="commands">-----
                                </button>
                                <!--end button command-->

                                <!--switch command-->
                                <div class="switch p-t-10"
                                     ssif="devicetemps[devices[ssIndex].DeviceType].commandsoptions && devicetemps[devices[ssIndex].DeviceType].commandsoptions.type=='switch'"
                                     data="state" data-update="setswitch(ssIndex, undefined, 'state', 'ON')">
                                    <label>
                                        <span class="hidden-xsXXXX"
                                              ssbind="html:(devicetemps[devices[ssIndex].DeviceType].commands)?devicetemps[devices[ssIndex].DeviceType].commands[0].title : ''"
                                              sslevel="commands">A1</span>
                                        <input type="checkbox"
                                               ssbind="checked:devicetemps[devices[ssIndex].DeviceType].commands && (getmyval(devices[ssIndex]._encid,'state')===devicetemps[devices[ssIndex].DeviceType].commands[1].state)"
                                               onchange="publishCommand( devices[ssIndex]._encid , this.checked ? devicetemps[devices[ssIndex].DeviceType].commands[1].command : devicetemps[devices[ssIndex].DeviceType].commands[0].command, this)"
                                               sslevel="commands">
                                        <span class="lever switch-col-green"></span>
                                        <span class="hidden-xsXXXX"
                                              ssbind="html:(devicetemps[devices[ssIndex].DeviceType].commands)?devicetemps[devices[ssIndex].DeviceType].commands[1].title : ''"
                                              sslevel="commands">B2</span>
                                    </label>
                                </div>
                                <!--end switch command-->

                                <!--voice command-->
                                <div class="voice text-nowrap"
                                     ssif="devicetemps[devices[ssIndex].DeviceType].commandsoptions && devicetemps[devices[ssIndex].DeviceType].commandsoptions.type=='voice'"
                                     ssbind="x:setvoicebutton(ssIndex)" data="state"
                                     data-update="setvoicebutton(ssIndex)">

                                    <!--<span data-toggle="modal" data-target="#AudioGalleryModal"
                                          class="speaker-file-name text-ellipsis m-b-10 btn-link col-red font-underline font-13"
                                          style="display: inline-block;width: 100%"
                                          data-file-name-selector=""
                                          ssbind="text:getmyval(devices[ssIndex]._encid,'file-name')||'choose a file to play';file-url:getmyval(devices[ssIndex]._encid,'file-url')||null;file-name:getmyval(devices[ssIndex]._encid,'file-name')||null;file-extension:getmyval(devices[ssIndex]._encid,'file-extension')||null;file-save:getmyval(devices[ssIndex]._encid,'file-save')||null">[current playing file-name]</span>

                                    <br>-->

                                    <!--repeat button-->
                                    <span class="btn btn-circle btn-link ia-repeat-btn mdi mdi-repeat-off font-16 col-grey m-b-5"
                                          onclick="setrepeat(ssIndex, true)" data="repeat" style="padding-top: 8px"
                                          data-update="setrepeat(ssIndex)" ssbind="x:setrepeat(ssIndex)">
                                    </span>

                                    <!--play button-->
                                    <span class="btn-circle ia-play-btn btn bg-red m-l-15 m-r-15 m-b-5" cmd="PLAY"
                                          onclick="voice_play( devices[ssIndex]._encid, this.getAttribute('cmd') , this)"
                                          ondblclickxx="publishCommand( devices[ssIndex]._encid, {'state':'PAUSED'} )">
                                        <!--TODO fix ondblclick dont send command with state-->
                                        <span class=" mdi mdi-18px mdi-play col-white disabled disabled-needed-dontremove" style="position: relative;
top: 1px;
left: -1px;"></span>
                                    </span>

                                    <!--shuffle button-->
                                    <span class="btn btn-circle btn-link ia-shuffle-btn mdi mdi-shuffle-variant font-16 col-grey m-b-5 disabled"
                                          onclick="setshuffle(ssIndex, true)" data="shuffle" style="padding-top: 8px"
                                          data-updateXX="setshuffle(ssIndex)" ssbindXx="x:setshuffle(ssIndex)">
                                    </span>

                                    <br>

                                    <!--<span class="ia-stop-btn btn hidden hexagon hexagon30 hexagon-gray m-l-5"
                                          onclick="publishCommand( devices[ssIndex]._encid, 'STOP')">
                                        <span class="mdi mdi-stop font-16 col-white"></span>
                                    </span>-->

                                    <!--silent button-->
                                    <span class="ia-silent-btn btn btn-circle btn-link m-b--10 m-l--20  mdi mdi-volume-medium font-18 col-grey"
                                          stylex="position: relative;top: 2px; margin-left: 3px;" cmd="SILENT"
                                          onclick="publishCommand( devices[ssIndex]._encid, this.getAttribute('cmd'))"
                                          data="silent" data-update="setsilent(ssIndex)"
                                          ssbind="x:setsilent(ssIndex)"></span>
                                    <!--volume button -->
                                    <input class="ia-volume-btn volume-slider" type="range" min="0" max="100"
                                           step="10" ssbind="value:getmyval(devices[ssIndex]._encid,'volume')"
                                           stylex="top: -2px;position: relative;"
                                           data="volume" data-update="setvolume(ssIndex)"
                                           onchange="publishCommand( devices[ssIndex]._encid , {command:'VOLUME_TO',volume: this.value})"
                                           sslevel="commands">

                                </div>
                                <!--end voice command-->
                            </div>
                        </div>
                        <!--end of commands section-->

                        <!--voice audio-->
                        <div class="text-center p-t-10 text-nowrap">
                            <span style="font-size: 25px;
    position: absolute;
    bottom: 66px;
    color: #d42021;
    left: 27px;" ssbind="file-icon:'voice'+devices[ssIndex]._encid;class:voiceicon(getmyval(devices[ssIndex]._encid,'file-name'))"></span>
                        <span data-toggleXX="modal" data-targetXX="#AudioGalleryModal"
                              onclick="voice_play( devices[ssIndex]._encid, null , null)"
                              ssif="devicetemps[devices[ssIndex].DeviceType].commandsoptions && devicetemps[devices[ssIndex].DeviceType].commandsoptions.type=='voice'"
                              class="speaker-file-name text-ellipsis btn-link btn  col-red"
                              style="display: inline-block;
    width: 100%;
    font-size: 15px;
    border-radius: 15px;
    background-color: #e0e0e0;
    margin-top: 8px;
    text-indent: 30px;
    padding: 2px;"
                              data-file-name-selector=""
                              ssbind="file-id:'voice'+devices[ssIndex]._encid;text:getmyval(devices[ssIndex]._encid,'file-name')||' choose a file to play';file-url:getmyval(devices[ssIndex]._encid,'file-url')||null;file-name:getmyval(devices[ssIndex]._encid,'file-name')||null;file-extension:getmyval(devices[ssIndex]._encid,'file-extension')||null;file-save:getmyval(devices[ssIndex]._encid,'file-save')||null"></span>
                        </div>

                        <!--controllers section conffff-->
                        <div class="commands controls"
                             ssif="devicetemps[devices[ssIndex].DeviceType].commands && devicetemps[devices[ssIndex].DeviceType].controllers"
                             ssbind="class: (devices[ssIndex]._online ? 'commands controls ' : 'commands controls offline ')">
                            <div class="text-center"
                                 ssfor="devicetemps[devices[ssIndex].DeviceType].controllers with controlIndex"
                                 sslevel="controllers">
                                <!--button command-->
                                <button ssif="devicetemps[devices[ssIndex].DeviceType].controllers && devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].type=='button' && devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].position=='card'"
                                        ssbind="text:devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].title;
                                        class:devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].class;
                                        style:devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].style"
                                        onclick="publishCommandConfirm( devices[ssIndex]._encid , devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].command, this, devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].confirm)"
                                        sslevel="controllers">-----</button>
                                <!--end button command-->

                                <!--databox command, not so command just data view -->
                                <div class="dev-data-box text-left p-t-10 p-b-10 m-t-5" style="min-height: unset" ssif="devicetemps[devices[ssIndex].DeviceType].controllers && devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].type=='databox' && devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].position=='card'" sslevel="controllers">

                                    <span ssbind="class: devicetemps[devices[ssIndex].DeviceType].data[devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].data].iconclass + ' col-blue font-15 m-l-25 float-left'" sslevel="controllers"></span>
                                    <dt class="m-l-20 text-ellipsis" ssbind="text: devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].title" sslevel="controllers"></dt>
                                    <dd ssbind="text:getmyval( devices[ssIndex]._encid , devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].data ,true);
                                        data:devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].data;
                                        data-value:getmyval( devices[ssIndex]._encid , devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].data );
                                        style:devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].style"
                                        class="m-l-20 m-t--20 pull-right"
                                        sslevel="controllers"></dd>
                                </div>
                                <!--end databox command-->

                                <!--switch command-->
                                <div class="switch p-t-10"
                                     ssif="devicetemps[devices[ssIndex].DeviceType].controllers && devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].type=='switch' && devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].position=='card'"
                                     sslevel="controllers"
                                     ssbind="data:devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].data"
                                     data-update="setswitch(ssIndex,controlIndex, devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].data, devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].ondata)">
                                    <label>
                                        <span class="hidden-xsXXXX"
                                              ssbind="html:devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].title"
                                              sslevel="controllers">A1</span>
                                        <input type="checkbox"
                                               ssbind="checked:getmyval(devices[ssIndex]._encid,devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].data)===devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].ondata"
                                               onchange="publishCommand( devices[ssIndex]._encid , this.checked ? devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].commands.on : devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].commands.off)"
                                               sslevel="controllers">
                                        <span class="lever switch-col-green"></span>
                                        <span class="hidden-xsXXXX"
                                              ssbind="html:devicetemps[devices[ssIndex].DeviceType].controllers[controlIndex].title2 || ''"
                                              sslevel="controllers">B2</span>
                                    </label>
                                </div>
                                <!--end switch command-->
                            </div>
                        </div>
                        <!--end of controllers section-->


                    </div>
                    <div class="footer row">
                        <div class="col-sm-9 col-xs-9">
                            <div ssif="devicetemps[devices[ssIndex].DeviceType].data.battery" class=" battery mdi"
                                 data="battery"
                                 ssbind="text:getmyval(devices[ssIndex]._encid,'battery', true)||'&nbsp;' ; data-value:getmyval(devices[ssIndex]._encid,'battery')">0</div>
                            <div ssif="devicetemps[devices[ssIndex].DeviceType].data.current" class=" mdi-current-ac mdi"
                                 data="current"
                                 ssbind="text:(getmyval(devices[ssIndex]._encid,'current', true)||'&nbsp;') ; data-value:getmyval(devices[ssIndex]._encid,'current')">0</div>

                            <div class="text-ellipsis small">
                                State changed at <span class=" receivetime m-r-15 mdiX Xmdi-clock-outline col-grey" data="__statetime"
                                     ssbind="text:getmyval(devices[ssIndex]._encid,'__statetime')?moment(getmyval(devices[ssIndex]._encid,'__statetime')).fromNow():'' ; data-value:getmyval(devices[ssIndex]._encid,'__statetime')"></span>
                                <br>
                                Data received at <span class=" receivetime m-r-15 mdiX Xmdi-clock-outline col-grey" data="__receivetime"
                                     ssbind="text:getmyval(devices[ssIndex]._encid,'__receivetime')?moment(getmyval(devices[ssIndex]._encid,'__receivetime')).fromNow():'' ; data-value:getmyval(devices[ssIndex]._encid,'__receivetime')"></span>
                            </div>
                        </div>
                        <div class="col-sm-3 col-xs-3">
                            <button class="btn btn-link btn-circle-lg float-right m-r--5 mdi font-26 mdi-cog-outline" onclick="showDevicePanelDialog(ssIndex)"></button>
                        </div>

                        <!--<ul class="header-dropdown xxxx hidden m-r&#45;&#45;5">
                            <li class="dropdown">
                                <a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown"
                                   role="button"
                                   aria-haspopup="true" aria-expanded="false">
                                    <i class="mdi mdi-settings"></i>
                                </a>
                                <ul class="dropdown-menu pull-right dashboard-stat-listXXX card body devices" role="menu">
                                    <li class="dropdown-submenu">
                                        <a href="javascript:void(0);"
                                           class=" waves-effect waves-block"><i class="mdi mdi-information-outline"></i>
                                            Device Info
                                            <i class="mdi mdi-chevron-right" style="position: relative; right: -18px"></i>
                                        </a>

                                        <ul class="dropdown-menu alert">
                                            <header class="text-right">
                                                <i class=" mdi mdi-close pointer"></i>
                                            </header>

                                            <div ssif="devicetemps[devices[ssIndex].DeviceType].ShowExtra">
                                                <li ssfor="devicetemps[devices[ssIndex].DeviceType].data with ss2index"
                                                    sslevel="datalevel">
                                                    <span ssbind="text:'ss2index'.replaceAll('option_','')" sslevel="datalevel"></span>:
                                                    <b class="text-ellipsis float-right m-r-5" style="display: -webkit-inline-box;max-width: 137px;overflow: hidden;"
                                                       ssbind="data:'ss2index';text:getmyval(devices[ssIndex]._encid,'ss2index')"
                                                       sslevel="datalevel"></b>
                                                </li>
                                                <hr/>
                                            </div>

                                            <li>
                                                Name:
                                                <span class="pull-right"><b ssbind="text:devices[ssIndex].Name">...</b></span>
                                            </li>
                                            <li>
                                                MAC:
                                                <span class="pull-right"><b ssbind="text:devices[ssIndex].MAC">...</b></span>
                                            </li>
                                            <li>
                                                Type:
                                                <span class="pull-right"><b
                                                        ssbind="text:devices[ssIndex].DeviceType">...</b></span>
                                            </li>
                                            &lt;!&ndash;<li>
                                                Status:
                                                <span class="pull-right"><b
                                                        ssbind="text:devices[ssIndex].IsActive?'ACTIVE':'NON ACTIVE'"></b></span>
                                            </li>&ndash;&gt;
                                            <li>
                                                Device Version:
                                                <span class="pull-right">
                                            <b ssbind="text:getmyval(devices[ssIndex]._encid,'FV')"
                                               data="FV">FV</b></span>
                                            </li>
                                            <li>
                                                Update Version:
                                                <span class="pull-right">
                                            <b ssbind="text:devices[ssIndex].FirmwareVersion?devices[ssIndex].FirmwareVersion:''">fv</b></span>
                                            </li>
                                            <li>
                                                Update Time:
                                                <span class="pull-right"><b
                                                        ssbind="text:devices[ssIndex].FirmwareUpdateTime?devices[ssIndex].FirmwareUpdateTime.split('T')[0]:'' ; title:devices[ssIndex].FirmwareUpdateTime">...</b></span>
                                            </li>
                                            <li>
                                                Added On:
                                                <span class="pull-right"><b
                                                        ssbind="text:devices[ssIndex].createdAt.split('T')[0] ; title:devices[ssIndex].createdAt">...</b></span>
                                            </li>
                                            &lt;!&ndash;                                            <div class="b-1 p-l-5 p-r-5 bg-info col-grey devicedata">&ndash;&gt;
                                            &lt;!&ndash;                                            </div>&ndash;&gt;
                                        </ul>
                                    </li>
                                    <li><a href="javascript:void(0);" sspage="/customer/views/history.device.view.html"
                                           sspage-load-after="topfilter.value=devices[ssIndex]._encid"
                                           sspage-back="/customer/views/iadevice.customer.list.view.html"
                                           class=" waves-effect waves-block"><i class="mdi mdi-history"></i>
                                        Activity</a>
                                    </li>
                                    <li ssbind="class: (devices[ssIndex]._online ? 'p-b-0 commands  online ' : ' commands offline ')">
                                        <a ssif="getLastDevVersion(ssIndex) && (getLastDevVersion(ssIndex)> (parseInt(getmyval(devices[ssIndex]._encid,'FV'))||0))" href="javascript:void(0);"
                                           onclick="firmewareupdate(devices[ssIndex]._id, devices[ssIndex].Name, devices[ssIndex]._online)">
                                            <i class="mdi mdi-file-upload-outline"></i>
                                            Firmware update to <span ssbind="text:getLastDevVersion(ssIndex)"></span>
                                        </a>
                                    </li>
                                    &lt;!&ndash;device options&ndash;&gt;
                                    <li ssfor="devicetemps[devices[ssIndex].DeviceType].data with option_name " sslevel="options" >

                                        <a sslevel="options" ssif="'option_name'.startsWith('option_') && devicetemps[devices[ssIndex].DeviceType].data['option_name'].type==='BOOLEAN'"
                                           onclickx="firmewareupdate(devices[ssIndex]._id, devices[ssIndex].Name, devices[ssIndex]._online);"
                                           class="p-b-0" ssbind="class: (devices[ssIndex]._online ? 'p-b-0 commands  online ' : ' commands offline ')">

                                            <input type="checkbox" class="chk-col-red filled-in"
                                                   data="option_name"
                                                   ssbind="id:'ssIndex-option_name-1' ; checked:getmyval(devices[ssIndex]._encid,'option_name')"
                                                   data-update="$('#ssIndex-option_name').prop('checked',getmyval(devices[ssIndex]._encid,'option_name'))"
                                                   sslevel="options"
                                                   onclick="publishCommand( devices[ssIndex]._encid, {'command':'SET_OPTION', 'option_name': this.checked} )">
                                            <label sslevel="options" ssbind="text: '&nbsp;'+(devicetemps[devices[ssIndex].DeviceType].data['option_name'].title || 'option_name'); for:'ssIndex-option_name-1'" style="font-size: 14px; "></label>
                                        </a>

                                        &lt;!&ndash;<a sslevel="options" ssif="'option_name'.startsWith('option_') && devicetemps[devices[ssIndex].DeviceType].data['option_name'].type==='NUMBER'"
                                           onclickx="firmewareupdate(devices[ssIndex]._id, devices[ssIndex].Name, devices[ssIndex]._online);"
                                           class="p-b-0" ssbind="class: (devices[ssIndex]._online ? 'p-b-0 commands  online ' : ' commands offline ')">
                                            <label>
                                            <div sslevel="options" ssbind="text: '&nbsp;'+(devicetemps[devices[ssIndex].DeviceType].data['option_name'].title || 'option_name'); for:'ssIndex-option_name-2'" style="font-size: 10px; ">SET</div>
                                            <input type="number" class="chk-col-red filled-in"
                                                   data="option_name"
                                                   ssbind="id:'ssIndex-option_name-2'; text:getmyval(devices[ssIndex]._encid,'option_name')||'&nbsp;' ; data-value:getmyval(devices[ssIndex]._encid,'option_name') ; checked:getmyval(devices[ssIndex]._encid,'option_name')"
                                                   data-update="$('#ssIndex-option_name').prop('checked',getmyval(devices[ssIndex]._encid,'option_name'))"
                                                   sslevel="options"
                                                   onchange1="publishCommand( devices[ssIndex]._encid, {'command':'SET_OPTION', 'option_name': this.value} )">
                                            </label>
                                        </a>&ndash;&gt;
                                    </li>
                                    <li><a href="javascript:void(0);"
                                           onclick="updatedevice(devices[ssIndex]._id, devices[ssIndex].Name)"
                                           class=" waves-effect waves-block"><i class="mdi mdi-pencil"></i> Rename device</a>
                                    </li>
                                    <li><a href="javascript:void(0);"
                                           sspage="/customer/views/iadevice.customer.changewifi.view.html?deviceIndex=ssIndex"
                                           sspage-load-after="ssbindRender();checkhashome()"
                                           sspage-back="/customer/views/iadevice.customer.list.view.html"
                                           class=" waves-effect waves-block"><i
                                            class="mdi mdi-wifi-cog"></i> WiFi Configuration</a>
                                    </li>
                                    <li>
                                        <a class=" col-red "
                                           onclick="deletedevice(devices[ssIndex]._id, devices[ssIndex].Name)"><i
                                                class="material-icons">delete</i> Remove</a>
                                    </li>
                                    &lt;!&ndash;<li><a href="javascript:void(0);" class=" waves-effect waves-block">Another action</a></li>&ndash;&gt;
                                    &lt;!&ndash;<li><a href="javascript:void(0);" class=" waves-effect waves-block">Something else here</a></li>&ndash;&gt;

                                </ul>
                            </li>
                        </ul>-->
                    </div>

                </div>
            </div>

        </div>
    </section>
    <!-- <aside class="rightpan col-lg-3 col-md-2 col-sm-2 col-xs-3 right-pan text-center" sspage-load="/customer/views/right.pan.html"></aside>-->

    <tag sspage-load="/dialogs/audio_upload.html" sspage-cache sspage-load-pre=".."></tag>
    <tag sspage-load="/dialogs/device_config_panel.html" sspage-cache sspage-load-pre="."></tag>
    <div sspage-load="/dialogs/map-gps-picker.html" sspage-cache sspage-load-pre="..."></div>
</div>

<script>

    function voiceicon(x){
        var icon;
        icon = (x) ? (x.startsWith('radio') ? 'mdi mdi-radio' : x.startsWith('playlist') ? 'mdi mdi-playlist-music' : x.startsWith('service') ? 'mdi mdi-camera-control' : 'mdi mdi-music') : 'mdi mdi-question'
        return icon;
    }

    function voice_play(_encid, cmd, sender) {
        var audio_target = $('[file-id="voice' + _encid + '"]');
        var audio_target_icon = $('[file-icon="voice' + _encid + '"]');

//        if(getmyval(_encid, 'file-name'))
        if ((audio_target.attr('file-url') && audio_target.attr('file-url') !== 'null')&&(cmd!==null)) {
            if (cmd === 'PLAY') {
                if (audio_target.attr('playlist')) {
                    cmd = JSON.parse(audio_target.attr('command'));
                } else {
                    cmd = {
                        'command': 'PLAY',
                        'file-name': audio_target.attr('file-name'),
                        'file-url': audio_target.attr('file-url'),
                        'file-extension': audio_target.attr('file-extension'),
                        'file-save': audio_target.attr('file-save')
                    }
                }
            } else if (cmd === 'PAUSE') {

            }
            publishCommand(_encid, cmd, sender);
        } else {
//             showAudioDialog(audio_target);
            showAudioDialog(function (file){
                audio_target.text(file['file-name']);
                audio_target_icon.attr('class', voiceicon(file['file-name']))
                audio_target.attr('file-name', file['file-name']);//unique name of file
                audio_target.attr('file-url', file['file-url']);
                audio_target.attr('file-extension', file['file-extension']);
                audio_target.attr('file-save', file['file-save']);
                if(file['command'])
                    audio_target.attr('command', file['command']);
                else
                    audio_target.removeAttr('command');

                audio_target.removeAttr('playlist');
                if (file['playlist']) {
                    audio_target.attr('playlist', file['playlist']);
                }
                //play automatically after select audio
                if(audio_target.attr('command')){
                    cmd = JSON.parse(audio_target.attr('command'));
                    publishCommand(_encid, cmd, null);
                } else {
                    publishCommand(_encid, {
                        'command': 'PLAY',
                        'file-name': audio_target.attr('file-name'),
                        'file-url': audio_target.attr('file-url'),
                        'file-extension': audio_target.attr('file-extension'),
                        'file-save': audio_target.attr('file-save')
                    }, null);
                }
            });
        }
    }

    function setsilent(index) {
        // if (devices[index].DeviceType !== 'IA_SPEAKER') return;
        var v = getmyval(devices[index]._encid);
        if (v) {
            var toolbar = $(`[topicbox="${devices[index]._encid}"]`);
            var silentbtn = toolbar.find('.ia-silent-btn');
            var silent = v.silent || false;
            if (silent) {
                silentbtn.addClass('mdi-volume-off col-red').removeClass('mdi-volume-medium col-grey');
                silentbtn.attr('cmd', 'NO-SILENT');
            } else {
                silentbtn.addClass('mdi-volume-medium col-grey').removeClass('mdi-volume-off col-red');
                silentbtn.attr('cmd', 'SILENT');
            }
        }
    }

    function setrepeat(index,change) {
        // if (devices[index].DeviceType !== 'IA_SPEAKER') return;

         var v = getmyval(devices[index]._encid);
         if(v) {
             var repeat = v.repeat || false;
             var toolbar = $(`[topicbox="${devices[index]._encid}"]`);
             var repeatbtn = toolbar.find('.ia-repeat-btn');

             if(change) {
                 repeat = !repeat;
                 publishCommand(devices[index]._encid, {'command': 'PLAY_REPEAT', 'repeat': repeat})
             }

             if (repeat) {
                 repeatbtn.addClass('mdi-repeat col-red').removeClass('mdi-repeat-off col-grey');
             } else {
                 repeatbtn.addClass('mdi-repeat-off col-grey').removeClass('mdi-repeat col-red');
             }
         }
    }

    function setshuffle(index,change) {
        // if (devices[index].DeviceType !== 'IA_SPEAKER') return;

         var v = getmyval(devices[index]._encid);
         if(v) {
             var shuffle = v.repeat || false;
             var toolbar = $(`[topicbox="${devices[index]._encid}"]`);
             var shufflebtn = toolbar.find('.ia-shuffle-btn');

             if(change) {
                 shuffle = !shuffle;
                 publishCommand(devices[index]._encid, {'command': 'PLAY_REPEAT', 'shuffle': shuffle})
             }

             if (shuffle) {
                 shufflebtn.addClass('mdi-shuffle-variant col-red').removeClass('mdi-shuffle-off col-grey');
             } else {
                 shufflebtn.addClass('mdi-shuffle-off col-grey').removeClass('mdi-shuffle-variant col-red');
             }
         }
    }

    function setvolume(index) {
        // if (devices[index].DeviceType !== 'IA_SPEAKER') return;
        var v = getmyval(devices[index]._encid, 'volume');
        if (v  || (v === 0) ) {
            var toolbar = $(`[topicbox="${devices[index]._encid}"]`);
            var volumcontrol = toolbar.find('.ia-volume-btn');
            volumcontrol.val(v);
        }
    }

    function setvoicebutton(index) {
        // if (devices[index].DeviceType !== 'IA_SPEAKER') return;
        var v = getmyval(devices[index]._encid);
        if (v) {
//            v = JSON.parse(v);
            var state = v.state || 'IDLE';

            var toolbar = $(`[topicbox="${devices[index]._encid}"]`);
            var playbtn = toolbar.find('.ia-play-btn');
            // var stopbtn = toolbar.find('.ia-stop-btn');

            playbtn.children().first().removeClass('mdi-play mdi-pause');
            // stopbtn.addClass('disabled');

            if (state === 'IDLE' || state === 'PAUSED' || state === 'ERROR') {
                //todo show message for ERROR
                playbtn.children().first().addClass('mdi-play');
                playbtn.attr('cmd', 'PLAY');
                // if (state === 'PAUSED')
                //     stopbtn.removeClass('disabled');
            } else if (state === 'PLAYING') {
                playbtn.children().first().addClass('mdi-pause');
                playbtn.attr('cmd', 'PAUSE');
                // stopbtn.removeClass('disabled');
            }

            /*try {
                //set file name
                var fileicon = toolbar.find('[file-icon]');
                fileicon.attr('class', voiceicon(v['file-name']));
                var fileid = toolbar.find('[file-id]');
                fileid.text(v['file-name']);
            }catch (e){
                console.error(e)
            }*/

        }
    }

    function setswitch(index, controlIndex, checkdata, checkvalue) {
        var chkcmd = document.querySelector("[topicbox='" + devices[index]._encid + "'] .commands [data='" + checkdata + "'] input[type=checkbox]");
        if (typeof controlIndex !== 'undefined')
            chkcmd = document.querySelector("[topicbox='" + devices[index]._encid + "'] .controls [data='" + checkdata + "'] input[type=checkbox]");
        var msg = getmyval(devices[index]._encid);
        chkcmd.checked = devicetemps[devices.find(device => device._encid === devices[index]._encid).DeviceType].commands[1].state === msg.state;
        if (typeof checkdata !== 'undefined') {
            chkcmd.checked = msg[checkdata] === checkvalue;
        }
    }

    function getmyval(_id, item, withUnit) {
        var val = window.localStorage[_id];
        var unit = (devicetemps[devices.find(dev=>dev._encid===_id).DeviceType].data[item] || {}).unit;
        var ret;
        if (val) {
            val = JSON.parse(val);
            if (item) {
                if (val[item] || (val[item]===0)) {
                    ret = val[item];
                } else {
                    return null;
                }
            } else {
                ret = val;
            }
        } else {
            return null
        }
        if(withUnit && unit)
            ret += ' '+unit
        return ret;
    }

    function deletedevice(_id, name) {
        swal.fire({
            title: "Attention", html: "Do you want to remove device \"" + name + "\" ?", //icon: "warning",
            imageUrl: "images/error.png",
            imageWidth: 50,
            showCancelButton: true,
            confirmButtonText: 'Remove'
        }).then((result) => {
            if (result.value) {
                $("#DevicePanelModal").modal('hide');
                setTimeout(function () {
                    $.ajax({
                        url: '/iadevice/' + _id,
                        type: 'DELETE',
                        complete: function (result) {
                            swal.fire({
                                title: "Device Removed",
                                html: "Device removed successfully from Smart Home",
//                    timer: 2000,
                                icon: "success",
                                showConfirmButton: true
                            });
                            updateDevices();
                            show_sspage()
                        }
                    });
                }, 200);
            }
        });
    }

    function updatedevice(_id, name) {
        swal.fire({
            title: "Rename Device",
            html: "Please set true name for your device",
            icon: "warning",
            input: 'text',
            inputValue: name,
//            imageUrl: "images/error.png",
//            imageWidth: 50,
            showCancelButton: true,
            confirmButtonText: 'Save',
            inputValidator: (value) => {
                if (!value) {
                    return 'Please set true name for device'
                }
            }
        }).then((result) => {
            if (result.value) {
                $("#DevicePanelModal").modal('hide');
                setTimeout(function () {
                    $.ajax({
                        url: '/iadevice/' + _id,
                        type: 'PUT',
                        data: {newname: result.value},
                        cache: false,
                        dataType: "json",
                        complete: function (result) {
                            swal.fire({
                                title: "Device Changed",
                                html: "Device name changed successfully",
//                    timer: 2000,
                                icon: "success",
                                showConfirmButton: true
                            });
                            updateDevices();
                            show_sspage()
                        }
                    });
                }, 200)
            }
        });
    }

    /*function locateMe(){
        getBrowserLocation((pos)=>{
            var mapurl = 'https://maps.google.com/maps?width=100%25&amp;height=300&amp;hl=en&amp;q='+pos.lat+','+pos.lon+'+(Find%20My%20Location)&amp;t=&amp;z=12&amp;ie=UTF8&amp;iwloc=B&amp;output=embed';
            var newiframe = "<iframe id='mappicker' width=\"100%\" height=\"300\" frameborder=\"0\" scrolling=\"no\" marginheight=\"0\" marginwidth=\"0\" src=\"" +
            mapurl+
            "\"></iframe>"
            document.getElementById('mappicker').innerHTML = newiframe;
        },(err)=>{

        })
    }*/

    function sharedevice(_id, tokens) {
        $('#shareTokens').val(tokens || 0);
        $('#DeviceShareBtn').off().click(function (e){
            $('#DeviceShareModal').modal('hide');
            $("#DevicePanelModal").modal('hide');
            // console.log(_id, $('#shareTokens').val(),  _pickedLocation.lat, _pickedLocation.long)
            setTimeout(function (){
                $.ajax({
                    url: '/iadevice/' + _id,
                    type: 'PUT',
                    data: {
                        shareby: $('#shareTokens').val(),
                        gps: _pickedLocation
                    },
                    cache: false,
                    dataType: "json",
                    complete: function (result) {
                        swal.fire({
                            title: "Device Sharing",
                            html: "Device data is shared successfully",
//                    timer: 2000,
                            icon: "success",
                            showConfirmButton: true
                        });
                        updateDevices();
                        show_sspage()
                    }
                });
            }, 200)
        });
        $("#DeviceShareModal").modal('show',_id);
        setTimeout(function (){initMapDialog()}, 1000)
        return;

        /*var _html = `
<script src="http://www.openlayers.org/api/OpenLayers.js" ><`+`/script>
<script src="../../share/plugins/osm/location-picker.js"><`+`/script>

<div class="location-picker">
    <h3>Define the location of device</h3>
<!--    <input type="text" id="txtAddress" class="form-control" placeholder="Enter address here" data-type="address" />-->
<!--    <input type="hidden" id="txtLocation" data-type="location-store" />-->
    <div class="map-container">
        <div id="map" data-type="map"></div>
    </div>
</div>
How many BKC tokens do you want for each data read from your device?<br>

<script>
alert('sss')
var locationPicker = $('.location-picker').locationPicker({
locationChanged : function(data){
$('#output').text(JSON.stringify(data));
},
init :{ current_location: true}
});

<\`+\`/script>
`;

        swal.fire({
            title: "Share Device Data",
            html: _html,
            icon: "warning",
            input: 'number',
            inputValue: 1,
//            imageUrl: "images/error.png",
//            imageWidth: 50,
            showCancelButton: true,
            confirmButtonText: 'Save',
            inputValidator: (value) => {
                if (!value) {
                    return 'Please set true price for device'
                }
            }
        }).then((result) => {
            if (result.value) {
                $("#DevicePanelModal").modal('hide');
                setTimeout(function () {
                    $.ajax({
                        url: '/iadevice/' + _id,
                        type: 'PUT',
                        data: {shareby: result.value},
                        cache: false,
                        dataType: "json",
                        complete: function (result) {
                            swal.fire({
                                title: "Device Share",
                                html: "Device data shared successfully",
//                    timer: 2000,
                                icon: "success",
                                showConfirmButton: true
                            });
                            updateDevices();
                            show_sspage()
                        }
                    });
                }, 200)
            }
        });*/

        /*
        var mapurl = "https://maps.google.com/maps?width=100%25&amp;height=300&amp;hl=en&amp;q=49.2608724,-123.113952+(Find%20My%20Location)&amp;t=&amp;z=12&amp;ie=UTF8&amp;iwloc=B&amp;output=embed"
        swal.fire({
            title: "Share Device Data",
            html: "How many BKC tokens do you want for each data read from your device?<br>" +
                "<button class='btn btn-primary-ia btn-sm' onclick='locateMe()'>Fine my location on map</button> " +
                "<div id='mappicker'><iframe id='mappicker' width=\"100%\" height=\"300\" frameborder=\"0\" scrolling=\"no\" marginheight=\"0\" marginwidth=\"0\" src=\"" +
                mapurl+
                "\"></iframe></div>",
            icon: "warning",
            input: 'number',
            inputValue: 1,
//            imageUrl: "images/error.png",
//            imageWidth: 50,
            showCancelButton: true,
            confirmButtonText: 'Save',
            inputValidator: (value) => {
                if (!value) {
                    return 'Please set true price for device'
                }
            }
        }).then((result) => {
            if (result.value) {
                $("#DevicePanelModal").modal('hide');
                setTimeout(function () {
                    $.ajax({
                        url: '/iadevice/' + _id,
                        type: 'PUT',
                        data: {shareby: result.value},
                        cache: false,
                        dataType: "json",
                        complete: function (result) {
                            swal.fire({
                                title: "Device Share",
                                html: "Device data shared successfully",
//                    timer: 2000,
                                icon: "success",
                                showConfirmButton: true
                            });
                            updateDevices();
                            show_sspage()
                        }
                    });
                }, 200)
            }
        });*/
    }

    function unsharedevice(_id) {
        swal.fire({
            title: "Share Device Data",
            html: "Do you want to disable data sharing for this device?",
            icon: "warning",
            // input: 'number',
            // inputValue: tokens,
//            imageUrl: "images/error.png",
//            imageWidth: 50,
            showCancelButton: true,
            confirmButtonText: 'Yes',
            /*inputValidator: (value) => {
                if (!value) {
                    return 'Please set true price for device'
                }
            }*/
        }).then((result) => {
            if (result.value) {
                $("#DevicePanelModal").modal('hide');
                setTimeout(function () {
                    $.ajax({
                        url: '/iadevice/' + _id,
                        type: 'PUT',
                        data: {unshare: 0},
                        cache: false,
                        dataType: "json",
                        complete: function (result) {
                            swal.fire({
                                title: "Disabling Device Share",
                                html: "Device data sharing disabled successfully",
//                    timer: 2000,
                                icon: "success",
                                showConfirmButton: true
                            });
                            updateDevices();
                            show_sspage()
                        }
                    });
                }, 200)
            }
        });
    }

    function getLastDevVersion(i){
        let device = devices[i];
        let ota = devicetemps[device.DeviceType].OTA;
        if(device.FirmwareSeries) {
            let releases = ota.Releases.filter(function (r){return r.Series === device.FirmwareSeries}).sort(function (a,b){return b.Version-a.Version});
            if(releases.length>0)
                return  releases[0].Version;
            else
                return null;
        } else {
            let releases = ota.Releases.filter(function (r){return !r.Series}).sort(function (a,b){return b.Version-a.Version});
            if(releases.length>0)
                return  releases[0].Version;
            else
                return null;
        }
    }

    function firmewareupdate(_id, name, isonline) {
        if (!isonline) {
            swal.fire({
                title: "Warning",
                html: name + ' is not online!',
//                    timer: 2000,
//                icon: "warning",
                imageUrl: "images/error.png",
                imageWidth: 50,
                showConfirmButton: true
            });
            return;
        }
        swal.fire({
            title: "Firmware Update",
            html: "<h4>Are you sure for update \"" + name + "\" ?</h4>" +
            "<div class='align-left p-l-10'>" +
            "<li>Make sure the device is turned on and connected!</li>" +
            "<li>If the device is battery powered, please connect it to the charger</li>" +
            "</div>",
            icon: "warning",
//            input: 'text',
//            inputValue: name,
//            imageUrl: "images/error.png",
//            imageWidth: 50,
            showCancelButton: true,
            confirmButtonText: 'Update',
            /*inputValidator: (value) => {
             if (!value) {
             return 'Plase set address of OTA file'
             }
             }*/
        }).then((result) => {
            console.log(_id, name)
            console.log(result)
            if (result.value) {
                $.ajax({
                    url: '/iadevice/firmware/' + _id,
                    type: 'PUT',
//                    data: { currentversion: result.value},
                    cache: false,
                    dataType: "json",
                    complete: function (result) {
                        swal.fire({
                            title: "Device update",
                            html: "Device get update command successfully",
//                    timer: 2000,
                            icon: "success",
                            showConfirmButton: true
                        });
                        updateDevices();
                        ssbindRenderLevel('devpanel');
                        //hide update button
                        $('#newversionpan > ').addClass('hidden ss-hidden');
//                        show_sspage()
                    }
                });
            }
        });
    }

    function goWiFiConfig(devindex){
        $("#DevicePanelModal").modal('hide');
        setTimeout(function (){
            show_sspage("/customer/views/iadevice.customer.changewifi.view.html?deviceIndex="+devindex , "ssbindRender();checkhashome()")
        },200)
    }

    updateDevices(function () {
        ssbindRenderThis('devices');
        $('.devicelist').show();
        ssbindRenderLevel('datalevel', true);
        ssbindRenderLevel('commands', true);
        ssbindRenderLevel('options', true);
        ssbindRenderLevel('controllers', true);
        $('.dropdown-submenu a').on("click", function(e){
            $(this).next('ul').toggle();
            e.stopPropagation();
            e.preventDefault();
        });
        $('.dropdown-submenu ul').on("click", function(e){
            $(this).toggle();
            e.stopPropagation();
            e.preventDefault();
        });
    });
</script>
