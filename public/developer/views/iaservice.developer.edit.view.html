<!--<script async defer type="text/javascript" src="js/map.js"></script>-->
<!--<script async defer type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?key1=YOUR_API_KEY&callback=initMap&libraries=places"></script>-->
<head>
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.6/ace.js" type="text/javascript"
            charset="utf-8"></script>-->
    <script src="../../../../share/plugins/ace/ace.js" type="text/javascript"
            charset="utf-8"></script>
    <script>
        /*define("DynHighlightRules", [], function(require, exports, module) {
         "use strict";

         var oop = require("ace/lib/oop");
         var TextHighlightRules = require("ace/mode/javascript_highlight_rules").TextHighlightRules;

         var DynHighlightRules = function() {
         this.setKeywords = function(kwMap) {
         this.keywordRule.onMatch = this.createKeywordMapper(kwMap, "identifier")
         }
         this.keywordRule = {
         regex : "\\w+",
         onMatch : function() {return "text"}
         }

         this.$rules = {
         "start" : [
         {
         token: "string",
         start: '"',
         end: '"',
         next: [{ token : "constant.language.escape.lsl", regex : /\\[tn"\\]/}]
         },
         this.keywordRule
         ]
         };
         this.normalizeRules()
         };

         //oop.inherits(DynHighlightRules, TextHighlightRules);

         exports.DynHighlightRules = DynHighlightRules;

         });*/
        var editor_;
        setTimeout(function () {
            editor_ = ace.edit("editor");
//            editor_.setTheme("ace/theme/solarized_dark");

            editor_.session.setMode("ace/mode/javascript");

            /*var jsMode = require("ace/mode/javascript").Mode;
             var IOTLMode = new jsMode();
             IOTLMode.HighlightRules = require("DynHighlightRules").DynHighlightRules;

             IOTLMode.$highlightRules.setKeywords({"keywords": "first|items|editor"})

             editor_.session.setMode(IOTLMode);

             var keywords = /syntax|highlighted/g
             editor_.findAll(keywords, {
             //caseSensitive: false,
             //wholeWord: true,
             regExp: true
             });*/
        }, 1100);


        //icon to base64:
        // Check for the File API support.
        var srviconbase64 = '';
        var srviconvalid = true;
        var srviconmessage = '';

        if (window.File && window.FileReader && window.FileList && window.Blob) {
            document.getElementById('srviconfile').addEventListener('change', handleFileSelect, false);
        } else {
            alert('The File APIs are not fully supported in this browser.');
        }

        function handleFileSelect(evt) {
            var f = evt.target.files[0]; // FileList object
            if (!f.type.startsWith('image')) {
                let iconimg = document.getElementById('srviconpreview');
                iconimg.src = defaulticon;
                srviconbase64 = '';
                srviconmessage = 'Bad file type is selected, please select a true image file with extension .PNG or .JPG';
                swal.fire({
                    title: 'Service Icon',
                    text: srviconmessage,
                    //html: true,
                    timer: 3000,
//                    icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            var reader = new FileReader();
            // Closure to capture the file information.
            reader.onload = (function (theFile) {
                return function (e) {
                    var binaryData = e.target.result;
                    //Converting Binary Data to base 64
                    var base64String = window.btoa(binaryData);
                    //showing file converted to base64
                    srviconbase64 = 'data:image/png;base64,' + base64String;
                    let iconimg = document.getElementById('srviconpreview');
                    $('#srviconpreview').removeClass('img-responsive')
                    iconimg.src = srviconbase64;
                    setTimeout(() => iconFileChanged(iconimg), 200);
                };
            })(f);
            // Read in the image file as a data URL.
            reader.readAsBinaryString(f);
        }

        function iconFileChanged(iconimg) {
            console.log('srviconbase64', iconimg.clientWidth, iconimg.clientHeight);

            $('#iconwidth').text(iconimg.clientWidth);
            $('#iconheight').text(iconimg.clientHeight);

            srviconvalid = true;
            srviconmessage = '';
            /*if(iconimg.clientWidth != iconimg.clientHeight) {
             srviconvalid = false;
             srviconmessage = 'Width and Height of icon must be equal'
             }*/
            if (iconimg.clientWidth > 512 || iconimg.clientHeight > 512) {
                srviconvalid = false;
                srviconmessage = 'Width and Height of icon must be <= 512 px'
            }

            $('#srviconpreview').addClass('img-responsive')

            if (!srviconvalid) {
                swal.fire({
                    title: 'Service Icon',
                    text: srviconmessage,
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
            }
        }
    </script>
</head>
<script>
    function updateIAService() {
        var nsrv = {};
        var isvalid = true;
        var validatemessage = '';
        var messagetitle = '';

//        nsrv.Published = document.querySelector('#srvpublished').checked;

        if (!document.querySelector('#name').checkValidity()) {
            isvalid = false;
            validatemessage = document.querySelector('#name').validationMessage;
            messagetitle = "Service Name";
        }else if (document.querySelector('[name="Description"]').value === '' && nsrv.Published) {
            isvalid = false;
            validatemessage = 'Please describe your service briefly by filling Description field';
            messagetitle = "Description";
            $('.nav-tabs a[href="#srvmain"]').tab('show');
            $('#description').focus();
        } else if (!document.querySelector('#priceadd').checkValidity()) {
            isvalid = false;
            validatemessage = document.querySelector('#priceadd').validationMessage;
            messagetitle = "Install Price";
        } else if (!document.querySelector('#pricerun').checkValidity()) {
            isvalid = false;
            validatemessage = document.querySelector('#pricerun').validationMessage;
            messagetitle = "Run Price";
        }

        if (!isvalid) {
            swal.fire({
                title: messagetitle,
                text: validatemessage,
                //html: true,
                //                    timer: 2000,
                //icon: "warning",
                imageUrl: "images/error.png",
                imageWidth: 50,
                showConfirmButton: true
            });
            return;
        }

        if (!srviconvalid) {
            swal.fire({
                title: 'Service Icon',
                text: srviconmessage,
                //html: true,
                //                    timer: 2000,
                //icon: "warning",
                imageUrl: "images/error.png",
                imageWidth: 50,
                showConfirmButton: true
            });
            return;
        }

        nsrv.Name = $('#name').val();
        nsrv.Description = $('#description').val();

        nsrv.Cron = document.querySelector('#cron').checked;
        nsrv.Copyright = document.querySelector('#copyright').value;
        nsrv.Category = document.querySelector('#category').value;

        nsrv.Vars = newservice.Vars;
        nsrv.Devices = newservice.Devices;
        nsrv.Buttons = newservice.Buttons;
        nsrv.Code = editor_.getValue();
        nsrv.NeedAccesses = Array.from(document.querySelectorAll('input[name="srvaccess"][type="checkbox"]'))
            .filter((checkbox) => checkbox.checked)
            .map((checkbox) => checkbox.value);
        nsrv.Icon = srviconbase64;
        nsrv.Iconpadding = false;

        nsrv.Price = {
            Add: $('#priceadd').val(),
            Run: $('#pricerun').val()
        };


        console.log('new service', nsrv);

        $.ajax({
            url: '/iaservice/' + newservice._id,
            data: nsrv,
//            async: !1,
            type: "put",
            dataType: "json",
            success: function (response) {
                swal.fire("Success", "", "success", {
//                button: "OK",
                    content: document.getElementById('successid')
                }).then((value) => {
                    //window.location = '/customer/logout'
                });
            },
            error: function (xhr, ajaxOptions, thrownError) {
                console.error(xhr, ajaxOptions, thrownError);
                // alert(thrownError + " - " + ajaxOptions);
            }
        }).fail(function (response) {
            swal.fire("Error", response.responseJSON.message, "error");
        });
    }

    function deleteIAService() {
        swal.fire({title: "Attention", html: "Do you want to delete this service?", //icon: "warning",
            imageUrl: "images/error.png",
            imageWidth: 50,
            showCancelButton: true,
            confirmButtonText: 'Delete'
        }).then((result) => {
            if (result.value) {
                $.ajax({
                    url: '/iaservice/' + oldservice._id,
                    type: 'DELETE',
                    success: function (result) {
                        swal.fire({
                            title: "BKC Service Deleted",
                            html: "BKC Service removed successfully",
//                    timer: 2000,
                            icon: "success",
                            showConfirmButton: true
                        });
                        show_sspage("/developer/views/iaservice.developer.page.view.html")
                    }
                });
            }
        });
    }


    function addRelease() {
        if(oldservice.Publish && oldservice.Publish.SubmittedVersion) {
            alert("If you already have requested a release to review, you could not add another release until you wait for it's review result, or you cancel it");
            return;
        }

        if(confirm("Do you want to add new release to this service?")) {
            $.ajax({
                url: '/iaservice/release/' + oldservice._id,
                type: 'POST',
                success: function (result) {
                    window.parent.swal.fire("BKC Service Release", "New release added successfully","success");
                    load_sspage($('#serviceload'));
                }
            }).fail(function (response) {
                window.parent.swal.fire("Error", response.responseJSON.message || response.statusText, "error");
            });;
        }
    }

    function deleteRelease(releaseId, action) {
        if(confirm(`Do you want to ${action} this release?`)) {
            $.ajax({
                url: '/iaservice/release/' + oldservice._id+'/'+releaseId,
                type: 'DELETE',
                success: function (result) {
                    window.parent.swal.fire("BKC Service Release", result.message,"success");
                    load_sspage($('#serviceload'));
                }
            }).fail(function (response) {
                window.parent.swal.fire("Error", response.responseJSON.message || response.statusText, "error");
            });
        }
    }

    function installForMe() {
        window.parent.swal.fire({
            title: "",
            width: '80vw',
            html: '<div id="inlinegallery">...</div>',
//                    timer: 2000,
//                icon: "warning",
            showConfirmButton: false
        });
        window.parent.show_sspage('../customer/views/iaservice.gallery.customer.view.html?serviceId='+oldservice._id , null , '#inlinegallery')
    }
</script>
<style type="text/css" media="screen">
    #editor {
        /*position: absolute;*/
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        height: 200px;
        font-size: inherit;
    }

    .servicesection {
        outline: 3px solid #d42021;
    }



    a.srvpublish {
        border: 2px solid green;
        border-radius: 20px;
    }

    .service.nav-tabs > li.active > a, .nav-tabs > li.active > a:hover, .nav-tabs > li.active > a:focus {
        background-color: transparent !important;
    }

    .bg-black {
        background-color: #282828 !important;
    }

    .table1 {
        width: 70%;
    }

    @media (max-width: 767px) {
        .table1 {
            width: 100%;
        }
    }

    .table1 th.col1 {
        width: 40%;
    }

    .table1 th.col2 {
        width: 30%;
    }

    .table1 th.colbtn {
        width: 10%;
    }

    .col1 input, .col2 input, .col2 select {
        width: 90% !important;
    }
</style>
<!--<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js"></script>-->
<!--uses ssbind and sspage tags-->
<div class="collapse hidden">
    <div id="successid">Changes saved.

    </div>
</div>
<div class="card  m-t--30 m-r--15 m-l--15 m-b-0" style="height: calc(100vh - 70px)"
     sspage-load-json="/iaservice/[sspagesearch.id]" sspage-load-json-var="oldservice" id="serviceload"
     sspage-load-after="initPage()"
>
    <div class="header m-b--10">
        <span class="ia-medium-title " ssbind="text:newservice.Name">
        </span> <span class="ia-medium-title ">(Coding Console)</span>

        <ul class="header-dropdown ">
            <!--<a href="#srvpublish" data-toggle="tab" aria-expanded="true" class="btn col-green btn-link srvpublish m-t&#45;&#45;10">Publish</a>-->
            <li class="dropdown">
                <a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button"
                   aria-haspopup="true" aria-expanded="false">
                    <i class="material-icons">more_vert</i>
                </a>
                <ul class="dropdown-menu pull-right">
                    <li><a href="#" onclick="$('.nav-tabs a[href=\'#srvpublish\']').tab('show');return false;"
                           class=" waves-effect waves-block ">
                        Publish
                    </a></li>
                    <li><a href="#" onclick="installForMe();return false"
                           sspage-group="menu"
                           class=" waves-effect waves-block ">
                        Install for me
                    </a></li>
                    <li><a href="javascript:deleteIAService(); void(0);" class=" waves-effect waves-block col-red"

                    >Delete Service</a></li>
                </ul>
            </li>
        </ul>
    </div>
    <div class="body ">
        <!-- Nav tabs -->
        <ul class="nav nav-tabs tab-col-red service" role="tablist">
            <li role="presentation" class="active">
                <a href="#srvmain" data-toggle="tab" aria-expanded="true">
                    <!--<i class="mdi mdi-home "></i> -->Profile
                </a>
            </li>
            <li role="presentation" class="">
                <a href="#srvdevice" data-toggle="tab" aria-expanded="false">
                    <!--<i class="mdi mdi-video-input-component "></i> -->Device | Variable
                </a>
            </li>
            <li role="presentation" class="">
                <a href="#srvcode" data-toggle="tab" aria-expanded="false">
                    <!--<i class="mdi mdi-code-tags "></i> -->Code
                </a>
            </li>
            <!-- <li role="presentation" class="">
                 <a href="#srvbuttons" data-toggle="tab" aria-expanded="false">
                     <i class="mdi mdi-gesture-tap "></i> TAPS
                 </a>
             </li>-->
            <li role="presentation" class="">
                <a href="#srvpayment" data-toggle="tab" aria-expanded="false">
                    <!--<i class="mdi-credit-card-settings  mdi"></i> -->Payment
                </a>
            </li>
            <li role="presentation" class="">
                <a href="#srvsetting" data-toggle="tab" aria-expanded="false">
                    <!--<i class="mdi mdi-settings-outline "></i> -->Settings
                </a>
            </li>
            <li role="presentation" class="hidden" ssif="oldservice.Publish.CurrentVersion > 0 ">
                <a href="#srvpublish" data-toggle="tab" aria-expanded="false">
                    <i class="Xmdi-credit-card-settings  mdiX"></i> Publish
                </a>
            </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content ">
            <div role="tabpanel" class="tab-pane fade active in" id="srvmain">
                <!--<b class="ia-big-title">Main Information of IA Service</b>-->
                <div class="row">
                    <div class="col-sm-4">
                        <!--<label for="name"><span class=" ia-big-title col-red">Name of Service</span></label>-->
                        <label class="form-label" for="name">Service Name</label>
                        <div class="form-group form-float">
                            <div class="form-line">
                                <input type="text" name="Name" id="name" placeholder="An alphanumeric name"
                                       class="form-control" required onchange="this.value=this.value.trim()"
                                       ssbind="value:newservice.Name">

                            </div>
                        </div>
                    </div>

                    <div class="col-sm-4 hidden">
                        <label class="form-label" for="copyright">Copyright</label>
                        <div class="form-group form-float">
                            <div class="form-line">
                                <input type="hidden" id="copyright" class="form-control" required
                                       ssbind="value:newservice.Copyright">
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <label class="form-label" for="category">Category</label>
                        <div class="form-group form-float">
                            <div class="form-line">
                                <select class="form-control"
                                        id="category">
                                    <option ssfor="ServiceCategories"
                                            ssbind="text:ServiceCategories[ssIndex]; value:ServiceCategories[ssIndex]; selected:ServiceCategories[ssIndex]==newservice.Category"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12">
                        <label class="form-label" for="description">Description</label>
                        <div class="form-group form-float">
                            <div class="form-line">
                                            <textarea type="text" name="Description" id="description"
                                                      ssbind="value:newservice.Description"
                                                      class="form-control" placeholder="Describe your service here ..."
                                                      rows="3"></textarea>
                            </div>
                        </div>
                    </div>


                    <div class="col-sm-3">
                        <label for="srviconfile">Logo</label><br>
                        <small class="col-grey">Add an Icon or Logo for your service</small>
                        <div class="form-group form-float">
                            <div class="service">
                                <input type="file" accept="image/x-png,image/gif,image/jpeg" id="srviconfile"
                                       class="form-control"
                                       required style="background-color: transparent;">
                            </div>
                        </div>
                        <small class="col-grey">Your file must be .JPG or .PNG format,<br>Recommended size is 512x512
                            pixels.
                        </small>
                    </div>
                    <div class="col-sm-2 service">

                        <label for="srviconfile" id="drop-area"><img id="srviconpreview" class="img-responsive b-1"
                                                               ssbind="src:newservice.Icon || defaulticon"></label>
                        <div class="text-center hidden"><span id="iconwidth">512</span> X <span
                                id="iconheight">512</span>
                        </div>


                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade row" id="srvdevice">
                <div class="col-sm-12">
                    <b class=" ia-big-title col-red">Devices</b>
                    <br>
                    <small class="col-grey">Define Device Binders here.
                    </small>
                    <div class="form-group form-float m-t-5">
                        <table class="table1">
                            <thead>
                            <!--<tr>
                                <th>Indicator</th>
                                <th>Device Type</th>
                            </tr>-->
                            <tr class="">
                                <th class=" col1" style="white-space: nowrap"><input type="text"
                                                                                         style="width: 90%;border: 1px solid grey;"
                                                                                         id="newdevicename"
                                                                                         class=" form-control inline"
                                                                                         required
                                                                                         placeholder="Name">
                                </th>
                                <th class="col2">
                                    <select class="form-control text-capitalize "
                                            id="newdevicetype">
                                        <option ssfor="Object.keys(devicetemps)  with ssIndx ssObj" sslevel="srvdevices1"
                                                ssnextlevel="srvdevices"
                                                ssbind="text:devicetemps[Object.keys(devicetemps)[ssIndx]].title; value:Object.keys(devicetemps)[ssIndx]"></option>
                                    </select>
                                </th>
                                <!--<th class="" style="width: 20%">
                                    <input type="checkbox" name="newdeviceinvoker" id="newdeviceinvoker"
                                           class="with-gap "> <label for="newdeviceinvoker" class="">Invoker</label>
                                </th>-->
                                <th class="colbtn">
                                    <div class="btn bg-red" id="addDevice">
                                        <i class="material-icons">add</i>
                                    </div>
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr ssfor="newservice.Devices" sslevel="srvdevices" class=" "
                                ssnextlevel="srvdevices2">
                                <td sslevel="srvdevices" class="mono"
                                    ssbind="text: newservice.Devices[ssIndex].Name"></td>
                                <td sslevel="srvdevices"
                                    ssbind="text:newservice.Devices[ssIndex].DeviceType"></td>
                                <!--<td sslevel="srvdevices" class="col-orange"
                                    ssbind="text:newservice.Devices[ssIndex].Invoker?'Invoker':''"></td>-->
                                <td>
                                    <div class="btn btn-link col-red"
                                         onclick="newservice.Devices.splice(ssIndex,1); ssbindRenderLevel('srvdevices')">
                                        <i class="material-icons">close</i>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-sm-12">
                    <b class=" ia-big-title col-red">User Variables</b>
                    <br>
                    <small class="col-grey">Define User Variables here.
                    </small>
                    <div class="form-group form-float m-t-5">
                        <table class="table1">
                                <thead>
                                <!--<tr>
                                    <th>Indicator</th>
                                    <th>Variable Type</th>
                                </tr>-->
                                <tr>
                                    <th style="white-space: nowrap" class=" col1" nowrap="1"><input
                                            style="width: 90%;border: 1px solid grey;"
                                            type="text" id="newvarname" class="form-control inline"
                                            required placeholder="Name"></th>
                                    <th class="col2"><select class="form-control text-capitalize "
                                                id="newvartype">
                                        <option ssnextlevel="srvvars" ssfor="vartypes with vtIndx vtObj"
                                                ssbind="text:vartypes[vtIndx]; value:vartypes[vtIndx]"></option>
                                    </select></th>
                                    <th class="colbtn">
                                        <div class="btn bg-red " id="addVar">
                                            <i class="material-icons">add</i>
                                        </div>
                                    </th>
                                </tr>
                                </thead>
                                <tr ssfor="newservice.Vars" sslevel="srvvars" >
                                    <td sslevel="srvvars"
                                        ssbind="text: newservice.Vars[ssIndex].Name"></td>
                                    <td sslevel="srvvars" ssbind="text:newservice.Vars[ssIndex].Type"></td>
                                    <td>
                                        <div class="btn btn-link col-red"
                                             onclick="newservice.Vars.splice(ssIndex,1); ssbindRenderLevel('srvvars')">
                                            <i class="material-icons">close</i>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                    </div>
                </div>
                <div class="col-sm-12">
                    <b class=" ia-big-title col-red">Buttons</b>
                    <br>
                    <small class="col-grey">Buttons which are in the service box, Define them with their title and bind
                        them to a
                        function in the Code,
                    </small>
                    <div class="form-group form-float m-t-5">
                        <table class="table1">
                                <thead>
                                <!--<tr>
                                    <th>Indicator</th>
                                    <th>Variable Type</th>
                                </tr>-->
                                <tr>
                                    <th style="white-space: nowrap" class="col1" nowrap="1">&nbsp;<input
                                            style="border: 1px solid grey;"
                                            type="text" id="newbuttontitle" class="form-control inline"
                                            required placeholder="Button Title">
                                    </th>
                                    <th style="white-space: nowrap" class="col2" nowrap="1"><input
                                            style="width: 93%;border: 1px solid grey;"
                                            type="text" id="newbuttonfunction" class="form-control inline"
                                            required placeholder="function name">
                                    </th>
                                    <th class="colbtn">
                                        <div class="btn bg-red" id="addButton">
                                            <i class="material-icons">add</i>
                                        </div>
                                    </th>
                                </tr>
                                </thead>
                                <tr ssfor="newservice.Buttons" sslevel="srvbuttons" >
                                    <td align="center"><span sslevel="srvbuttons"
                                                             class="b-1 bg-red  p-b-5 p-t-5 p-l-10 p-r-10"
                                                             ssbind="text:newservice.Buttons[ssIndex].Title"></span>
                                    </td>
                                    <td sslevel="srvbuttons"
                                        ssbind="text:newservice.Buttons[ssIndex].Function+'()'"></td>
                                    <td>
                                        <div class="btn btn-link col-red"
                                             onclick="newservice.Buttons.splice(ssIndex,1); ssbindRenderLevel('srvbuttons')">
                                            <i class="material-icons">close</i>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="srvcode">
                <!--//code editor from https://ace.c9.io-->
                <div class="">
                    <b class=" ia-big-title col-red">Service Code</b>

                    <div class="ace-solarized_dark">
                        <!--&nbsp;&nbsp;&nbsp;<small class="col-blue">Device Indicators:</small>
                        <span ssfor="newservice.Devices with ssIndex2 ssObject2" sslevel="srvdevices2" class="col-blue">
                            <span sslevel="srvdevices2"
                                ssbind="text:newservice.Devices[ssIndex2].Name"></span>
                            <span sslevel="srvdevices2"
                                ssbind="text:newservice.Devices[ssIndex2].DeviceType"></span>
                            <span class="btn btn-link btn-small"
                                 onclick="newservice.Devices.splice(ssIndex2,1); ssbindRenderLevel('srvdevices')">
                                <i class="material-icons">close</i>
                            </span>
                        </span>
                        <br>
                        &nbsp;&nbsp;&nbsp;<small class="col-cyan">User Variables:</small><br>
                        <br>-->
                        <div id="editor" ssbind="html:newservice.Code">
                        </div>
                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="srvpayment">
                <!--//code editor from https://ace.c9.io-->

                <br>
                <div class="row">
                    <div class="col-sm-5">
                        <label class="form-label ia-big-title col-red" for="priceadd">Install Price</label>
                        <div class="form-group form-float">
                            <small class="col-grey ">How many BKCs would be paid for Installing this service?</small>
                            <div class="m-t-10 ">
                                <input type="number" min="0" max="100000" id="priceadd"
                                       class="form-control ia-bigger-title b-1  " required value="0"
                                       ssbind="value:oldservice.Price.Add" sslevel="oldserv">

                            </div>
                            <!--<label for="priceadd" style=" position: relative;top: -28px;left: 70%; width: 50px;">BKC</label>-->
                        </div>
                    </div>
                    <div class="col-sm-5">
                        <label class="form-label ia-big-title col-red" for="pricerun">Run Price</label>
                        <div class="form-group form-float">
                            <small class="col-grey">How many BKCs would be paid when every run of this service?</small>
                            <div class="m-t-10">
                                <input type="number" min="0" max="100000" id="pricerun"
                                       class="form-control ia-bigger-title b-1 " required value="0"
                                       ssbind="value:oldservice.Price.Run" sslevel="oldserv">
                            </div>
                            <!--<label for="pricerun" style=" position: relative;top: -28px;left: 70%; width: 50px;">BKC</label>-->
                        </div>
                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="srvsetting">
                <div class="form-group form-float">
                    <div class="">
                        <b class=" ia-big-title col-red">Security</b>
                        <br>
                        <small class="col-grey">Which access need your new service?<br><br></small>

                        <ul style="list-style: none">
                            <li ssfor="home_accesses" sslevel="srvaccess">
                                <!--<input name="srvaccess" ssbind="value:home_accesses[ssIndex]" type="checkbox">
                                <span ssbind="text:home_accesses[ssIndex]"></span>-->

                                <input type="checkbox" name="srvaccess" class="filled-in chk-col-red"
                                       sslevel="srvaccess"
                                       ssbind="id :'acc'+ssIndex; value:home_accesses[ssIndex]; checked: newservice.NeedAccesses.indexOf(home_accesses[ssIndex])>-1">
                                <label ssbind="for:'acc'+ssIndex; text:home_accesses[ssIndex]" sslevel="srvaccess">Access</label>
                            </li>
                        </ul>

                    </div>
                </div>
                <div class="form-group form-float">
                    <div class=" m-t-10">
                        <b class=" ia-big-title col-red">Schedule</b>
                        <br>
                        <!--<small class="col-grey">Check if this service runs schedully</small>-->
                        <!--<br><br>-->
                        <ul>
                            <input type="checkbox" name="Cron" id="cron" class="filled-in chk-col-red"
                                   ssbind="checked: newservice.Cron"
                                   value="true"> <label for="cron">This service runs on the
                            schedule</label>
                        </ul>
                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="srvpublish">
                <b class=" ia-big-title col-red">Publish in Service Market</b>
                <br>
                <!--<small class="col-grey">Taps are buttons in the service box, Define them with their title and bind to a
                    function in code,
                </small>-->
                <!--<div class="switch s">
                    <label><span class="col-grey">Unpublished</span><input type="checkbox"
                                                                           ssbind="checked:newservice.Published"
                                                                           id="srvpublished"><span
                            class="lever switch-col-green"></span><span class="col-green">Published</span> </label>
                </div>

                <br>-->

                <div class="alert bg-amber col-red hidden" ssif="oldservice.Publish && oldservice.Publish.PublishedVersion" sslevel="releases">This service is published at release version
                    <span ssbind="text:oldservice.Publish.PublishedVersion" sslevel="releases" class="font-bold badge bg-red font-20"></span>
                </div>

                <div>
                    If you want publish your service in BKC Service Market to other users could install it, your have to add a new release for your service.
                    After reviwing your requested release, the BKC admin will publish your service in Service Market if there was no issue.
                </div>


                <div class="p-t-10 p-l-20 p-r-20 p-b-15 m-t-20 m-b-20 bg-danger">

                    <div class="col-black">
                        For adding new Release click
                        <button sslevel="releases" ssbind="disabled:oldservice.Publish && oldservice.Publish.SubmittedVersion"
                                onclick="addRelease();" class=" btn btn-primary-ia ">add Release</button>
                    </div>
                    <ul class="m-t-15">
                        <li class="font-small col-grey">If you already have requested a release to review, you could not add another release until you wait for it's review result, or you cancel it.</li>
                    </ul>
                </div>

                <h6>Releases</h6>
                <div role="tabpanel" class="tab-pane fade active in panel-group p-b-10" id="accordion" style="height: 270px; overflow-y: auto">
                    <!--header-->
                    <div class="m-b-10 b-b-1 col-grey hidden-xs">
                        <div class="panel-heading m-l--15">

                            <!--<h4 class="panel-title p-l-0 p-r-0">-->
                            <!--<a data-toggle="" data-parent=""  class=" ">-->
                            <div class="row">
                                <div class="col-sm-1 col-xs-1 "><span class="mdi mdi-play col-white"></span></div>
                                <div class="col-sm-2 col-xs-4 col-black font-bold">Version</div>
                                <div class="col-sm-4 col-xs-5 col-black font-bold align-right">Release Time</div>
                                <div class="col-sm-4 col-xs-5 col-black font-bold align-right">Status</div>
                            </div>
                            <!--</a>-->
                            <!--</h4>-->
                        </div>
                    </div>
                    <!--list-->
                    <div class="panel panel-default1" ssfor="oldservice.Publish.Releases" ssforreverse="ssforreverse" sslevel="releases" ssemptylist="You have not created any release yet.">
                        <div class="panel-heading m-l--15">
                            <a data-toggle="collapse" data-parent="#accordion" class="accordion collapsed btn-link waves-effectXX m-b--5" ssbind="href:'#'+oldservice.Publish.Releases[ssIndex]._id" sslevel="releases">

                                <div ssbind="class: oldservice.Publish.Releases[ssIndex].OnPublish?'row col-green':'row'" sslevel="releases">
                                    <div class="col-sm-1 col-xs-1 font-13 col-grey ">
                                        <span class="mdi mdi-chevron-down"></span>
                                    </div>
                                    <div class="col-sm-2 col-xs-10 font-13 font-bold" ssbind="text:oldservice.Publish.Releases[ssIndex].Version" sslevel="releases"></div>
                                    <div class="col-sm-4 col-xs-12 font-13 Status align-right" ssbind="text:moment(oldservice.Publish.Releases[ssIndex].ReleaseTime).format('YYYY-MMM-DD dd HH:mm')" sslevel="releases"></div>
                                    <div class="col-sm-4 col-xs-12 font-13 Status align-right" ssbind="text:oldservice.Publish.Releases[ssIndex].SurveyResult || ''" sslevel="releases"></div>
                                    <!--<div class="col-sm-2 col-xs-12 font-13 col-grey align-right" ssbind="text:moment(releases[ssIndex].updatedAt).fromNow();title:releases[ssIndex].updatedAt" sslevel="releases"></div>-->
                                </div>
                            </a>
                        </div>
                        <div class="panel-collapse collapse " ssbind="id:oldservice.Publish.Releases[ssIndex]._id" sslevel="releases" >
                            <!--<pre ssbind="text:JSON.stringify(oldservice.Publish.Releases[ssIndex],null,'\t')" sslevel="releases"></pre>-->

                            <div ssif="oldservice.Publish.Releases[ssIndex].SurveyTime" sslevel="releases"
                                 class="bg-black bg-red col-amber p-b-10 p-l-20 p-r-20 p-t-10" style="border-top: 7px solid #FFC107;" >

                                <li class="hidden" ssif="oldservice.Publish.Releases[ssIndex].CheckingTime" sslevel="releases"> Checked at <span ssbind="text:moment(oldservice.Publish.Releases[ssIndex].CheckingTime).format('YYYY-MMM-DD dd HH:mm')" sslevel="releases"></span></li>

                                <li>
                                    Status changed to
                                    <span ssbind="text:oldservice.Publish.Releases[ssIndex].SurveyResult" sslevel="releases"></span>
                                    at
                                    <span ssbind="text:moment(oldservice.Publish.Releases[ssIndex].SurveyTime).format('YYYY-MMM-DD dd HH:mm')" sslevel="releases"></span>
                                </li>

                                <li class="hidden" ssif="oldservice.Publish.Releases[ssIndex].PublishTime" sslevel="releases"> Published at <span ssbind="text:moment(oldservice.Publish.Releases[ssIndex].PublishTime).format('YYYY-MMM-DD dd HH:mm')" sslevel="releases"></span></li>
                                <li class="hidden" ssif="oldservice.Publish.Releases[ssIndex].UnPublishTime" sslevel="releases"> Unpublished to version <span ssbind="text:oldservice.Publish.Releases[ssIndex].UnPublishToVersion" sslevel="releases"></span> at <span ssbind="text:moment(oldservice.Publish.Releases[ssIndex].UnPublishTime).format('YYYY-MMM-DD dd HH:mm')" sslevel="releases"></span></li>

                            </div>
                            <button ssif="oldservice.Publish.Releases[ssIndex].SurveyResult==='Requested'" sslevel="releases" onclick="deleteRelease(oldservice.Publish.Releases[ssIndex]._id, 'delete')" class="btn btn-primary-ia hidden float-right m-t--50 m-r-20">Delete Release</button>
                            <button ssif="oldservice.Publish.Releases[ssIndex].SurveyResult==='Published' && oldservice.Publish.Releases[ssIndex].OnPublish" sslevel="releases" onclick="deleteRelease(oldservice.Publish.Releases[ssIndex]._id, 'unpublish')" class="btn btn-primary-ia hidden float-right m-t--50 m-r-20">Unpublish Release</button>
                        </div>
                    </div>

                    <br><br><br>
                </div>

            </div>
            <!--<div role="tabpanel" class="tab-pane fade" id="srvpublish">
                <b class=" ia-big-title col-red">Service Publish</b>
                <br>
                &lt;!&ndash;<small class="col-grey">Taps are buttons in the service box, Define them with their title and bind to a
                    function in code,
                </small>&ndash;&gt;
                <div class="switch s">
                    <label><span class="col-grey">Unpublished</span><input type="checkbox"
                                                                           ssbind="checked:newservice.Published"
                                                                           id="srvpublished"><span
                            class="lever switch-col-green"></span><span class="col-green">Published</span> </label>
                </div>
                <div class="form-group form-float">
                    <div class="">
                        <table class=" ">
                            <thead>

                            </thead>
                            <tr ssfor="newservice.Varee" sslevel="srvpublishes" class=" b-b-1">
                                <td sslevel="srvpublishes"
                                    ssbind="text:newservice.Buttons[ssIndex].Title"></td>
                                <td sslevel="srvpublishes"
                                    ssbind="text:'-> '+newservice.Buttons[ssIndex].Function+'()'"></td>
                                <td>
                                    <div class="btn btn-link col-red"
                                         onclick="newservice.Buttons.splice(ssIndex,1); ssbindRenderLevel('srvbuttons')">
                                        <i class="material-icons">close</i>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>-->
        </div>


        <div class="text-right button-pan" id="buttonpanelrsrv">
            <button class="btn btn-link col-red waves-effect-x2  align-right ia-big-title"
                    sspage="../developer/views/iaservice.developer.page.view.html">
                Back
            </button>
            <button class="btn btn-primary-ia waves-effect-x2 align-right ia-big-title"
                    onclick="updateIAService()">
                Save Changes
            </button>
        </div>

    </div>
</div>

<script>
    var newservice;
    function initPage() {
        console.log('inintpage======================')
        newservice = {
            Devices: [],
            Vars: [],
            Buttons: [],
            Price: {Add:0, Run:0}
        };

        if (typeof oldservice !== 'undefined') {
            Object.assign(newservice, oldservice)
        }
        if (!newservice.Devices) newservice.Devices = [];
        if (!newservice.Vars) newservice.Vars = [];
        if (!newservice.Buttons) newservice.Buttons = [];
        srviconbase64 = newservice.Icon || '';


        ssbindRender();

        $("#addDevice").click(() => {
            let name = $('#newdevicename').val().trim();
            if (name === '') {
                swal.fire({
                    title: 'New Device Binder',
                    text: 'Please set a name for new device binder!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            if (newservice.Devices.some(v => v.Name === name) || newservice.Vars.some(v => v.Name === name)) {
                swal.fire({
                    title: 'New Device Binder',
                    text: 'New device binder is duplicated!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            newservice.Devices.push({
                'Name': name,
                'DeviceType': $('#newdevicetype').val(),
                'Invoker': devicetemps[$('#newdevicetype').val()].type === "SENSOR",
                'TransferTo': confirm('Do you want to transfer BKC to this device?')
                //Invoker: document.querySelector('#newdeviceinvoker').checked
            });
            $('#newdevicename').val('');
//            document.querySelector('#newdeviceinvoker').checked = false;
            ssbindRenderLevel('srvdevices1');
        });

        $("#addVar").click(() => {
            let name = $('#newvarname').val().trim();
            if (name === '') {
                swal.fire({
                    title: 'New Variable',
                    text: 'Please set a name for new variable!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            if (newservice.Devices.some(v => v.Name === name) || newservice.Vars.some(v => v.Name === name)) {
                swal.fire({
                    title: 'New Variable',
                    text: 'New variable name is duplicated!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            newservice.Vars.push({'Name': name, 'Type': $('#newvartype').val()});
            $('#newvarname').val('')
            ssbindRenderLevel('srvvars');
        });

        $("#addButton").click(() => {
            let title = $('#newbuttontitle').val().trim();
            let funx = $('#newbuttonfunction').val().trim();
            /*if(name==='') {
             swal.fire({
             title: 'New Variable',
             text: 'Please set a name for new variable!',
             //html: true,
             //                    timer: 2000,
             icon: "warning",
             showConfirmButton: true
             });
             return;
             }*/
            if (title === '') {
                swal.fire({
                    title: 'New Button',
                    text: 'Please set a title for new Button!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            if (funx === '') {
                swal.fire({
                    title: 'New Button',
                    text: 'Please set a function name for new Button!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            if (newservice.Buttons.some(v => v.Title === title)) {
                swal.fire({
                    title: 'New Tap command',
                    text: 'New Tap title is duplicated',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            if (newservice.Buttons.some(v => v.Function === funx)) {
                swal.fire({
                    title: 'New Tap command',
                    text: 'New Tap function name is duplicated',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            newservice.Buttons.push({'Title': title, 'Function': $('#newbuttonfunction').val()});
            $('#newbuttontitle').val('');
            $('#newbuttonfunction').val('');
            ssbindRenderLevel('srvbuttons');
        });

        ssbindRenderLevel('srvbuttons');
        ssbindRenderLevel('srvpublishes');
        ssbindRenderLevel('srvaccess');
        ssbindRenderLevel('oldserv');
        ssbindRenderLevel('srvdevices1');
        ssbindRenderLevel('releases');


        //drop-area
        var dropArea = document.getElementById('drop-area');

        dropArea.addEventListener('dragenter', handleFileSelect, false);
        dropArea.addEventListener('dragleave', handleFileSelect, false);
        dropArea.addEventListener('dragover', handleFileSelect, false);
        dropArea.addEventListener('drop', handleFileSelect, false)

        if(newservice._Installed) {
            window.parent.swal.fire({
                title: 'Warning',
                text: 'This service is installed '+newservice._Installed+' time' + (newservice._Installed>1 ? 's':'') + ', If you change this service just those installations with version 0 will be affected (which you have installed for yourself via "Install for Me")' ,
                //html: true,
                //                    timer: 2000,
                //icon: "warning",
                imageUrl: "images/error.png",
                imageWidth: 50,
                showConfirmButton: true
            });
        }
    }

    $(document).on('shown.bs.tab', 'a[data-toggle="tab"]', function (e) {

        if($(e.target).attr('href')==='#srvpublish'){
            $('#buttonpanelrsrv').hide();
        } else {
            $('#buttonpanelrsrv').show();
        }
    });
</script>
