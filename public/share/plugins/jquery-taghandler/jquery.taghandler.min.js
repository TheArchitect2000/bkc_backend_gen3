!function(a){function c(a,b,c){var d=!1;return jQuery.each(b,function(b,e){if(c||(e=e.toLowerCase(),a=a.toLowerCase()),e===a)return d=!0,!1}),d}function d(a,b){return jQuery.each(b,function(c,d){d===a&&b.splice(c,1)}),b}function e(b,c,e,f){return e.assignedTags.push(c),e.availableTags=d(c,e.availableTags),a("<li />").addClass("tagItem").text(c).insertBefore(a(b).parent()),f&&(e=g(e)),e}function f(b,e,f,h){var i=a(b).text();return e.assignedTags=d(i,e.assignedTags),c(i,e.originalTags,h)&&e.availableTags.push(i),a(b).remove(),f&&(e=g(e)),e}function g(a){return a.availableTags=a.availableTags.sort(),a.assignedTags=a.assignedTags.sort(),a.originalTags=a.originalTags.sort(),a}function h(b,c,d){var e={tags:b.assignedTags};a.extend(e,c.updateData),a.ajax({type:"POST",url:c.updateURL,cache:!1,data:e,dataType:"json",beforeSend:function(){a("#"+d+"_save").length?a("#"+d+"_save").fadeOut(200,function(){a("#"+d+"_loader").fadeIn(200)}):a("#"+d+"_loader").fadeIn(200)},complete:function(){a("#"+d+"_loader").fadeOut(200,function(){a("#"+d+"_save").length&&a("#"+d+"_save").fadeIn(200)})}})}function i(b,c,e,f){return a(c.assignedTags).each(function(g,h){b.allowEdit?a("<li />").addClass("tagItem").text(h).insertBefore(a(e).parent()):a("<li />").addClass("tagItem").css("cursor","default").text(h).appendTo(a(f)),c.availableTags=d(h,c.availableTags)}),c}function j(b,c){c.debug&&window.console&&window.console.log&&(window.console.log(b),window.console.log(c),window.console.log(a.fn.tagHandler.defaults))}var b={getSerializedTags:function(){var b=[];return a(this).find("li.tagItem").each(function(c,d){b.push(a(d).text())}),b.join(",")},getTags:function(){var b=[];return a(this).find("li.tagItem").each(function(c,d){b.push(a(d).text())}),b},version:function(){return"1.3.2"}};a.fn.tagHandler=function(d){if("object"==typeof d||"undefined"==typeof d){var k=a.extend({},a.fn.tagHandler.defaults,d);return j(a(this),k),this.each(function(){if(!a(this).is("ul"))return!0;var b=this,d=a(b);if(!b.id){var l=new Date;b.id=l.getTime()}d.wrap('<div class="'+k.className+'" />'),d.addClass(k.className+"Container"),k.allowEdit&&d.html('<li class="tagInput"><input class="tagInputField" type="text" /></li>');var m=d.find(".tagInputField"),n=[];return n.availableTags=[],n.originalTags=[],n.assignedTags=[],""!==k.updateURL&&(k.autoUpdate||a("<div />").attr({id:b.id+"_save",title:"Save Tags"}).addClass("tagUpdate").click(function(){h(n,k,b.id)}).appendTo(d.parent()),a("<div />").attr({id:b.id+"_loader",title:"Saving Tags"}).addClass("tagLoader").appendTo(d.parent())),""!==k.getURL&&k.initLoad?a.ajax({url:k.getURL,cache:!1,data:k.getData,dataType:"json",success:function(c,d,e){c.availableTags.length&&(n.availableTags=c.availableTags.slice(),n.originalTags=n.availableTags.slice()),k.sortTags&&(n=g(n)),c.assignedTags.length&&(n.assignedTags=c.assignedTags.slice(),k.sortTags&&(n=g(n)),n=i(k,n,m,b)),k.autocomplete&&"function"==typeof a.fn.autocomplete&&k.allowEdit&&a(m).autocomplete("option","source",n.availableTags)},error:function(a,b,c){j(a,b,c),alert(k.msgError)}}):""!==k.getURL?(n.assignedTags=k.assignedTags.slice(),k.sortTags&&(n=g(n)),n=i(k,n,m,b)):(k.availableTags.length&&(n.availableTags=k.availableTags.slice(),n.originalTags=n.availableTags.slice()),k.sortTags&&(n=g(n)),k.assignedTags.length&&(n.assignedTags=k.assignedTags.slice(),k.sortTags&&(n=g(n)),n=i(k,n,m,b)),k.autocomplete&&"function"==typeof a.fn.autocomplete&&k.allowEdit&&k.initLoad&&a(m).autocomplete("option","source",n.availableTags)),k.allowEdit&&(d.delegate("li.tagItem","click",function(){var c=a(this),d=1;"function"==typeof k.onDelete&&(d=k.onDelete.call(this,a.trim(c.text()))),d&&(n=f(c,n,k.sortTags,k.caseSensitive),""!==k.updateURL&&k.autoUpdate&&h(n,k,b.id)),"function"==typeof k.afterDelete&&k.afterDelete.call(this,a.trim(c.text())),k.autocomplete&&"function"==typeof a.fn.autocomplete&&k.initLoad&&a(m).autocomplete("option","source",n.availableTags)}),a(m).keypress(function(d){var f=a(this);if((13===d.which||44===d.which||d.which===k.delimiter.charCodeAt(0))&&(d.preventDefault(),""!==f.val()&&!c(a.trim(f.val()),n.assignedTags,k.caseSensitive))){if(!k.allowAdd&&!c(a.trim(f.val()),n.availableTags,k.caseSensitive))return void alert(k.msgNoNewTag);if(k.maxTags>0&&n.assignedTags.length>=k.maxTags)alert("Maximum tags allowed: "+k.maxTags);else{var g=a.trim(f.val()),i=1;"function"==typeof k.onAdd&&(i=k.onAdd.call(this,g)),(i||"undefined"==typeof i)&&(n=e(this,g,n,k.sorttags),""!==k.updateURL&&k.autoUpdate&&h(n,k,b.id),k.autocomplete&&"function"==typeof a.fn.autocomplete&&k.initload&&a(m).autocomplete("option","source",n.availableTags),"function"==typeof k.afterAdd&&k.afterAdd.call(this,g))}f.val(""),f.focus()}}),a(m).keydown(function(c){var e=a(this);if(8===c.which&&""===e.val()){var g=d.find(".tagItem:last").text();"function"==typeof k.onDelete&&k.onDelete.call(this,a.trim(g)),n=f(d.find(".tagItem:last"),n,k.sortTags,k.caseSensitive),""!==k.updateURL&&k.autoUpdate&&h(n,k,b.id),"function"==typeof k.afterDelete&&k.afterDelete.call(this,a.trim(g)),k.autocomplete&&"function"==typeof a.fn.autocomplete&&k.initLoad&&a(m).autocomplete("option","source",n.availableTags),e.focus()}}),k.autocomplete&&"function"==typeof a.fn.autocomplete&&k.initLoad?a(m).autocomplete({source:n.availableTags,select:function(d,f){var g=a(this);if(!c(a.trim(f.item.value),n.assignedTags,k.caseSensitive)){if(k.maxTags>0&&n.assignedTags.length>=k.maxTags)alert("Maximum tags allowed: "+k.maxTags);else{var i=a.trim(f.item.value),j=1;"function"==typeof k.onAdd&&(j=k.onAdd.call(this,i)),(j||"undefined"==typeof j)&&(n=e(this,i,n,k.sortTags),""!==k.updateURL&&k.autoUpdate&&h(n,k,b.id),a(m).autocomplete("option","source",n.availableTags),"function"==typeof k.afterAdd&&k.afterAdd.call(this,i))}g.focus()}return g.val(""),!1},minLength:k.minChars}):k.autocomplete&&"function"==typeof a.fn.autocomplete&&a(m).autocomplete({source:function(b,c){k.getData[k.queryname]=b.term;a.getJSON(k.getURL,k.getData,function(a,b,d){c(a.availableTags)})},select:function(d,f){var g=a(this);if(!c(a.trim(f.item.value),n.assignedTags,k.caseSensitive)){if(k.maxTags>0&&n.assignedTags.length>=k.maxTags)alert("Maximum tags allowed: "+k.maxTags);else{var i=a.trim(f.item.value),j=1;"function"==typeof k.onAdd&&k.onAdd.call(this,i),(j||"undefined"==typeof j)&&(n=e(this,a.trim(f.item.value),n,k.sortTags),""!==k.updateURL&&k.autoUpdate&&h(n,k,b.id),"function"==typeof k.afterAdd&&k.afterAdd.call(this,i))}g.focus()}return g.val(""),!1},minLength:k.minChars}),a(m).focus(function(){""===a(m).val()&&k.autocomplete&&"function"==typeof a.fn.autocomplete&&k.initLoad&&a(m).autocomplete("search","")}),d.click(function(){a(m).focus()})),this.getTags=function(){return n.assignedTags},1})}if("string"==typeof d&&b[d])return b[d].apply(this,Array.prototype.slice.call(arguments,1))},a.fn.tagHandler.defaults={allowEdit:!0,allowAdd:!0,assignedTags:[],autocomplete:!1,autoUpdate:!1,availableTags:[],caseSensitive:!0,className:"tagHandler",debug:!1,delimiter:"",getData:{},getURL:"",initLoad:!0,maxTags:0,minChars:0,msgNoNewTag:"You don't have permission to create a new tag.",msgError:"There was an error getting the tag list.",onAdd:{},onDelete:{},afterAdd:{},afterDelete:{},queryname:"q",sortTags:!0,updateData:{},updateURL:""}}(jQuery);
