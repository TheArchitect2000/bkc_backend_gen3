<!--<script async defer type="text/javascript" src="js/map.js"></script>-->
<!--<script async defer type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?key1=YOUR_API_KEY&callback=initMap&libraries=places"></script>-->
<head>
    <!--<link href="../../share/plugins/jquery-taghandler/jquery.taghandler.css" rel="stylesheet">-->
    <!--<script src="../../share/plugins/jquery-taghandler/jquery.taghandler.min.js"></script>-->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.6/ace.js" type="text/javascript" charset="utf-8"></script>-->
    <script src="../../share/plugins/ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../share/js/ssicon-picker.js"></script>
    <link href="../../share/css/ssicon-picker.css" rel="stylesheet"/>
    <script>
        //icon to base64:
        // Check for the File API support.
        var devticonbase64 = '';
        var devticonvalid = true;
        var devticonmessage = '';

        if (window.File && window.FileReader && window.FileList && window.Blob) {
            document.getElementById('devticonfile').addEventListener('change', handleFileSelect, false);
        } else {
            alert('The File APIs are not fully supported in this browser.');
        }

        function handleFileSelect(evt) {
            var f = evt.target.files[0]; // FileList object
            if (!f.type.startsWith('image')) {
                let iconimg = document.getElementById('devticonpreview');
                iconimg.src = defaulticon;
                devticonbase64 = '';
                devticonmessage = 'Bad file type is selected, please select a true image file with extension .SVG';
                swal.fire({
                    title: 'Device Type Icon',
                    text: devticonmessage,
                    //html: true,
                    timer: 3000,
//                    icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            var reader = new FileReader();
            // Closure to capture the file information.
            reader.onload = (function (theFile) {
                return function (e) {
                    var binaryData = e.target.result;
                    //Converting Binary Data to base 64
                    var base64String = window.btoa(binaryData);
                    //showing file converted to base64
                    devticonbase64 = 'data:image/svg+xml;base64,' + base64String;
                    let iconimg = document.getElementById('devticonpreview');
                    $('#devticonpreview').removeClass('img-responsive');
                    iconimg.src = devticonbase64;
                    setTimeout(() => iconFileChanged(iconimg), 200);
                };
            })(f);
            // Read in the image file as a data URL.
            reader.readAsBinaryString(f);
        }

        function iconFileChanged(iconimg) {
            console.log('devticonbase64', iconimg.clientWidth, iconimg.clientHeight);

            $('#iconwidth').text(iconimg.clientWidth);
            $('#iconheight').text(iconimg.clientHeight);

            devticonvalid = true;
            devticonmessage = '';
            /*if(iconimg.clientWidth != iconimg.clientHeight) {
             devticonvalid = false;
             devticonmessage = 'Width and Height of icon must be equal'
             }*/
            /*if (iconimg.clientWidth > 512 || iconimg.clientHeight > 512) {
                devticonvalid = false;
                devticonmessage = 'Width and Height of icon must be <= 512 px'
            }*/

            $('#devticonpreview').addClass('img-responsive');

            if (!devticonvalid) {
                swal.fire({
                    title: 'Device Type Icon',
                    text: devticonmessage,
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
            }
        }
    </script>
    <link rel="stylesheet" href="../../share/plugins/jquery-tagmanager/tagmanager.css">
    <script src="../../share/plugins/jquery-tagmanager/tagmanager.js"></script>
</head>
<script>
    function updateIADeviceType() {
        var nsrv = {};
        var isvalid = true;
        var validatemessage = '';
        var messagetitle = '';

        nsrv.Published = document.querySelector('#devtpublished').checked;

        if (!document.querySelector('#devicetype').checkValidity()) {
            isvalid = false;
            validatemessage = document.querySelector('#devicetype').validationMessage;
            messagetitle = "Device Type";
        } else if (document.querySelector('[name="Description"]').value === '' && nsrv.Published) {
            isvalid = false;
            validatemessage = 'Please describe your devicetype briefly by filling Description field';
            messagetitle = "Description";
            $('.nav-tabs a[href="#devtmain"]').tab('show');
            $('#description').focus();
        }
        /*else if (!document.querySelector('#priceadd').checkValidity()) {
         isvalid = false;
         validatemessage = document.querySelector('#priceadd').validationMessage;
         messagetitle = "Install Price";
         } else if (!document.querySelector('#pricerun').checkValidity()) {
         isvalid = false;
         validatemessage = document.querySelector('#pricerun').validationMessage;
         messagetitle = "Run Price";
         }*/

        if (!isvalid) {
            swal.fire({
                title: messagetitle,
                text: validatemessage,
                //html: true,
                //                    timer: 2000,
                //icon: "warning",
                imageUrl: "images/error.png",
                imageWidth: 50,
                showConfirmButton: true
            });
            return;
        }

        if (!devticonvalid) {
            swal.fire({
                title: 'Device Type Icon',
                text: devticonmessage,
                //html: true,
                //                    timer: 2000,
                //icon: "warning",
                imageUrl: "images/error.png",
                imageWidth: 50,
                showConfirmButton: true
            });
            return;
        }

        nsrv.DeviceType = $('#devicetype').val();
        nsrv.DeviceName = $('#devicename').val();
        nsrv.Type = $('#type').val();
        nsrv.Description = $('#description').val();

//        nsrv.Cron = document.querySelector('#cron').checked;
//        nsrv.Copyright = document.querySelector('#copyright').value;
//        nsrv.Category = document.querySelector('#category').value;

        nsrv.Data = newdevicetype.Data;

        if(nsrv.Type==='ACTUATOR') {
            nsrv.Commands = newdevicetype.Commands;
            nsrv.CommandType = $('#CommandType').val();
            nsrv.Controllers = controllers_.getValue();
        }
        /*nsrv.Blockly = {
         Blocks : blocks_.getValue(),
         JavaScript : blocksjs_.getValue()
         };*/
        /*nsrv.NeedAccesses = Array.from(document.querySelectorAll('input[name="srvaccess"][type="checkbox"]'))
         .filter((checkbox) => checkbox.checked)
         .map((checkbox) => checkbox.value);*/
        nsrv.Icon = devticonbase64;
        nsrv.Iconpadding = false;

        /*nsrv.Price = {
         Add: $('#priceadd').val(),
         Run: $('#pricerun').val()
         };*/


        console.log('new devicetype', nsrv);

        $.ajax({
            url: '/iadevicetype/' + newdevicetype._id,
            data: nsrv,
//            async: !1,
            type: "put",
            dataType: "json",
            success: function (response) {
                swal.fire("Success", "", "success", {
//                button: "OK",
                    content: document.getElementById('successid')
                }).then((value) => {
                    //window.location = '/customer/logout'
                });
            },
            error: function (xhr, ajaxOptions, thrownError) {
                console.error(xhr, ajaxOptions, thrownError);
//                alert(thrownError + " - " + ajaxOptions);
            }
        }).fail(function (response) {
            swal.fire("Error", response.responseJSON.message, "error");
        });
    }

    function deleteIADeviceType() {
        swal.fire({
            title: "Attention", html: "Do you want to delete this device-type?", //icon: "warning",
            imageUrl: "images/error.png",
            imageWidth: 50,
            showCancelButton: true,
            confirmButtonText: 'Delete'
        }).then((result) => {
            if (result.value) {
                $.ajax({
                    url: '/iadevicetype/' + olddevicetype._id,
                    type: 'DELETE',
                    success: function (result) {
                        swal.fire({
                            title: "Device Type Deleted",
                            html: "Device Type removed successfully",
//                    timer: 2000,
                            icon: "success",
                            showConfirmButton: true
                        });
                        show_sspage("/vendor/views/iadevicetype.vendor.list.view.html")
                    }
                });
            }
        });
    }
</script>
<style type="text/css" media="screen">
    #editor {
        /*position: absolute;*/
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        height: 200px;
        font-size: inherit;
    }

    .devicetypesection {
        outline: 3px solid #d42021;
    }

    a.srvpublish {
        border: 2px solid green;
        border-radius: 20px;
    }

    .devicetype.nav-tabs > li.active > a, .nav-tabs > li.active > a:hover, .nav-tabs > li.active > a:focus {
        background-color: transparent !important;
    }

    .bg-black {
        background-color: #282828 !important;
    }

    .table1 {
        width: 70%;
    }

    @media (max-width: 767px) {
        .table1 {
            width: 100%;
        }
    }

    .table1 th.col1 {
        width: 40%;
    }

    .table1 th.col2 {
        width: 30%;
    }

    .table1 th.colbtn {
        width: 10%;
    }

    .col1 input, .col2 input, .col2 select {
        width: 90% !important;
    }
</style>
<!--<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js"></script>-->
<!--uses ssbind and sspage tags-->
<div class="collapse hidden">
    <div id="successid">Changes saved.</div>
</div>
<div class="card  m-t--30 m-r--15 m-l--15 m-b-0" style="height: calc(100vh - 70px)" id="devinfoload"
     sspage-load-json="/iadevicetype/[sspagesearch.id]" sspage-load-json-var="olddevicetype"
     sspage-load-after="initPage()">
    <div class="header m-b--10">
        <span class="ia-medium-title " ssbind="text:newdevicetype.DeviceType">
        </span> <span class="ia-medium-title "></span>

        <ul class="header-dropdown ">
            <!--<a href="#devtpublish" data-toggle="tab" aria-expanded="true"
               class="btn col-green btn-link srvpublish m-t&#45;&#45;10">Publish</a>-->
            <li class="dropdown">
                <a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button"
                   aria-haspopup="true" aria-expanded="false">
                    <i class="material-icons">more_vert</i>
                </a>
                <ul class="dropdown-menu pull-right">
                    <li><a href="javascript:deleteIADeviceType(); void(0);" class=" waves-effect waves-block col-red"

                    >Delete Device Type</a></li>
                </ul>
            </li>
        </ul>
    </div>
    <div class="body ">
        <!-- Nav tabs -->
        <ul class="nav nav-tabs tab-col-red devicetype" role="tablist">
            <li role="presentation" class="active">
                <a href="#devtmain" data-toggle="tab" aria-expanded="true">
                    <!--<i class="mdi mdi-home "></i> -->Profile
                </a>
            </li>
            <li role="presentation" class="">
                <a href="#devtdata" data-toggle="tab" aria-expanded="false">
                    Data
                </a>
            </li>
            <li role="presentation" class="hidden" ssif="olddevicetype.Type=='ACTUATOR'">
                <a href="#devtcommands" data-toggle="tab" aria-expanded="false">
                    Commands
                </a>
            </li>
            <li role="presentation" class="hidden" ssif="olddevicetype.Type=='ACTUATOR'">
                <a href="#devtcontrollers" data-toggle="tab" aria-expanded="false">
                    Controllers
                </a>
            </li>
            <li role="presentation" class="">
                <a href="#devtfirmware" data-toggle="tab" aria-expanded="false">
                    Firmware
                </a>
            </li>
            <li role="presentation" class="">
                <a href="#devtpublish" data-toggle="tab" aria-expanded="false">
                    Publish
                </a>
            </li>
            <!--
            <li role="presentation" class="">
                <a href="#devtcode" data-toggle="tab" aria-expanded="false">
                    Blockly
                </a>
            </li>
            <li role="presentation" class="">
                <a href="#devtpayment" data-toggle="tab" aria-expanded="false">
                    Payment
                </a>
            </li>
            <li role="presentation" class="">
                <a href="#devtsetting" data-toggle="tab" aria-expanded="false">
                    Settings
                </a>
            </li>-->
        </ul>

        <!-- Tab panes -->
        <div class="tab-content ">
            <div role="tabpanel" class="tab-pane fade active in" id="devtmain">
                <!--<b class="ia-big-title">Main Information of IA Device Type</b>-->
                <div class="row">
                    <div class="col-sm-4">
                        <!--<label for="name"><span class=" ia-big-title col-red">Name of Device Type</span></label>-->
                        <label class="form-label" for="devicetype">Device Type</label>
                        <div class="form-group form-float">
                            <div class="form-line">
                                <input type="text" name="DeviceType" id="devicetype" placeholder="An unique code"
                                       class="form-control" required
                                       onchange="this.value=this.value.trim().toUpperCase().replaceAll(' ','_').replaceAll('-','_')"
                                       ssbind="value:olddevicetype.DeviceType">

                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <!--<label for="name"><span class=" ia-big-title col-red">Name of Device Type</span></label>-->
                        <label class="form-label" for="devicename">Device Type Name</label>
                        <div class="form-group form-float">
                            <div class="form-line">
                                <input type="text" name="DeviceName" id="devicename"
                                       minlength="5" maxlength="30" placeholder="Device Type Name" class="form-control" required
                                       onchange="this.value=this.value.trim()" ssbind="value:olddevicetype.DeviceName">
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <label class="form-label" for="type">Type</label>
                        <div class="form-group form-float">
                            <div class="form-line">
                                <select class="form-control"
                                        id="type">
                                    <option ssfor="DeviceType_Types"
                                            ssbind="text:DeviceType_Types[ssIndex]; value:DeviceType_Types[ssIndex]; selected:DeviceType_Types[ssIndex]==olddevicetype.Type"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12">
                        <label class="form-label" for="description">Description</label>
                        <div class="form-group form-float">
                            <div class="form-line">
                                            <textarea type="text" name="Description" id="description"
                                                      ssbind="value:newdevicetype.Description"
                                                      class="form-control"
                                                      placeholder="Describe your devicetype here ..."
                                                      rows="3"></textarea>
                            </div>
                        </div>
                    </div>


                    <div class="col-sm-3">
                        <label for="devticonfile">Logo</label><br>
                        <small class="col-grey">Add an Icon or Logo for your devicetype</small>
                        <div class="form-group form-float">
                            <div class="devicetype">
                                <input type="file" accept="image/svg+xml" id="devticonfile"
                                       class="form-control"
                                       required style="background-color: transparent;">
                            </div>
                        </div>
                        <small class="col-grey">Your file must be .SVG format,<br>Recommended size is 512x512
                            pixels.
                        </small>
                    </div>
                    <div class="col-sm-2 devicetype">

                        <label for="devticonfile" id="drop-area"><img id="devticonpreview" class="img-responsive b-1"
                                                                      ssbind="src:olddevicetype.Icon || defaulticon"></label>
                        <div class="text-center hidden"><span id="iconwidth">512</span> X <span
                                id="iconheight">512</span>
                        </div>


                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade row" id="devtdata">
                <div class="col-sm-12">
                    <b class=" ia-big-title col-red">Device Data</b>
                    <div class="col-grey m-t--5">The data this device sends in its payloads</div>
                    <div class="form-group form-float m-t-5">
                        <table class="table1">
                            <thead>
                            <tr>
                                <th>Icon</th>
                                <th>Data Name</th>
                                <th>Data Type</th>
                                <th>Data Values</th>
                                <th>Unit</th>
                                <th>Option</th>
                            </tr>

                            </thead>
                            <tr ssfor="newdevicetype.Data" sslevel="devtdata" class="b-t-1">
                                <td sslevel="devtdata" ssbind="class: newdevicetype.Data[ssIndex].iconclass"></td>
                                <td sslevel="devtdata" ssbind="text: newdevicetype.Data[ssIndex].Name"></td>
                                <td sslevel="devtdata" ssbind="text:newdevicetype.Data[ssIndex].Type"></td>
                                <td sslevel="devtdata" ssbind="text:newdevicetype.Data[ssIndex].Enum"></td>
                                <td sslevel="devtdata" ssbind="text:newdevicetype.Data[ssIndex].Unit || ''"></td>
                                <td sslevel="devtdata" ssbind="text:newdevicetype.Data[ssIndex].isOption?'✔':''" class="text-center"></td>
                                <td>
                                    <div class="btn btn-link col-red"
                                         onclick="newdevicetype.Data.splice(ssIndex,1); ssbindRenderLevel('devtdata');updateDataSample();">
                                        <i class="material-icons">delete</i>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn btn-link col-red"
                                         onclick="selectAData(ssIndex)">
                                        <i class="material-icons">edit</i>
                                    </div>
                                </td>
                            </tr>

                            <tr class="bg-silver">
                                <th>
                                    <div class="col-black font-25 ">
                                        <div ssicon-picker="icon-list" class="mdi mdi-arrow-down-drop-circle-outline col-red" id="newicon"></div>
                                        <div ssicon-picker-list id="icon-list" class="ssiconpickerlist"></div>
                                    </div>
                                </th>
                                <th style="white-space: nowrap" class=" col1 p-b-5 p-t-5" nowrap="1">
                                    <input style="width: 90%;"
                                           type="text" id="newdataname" class="form-control inline b-1"
                                           required placeholder="Data item name in payload. i.e. 'state'"
                                           onchange="this.value=this.value.trim()"
                                    >
                                </th>
                                <th class="col2">
                                    <select class="form-control text-capitalize b-1" id="newdatatype">
                                        <option ssnextlevel="devtdata" ssfor="vartypes with vtIndx vtObj"
                                                ssbind="text:vartypes[vtIndx]; value:vartypes[vtIndx]"></option>
                                    </select>
                                </th>
                                <th class="col1">
                                    <input style="width: 90%;"
                                           type="text" id="newdatavalues" class="form-control inline b-1"
                                           required placeholder="Write then Press Enter">
                                </th>
                                <th>
                                    <input style="width: 50px !important;"
                                           type="text" id="newdataunit" class="form-control inline b-1"
                                           placeholder="Unit">
                                </th>
                                <th style="padding: 15px 0 0 15px">
                                    <input style=""
                                           type="checkbox" id="newdataoption" class="filled-in chk-col-red">
                                    <label for="newdataoption"></label>
                                </th>

                                <th class="colbtn">
                                    <div class="btn bg-red " id="addData">
                                        <i class="material-icons">add</i>
                                    </div>
                                    <div class="btn bg-red collapse" id="editData">
                                        <i class="material-icons">check</i>
                                    </div>
                                </th>
                                <td>
                                    <div id="cancelData" class="btn btn-link col-red"
                                         onclick="cancelEditData()">
                                        <i class="material-icons">close</i>
                                    </div>
                                </td>
                            </tr>
                        </table>

                        <div class=""><h6>Sample payload this device could send :</h6><code
                                id="datasample"></code></div>
                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade row" id="devtcommands">
                <div class="col-sm-12">
                    <b class=" ia-big-title col-red">Commands</b>
                    <br>
                    <small class="col-grey">Commands which can be send to this device and the device could reactions to
                        them
                    </small>
                    <div class="form-group form-float m-t-5">
                        <table class="table1">
                            <thead>
                            <tr>
                                <th>Command</th>
                                <th>Title</th>
                                <th>Done State</th>
                            </tr>
                            </thead>
                            <tr ssfor="newdevicetype.Commands" sslevel="devtcommands" class="b-t-1">
                                <td sslevel="devtcommands" ssbind="text:newdevicetype.Commands[ssIndex].Command"></td>
                                <td sslevel="devtcommands" ssbind="text:newdevicetype.Commands[ssIndex].Title"></td>
                                <td sslevel="devtcommands" ssbind="text:newdevicetype.Commands[ssIndex].State"></td>
                                <td>
                                    <div class="btn btn-link col-red"
                                         onclick="newdevicetype.Commands.splice(ssIndex,1); ssbindRenderLevel('devtcommands');updateCommandsSample()">
                                        <i class="material-icons">delete</i>
                                    </div>
                                </td>
                            </tr>

                            <tr class="bg-silver">
                                <th style="white-space: nowrap" class="col1 p-b-5 p-t-5" nowrap="1">&nbsp;<input
                                        style="border: 1px solid grey;"
                                        type="text" id="newcommand" class="form-control inline"
                                        required placeholder="command" onchange="this.value=this.value.trim()">
                                </th>
                                <th style="white-space: nowrap" class="col2" nowrap="1"><input
                                        style="width: 93%;border: 1px solid grey;"
                                        type="text" id="newcommandtitle" class="form-control inline"
                                        required placeholder="Command Title" onchange="this.value=this.value.trim()">
                                </th>
                                <th style="white-space: nowrap" class="col2" nowrap="1"><input
                                        style="width: 93%;border: 1px solid grey;"
                                        type="text" id="newcommandstate" class="form-control inline"
                                        required placeholder="Done State" onchange="this.value=this.value.trim()">
                                </th>
                                <th class="colbtn">
                                    <div class="btn bg-red" id="addCommand">
                                        <i class="material-icons">add</i>
                                    </div>
                                </th>
                            </tr>
                        </table>
                        <div class=" ">
                            <h6>Sample command payload(s) which this device could receive to run :</h6>
                            <code id="commandsample"></code>
                        </div>
                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="devtcontrollers">
                <div class="">
                    <b class=" ia-big-title col-red">Controllers</b>

                    <div class="">
                        <label class="form-label" for="CommandType">Command Type</label>
                        <div class="form-group form-float">
                            <div class="form-line">
                                <select class="form-control" id="CommandType">
                                    <option ssfor="commandtypes" ssbind="text:commandtypes[ssIndex];value:commandtypes[ssIndex];selected:commandtypes[ssIndex]===olddevicetype.CommandType"></option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <b class=" ia-big-title col-red">Extra Controllers</b>

                    <div class="ace-solarized_dark" style="height: 40vh">
                        <div id="controllers" style="height: 25vh" ssbind="html:newdevicetype.Controllers">
                        </div>
                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="devtfirmware">
                <b class=" ia-big-title col-red">Firmware</b>
                <div class="row m-t-20">
                    <div class="col-sm-2">Current Version</div>
                    <div class="col-sm-4 ia-medium-title " ssbind="html:newdevicetype.OTA.Version?'<b class=col-red>'+newdevicetype.OTA.Version+'</b>' : '<i class=col-grey>Not any Firmware uploaded</i>'"></div>
                    <div class="col-sm-2">Current Series</div>
                    <div class="col-sm-4 ia-medium-title " ssbind="html:newdevicetype.OTA.Series?'<b class=col-red>'+newdevicetype.OTA.Series+'</b>' : ''"></div>
<!--                    <div class="col-sm-2" ssif="newdevicetype.OTA.Version">Upload Time</div>-->
<!--                    <div class="col-sm-4" ssif="newdevicetype.OTA.Version" ssbind="text:newdevicetype.OTA.Time || ''"></div>-->
                </div>

                <div class=" p-b-0 p-t-5" ssif="newdevicetype.OTA.Version">
                    <h4>Uploaded Firmwares</h4>
                    <div class="b-1 col-grey p-l-20 p-t-10 p-b-10" style="height: 20vh; overflow-y: auto; overflow-x: hidden">
                        <div class="row" ssfor="newdevicetype.OTA.Releases" ssemptylist="Not any firmware uploaded" sslevel="firmwares">
                            <div class="col-sm-2" ssbind="text:'Series: '+(newdevicetype.OTA.Releases[ssIndex].Series||'')" sslevel="firmwares"></div>
                            <div class="col-sm-2" ssbind="text:'Version: '+newdevicetype.OTA.Releases[ssIndex].Version" sslevel="firmwares"></div>
                            <div class="col-sm-3" ssbind="text:'Time: '+newdevicetype.OTA.Releases[ssIndex].Time" sslevel="firmwares"></div>
                            <div class="col-sm-4" ssbind="text:'By: '+ (newdevicetype.OTA.Releases[ssIndex].CustomerId ? newdevicetype.OTA.Releases[ssIndex].CustomerId.FirstName+' '+newdevicetype.OTA.Releases[ssIndex].CustomerId.LastName : '?')" sslevel="firmwares"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-silver m-t-15 p-b-0  p-l-10 p-r-10 col-black" >
                    <h4 class="btn btn-default btn-link ia-small-title m-b-10" onclick="$('#uploadfirmwarepan').toggle()">Upload New</h4>


                    <div class="row m-t-15 collapse" id="uploadfirmwarepan">
                        <!--<button type="button" class="close" aria-label="Close" data-target="#uploadfirmwarepan" data-dismiss="alert">
                            <span aria-hidden="true">&times;</span>
                        </button>-->
                        <div class="col-sm-2">
                            <div class="input-group input-group-lg">
                                <label class="form-label">Series</label>
                                <div class="">
                                    <input type="number" class="form-control devicename" onchange="$('[name=Series]').val(this.value)"
                                           id="Series"
                                           size="10"
                                           required
                                           min="1"
                                           ssbindXX="min:newdevicetype.OTA.Version+1 || 1;max:newdevicetype.OTA.Version+1 || 1000;value:newdevicetype.OTA.Version+1 || 1"
                                           max="10"
                                           maxlength="1"
                                           minlength="1"
                                           pattern1="[0-9]*"
                                           placeholder="Series">
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class="input-group input-group-lg">
                                <label class="form-label">File Version</label>
                                <div class="">
                                    <input type="number" class="form-control devicename" onchange="$('[name=Version]').val(this.value)"
                                           id="Version"
                                           size="10"
                                           required
                                           min="1"
                                           ssbind="min:newdevicetype.OTA.Version+1 || 1;max:newdevicetype.OTA.Version+1 || 1000;value:newdevicetype.OTA.Version+1 || 1"
                                           max="100000"
                                           maxlength="4"
                                           minlength="1"
                                           pattern1="[0-9]*"
                                           placeholder="Set a version for file">
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-5">
                            <div class="input-group input-group-lg">
                                <label class="form-label">Firmware file</label>
                                <div class="">
                                    <form id="Firmware-form" method="post" enctype="multipart/form-data">
                                        <input name="Version" ssbind="value:newdevicetype.OTA.Version+1 || 1" type="hidden" ><!--"order of this input is very important prior to firm-file"-->
                                        <input name="Series" ssbind="value:0" type="hidden" ><!--"order of this input is very important prior to firm-file"-->
                                        <input name="DeviceType" id="DeviceTypeForm" type="hidden" ><!--"order of this input is very important prior to firm-file"-->
                                        <input name="firm-file" type="file" accept=".bin" id="Firmware-file" class="hidden" onchange="$('#Firmware-file-label').text(this.value || 'Choose .bin File')">
                                        <input name="folder" value="UPLD-folder" type="hidden">
                                        <label class="btn-link p-l-5 p-b-5 mdi mdi-file-find-outline mdi-18 form-control bg-white" style="font-size: 14px" for="Firmware-file" id="Firmware-file-label">
                                            Choose .bin File
                                        </label>
                                    </form>
                                </div>

                            </div>

                        </div>
                        <div class="col-sm-2">
                            <div class="input-group input-group-lg">
                                <label class="form-label">&nbsp;
                                    <progress max="100" value="0" id="uploadprogress" class="collapse"></progress>
                                </label>
                                <div class="">
                                    <button id="uploadbtn" class="btn btn-primary-ia btn-red" onclick="uploadFirmware()">Upload</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <!--<div role="tabpanel" class="tab-pane fade" id="devtcode">
                &lt;!&ndash;//code editor from https://ace.c9.io&ndash;&gt;
                <div class="">
                    <b class=" ia-big-title col-red">Blocks</b>

                    <div class="ace-solarized_dark" style="height: 25vh">
                        <div id="blocks" style="height: 25vh" ssbind="html:newdevicetype.Blockly.Blocks">
                        </div>
                    </div>
                </div>
                <div class="">
                    <b class=" ia-big-title col-red">Javascript</b>

                    <div class="ace-solarized_dark" style="height: 25vh">
                        <div id="blocksjs" style="height: 25vh" ssbind="html:newdevicetype.Blockly.JavaScript">
                        </div>
                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="devtpayment">
                &lt;!&ndash;//code editor from https://ace.c9.io&ndash;&gt;

                <br>
                <div class="row">
                    <div class="col-sm-5">
                        <label class="form-label ia-big-title col-red" for="priceadd">Install Price</label>
                        <div class="form-group form-float">
                            <small class="col-grey ">How many BKCs would be paid for Installing this devicetype?</small>
                            <div class="m-t-10 ">
                                <input type="number" min="0" max="100000" id="priceadd"
                                       class="form-control ia-bigger-title b-1  " required value="0"
                                       ssbind="value:olddevicetype.Price.Add" sslevel="oldserv">

                            </div>
                            &lt;!&ndash;<label for="priceadd" style=" position: relative;top: -28px;left: 70%; width: 50px;">BKC</label>&ndash;&gt;
                        </div>
                    </div>
                    <div class="col-sm-5">
                        <label class="form-label ia-big-title col-red" for="pricerun">Run Price</label>
                        <div class="form-group form-float">
                            <small class="col-grey">How many BKCs would be paid when every run of this devicetype?</small>
                            <div class="m-t-10">
                                <input type="number" min="0" max="100000" id="pricerun"
                                       class="form-control ia-bigger-title b-1 " required value="0"
                                       ssbind="value:olddevicetype.Price.Run" sslevel="oldserv">
                            </div>
                            &lt;!&ndash;<label for="pricerun" style=" position: relative;top: -28px;left: 70%; width: 50px;">BKC</label>&ndash;&gt;
                        </div>
                    </div>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="devtsetting">
                <div class="form-group form-float">
                    <div class="">
                        <b class=" ia-big-title col-red">Security</b>
                        <br>
                        <small class="col-grey">Which access need your new devicetype?<br><br></small>

                        <ul style="list-style: none">
                            <li ssfor="home_accesses" sslevel="srvaccess">
                                &lt;!&ndash;<input name="srvaccess" ssbind="value:home_accesses[ssIndex]" type="checkbox">
                                <span ssbind="text:home_accesses[ssIndex]"></span>&ndash;&gt;

                                &lt;!&ndash;<input type="checkbox" name="srvaccess" class="filled-in chk-col-red"
                                       sslevel="srvaccess"
                                       ssbind="id :'acc'+ssIndex; value:home_accesses[ssIndex]; checked: newdevicetype.NeedAccesses.indexOf(home_accesses[ssIndex])>-1">
                                <label ssbind="for:'acc'+ssIndex; text:home_accesses[ssIndex]" sslevel="srvaccess">Access</label>&ndash;&gt;
                            </li>
                        </ul>

                    </div>
                </div>
                <div class="form-group form-float">
                    <div class=" m-t-10">
                        <b class=" ia-big-title col-red">Schedule</b>
                        <br>
                        &lt;!&ndash;<small class="col-grey">Check if this devicetype runs schedully</small>&ndash;&gt;
                        &lt;!&ndash;<br><br>&ndash;&gt;
                        <ul>
                            <input type="checkbox" name="Cron" id="cron" class="filled-in chk-col-red"
                                   ssbind="checked: newdevicetype.Cron"
                                   value="true"> <label for="cron">This devicetype runs on the
                            schedule</label>
                        </ul>
                    </div>
                </div>
            </div>-->
            <div role="tabpanel" class="tab-pane fade" id="devtpublish">
                <b class=" ia-big-title col-red">Device Type Publish</b>
                <br>
                <!--<small class="col-grey">Taps are buttons in the devicetype box, Define them with their title and bind to a
                    function in code,
                </small>-->
                <div class="switch s">
                    <div class="body m-t-20">
                        If you want to publish this device type to every BKC user could see it in the <b>Add Device</b> page, please contact with us.
                    </div>
                    <label><span class="col-grey">Unpublished</span><input type="checkbox"
                                                                           ssbind="checked:newdevicetype.Published"
                                                                           id="devtpublished"><span
                            class="lever switch-col-green"></span><span class="col-green">Published</span> </label>
                </div>
                <div class="form-group form-float">
                    <div class="">
                        <table class=" ">
                            <thead>

                            </thead>
                            <tr ssfor="newdevicetype.Varee" sslevel="srvpublishes" class=" b-b-1">
                                <td sslevel="srvpublishes"
                                    ssbind="text:newdevicetype.Buttons[ssIndex].Title"></td>
                                <td sslevel="srvpublishes"
                                    ssbind="text:'-> '+newdevicetype.Buttons[ssIndex].Function+'()'"></td>
                                <td>
                                    <div class="btn btn-link col-red"
                                         onclick="newdevicetype.Buttons.splice(ssIndex,1); ssbindRenderLevel('devtcommands')">
                                        <i class="material-icons">close</i>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        <div class="text-right button-panXXX">
            <button class="btn btn-link col-red waves-effect-x2  align-right ia-big-title"
                    sspage="../vendor/views/iadevicetype.vendor.list.view.html">
                Back
            </button>
            <button class="btn btn-primary-ia waves-effect-x2 align-right ia-big-title"
                    onclick="updateIADeviceType()">
                Save Changes
            </button>
        </div>

    </div>
</div>

<script>
    var newdevicetype;
    var selectedData = null;

    function updateDataSample() {
        var sample = {};
        newdevicetype.Data.map((data) => {
            var val = null;
            if (data.Enum && data.Enum[0]) {
                val = data.Enum[0];
            }
            if (data.Type === 'NUMBER') {
                val = val ? parseInt(val) : "__NUMBER__";
            } else if (data.Type === 'BOOLEAN') {
                val = val ? parseInt(val) : "__BOOLEAN__";
            } else {
                val = val || "<font color=skyblue>a value</font>";
            }
            sample[data.Name] = val;
        });
        $('#datasample').html(JSON.stringify(sample, '  ', ' ').replaceAll('"__NUMBER__"', '<font color=skyblue>a number</font>').replaceAll('"__BOOLEAN__"', '<font color=skyblue>true/false</font>'));
    }

    function updateCommandsSample() {
        var sample_ = "";
        if (newdevicetype.Commands.length > 1) {
            newdevicetype.Commands.map((command) => {
                var sample = {command: command.Command};

                if (sample_ !== "")
                    sample_ += "<br><br>";

                sample_ += JSON.stringify(sample, '  ', ' ');
            })
        } else {
            var command = (newdevicetype.Commands && newdevicetype.Commands[0]) ? newdevicetype.Commands[0].Command : '<font color=skyblue>any text</font>';
            var sample = {command: command};
            sample_ = JSON.stringify(sample, '  ', ' ');
        }


        $('#commandsample').html(sample_);
    }

    //    var blocks_, blocksjs_;
    var controllers_;
    function initPage() {
        console.log('initpage======================');
        newdevicetype = {
            Data: [],
            Commands: [],
            CommandType: "none",
            Controllers: "",
            Blockly: {Blocks: "", JavaScript: ""}
        };

        if (typeof olddevicetype !== 'undefined') {
            Object.assign(newdevicetype, olddevicetype)
        }
        if (!newdevicetype.Commands) newdevicetype.Commands = [];
        if (!newdevicetype.Data) newdevicetype.Data = [];
        devticonbase64 = newdevicetype.Icon || '';


        ssbindRender();

        $("#addData").click(() => {
            let name = $('#newdataname').val().trim();
            if (name === '') {
                swal.fire({
                    title: 'New Variable',
                    text: 'Please set a name for new variable!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            if (newdevicetype.Data.some(v => v.Name === name)) {
                swal.fire({
                    title: 'New Variable',
                    text: 'New variable name is duplicated!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            newdevicetype.Data.push({
                'Name': name,
                'Type': $('#newdatatype').val(),
                'Enum': [...$('#newdatavalues').tagsManager('tags')],
                'Unit': $('#newdataunit').val(),
                'isOption': document.querySelector('#newdataoption').checked,
                'iconclass': $('#newicon').prop('value')
            });
            $('#newdataname').val('');
            $('#newdatavalues').tagsManager('empty');
            $('#newdataunit').val('');
            $('#newdataunit').prop('checked',false);

            ssbindRenderLevel('devtdata');

            //create sample
            updateDataSample();
            sscicon_set('#newicon')
        });

        $("#editData").click(() => {
            let name = $('#newdataname').val().trim();
            if (name === '') {
                swal.fire({
                    title: 'New Variable',
                    text: 'Please set a name for new variable!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            if (newdevicetype.Data.some(v => (v.Name === name)&&(v !== newdevicetype.Data[selectedData]) )) {
                swal.fire({
                    title: 'Edit Variable',
                    text: 'Variable name is duplicated!',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            newdevicetype.Data[selectedData]={
                'Name': name,
                'Type': $('#newdatatype').val(),
                'Enum': [...$('#newdatavalues').tagsManager('tags')],
                'Unit': $('#newdataunit').val(),
                'isOption': document.querySelector('#newdataoption').checked,
                'iconclass': $('#newicon').prop('value')
            };
            $('#newdataname').val('');
            $('#newdatavalues').tagsManager('empty');
            $('#newdataunit').val('');
            $('#newdataunit').prop('checked',false);

            ssbindRenderLevel('devtdata');

            //create sample
            updateDataSample();

            sscicon_set('#newicon');

            //clear
            $('#editData').hide();
            $('#addData').show();
        });

//        $('#newcommand').change(()=>$('#newcommand').val($('#newcommand').val().trim().toUpperCase().replaceAll(' ','_').replaceAll('-','_')));
        $("#addCommand").click(() => {
            let command = $('#newcommand').val().trim()/*.toUpperCase().replaceAll(' ','_').replaceAll('-','_')*/;
            let title = $('#newcommandtitle').val().trim();
            let donestate = $('#newcommandstate').val().trim();
            /*if(name==='') {
             swal.fire({
             title: 'New Variable',
             text: 'Please set a name for new variable!',
             //html: true,
             //                    timer: 2000,
             icon: "warning",
             showConfirmButton: true
             });
             return;
             }*/
            if (command === '') {
                swal.fire({
                    title: 'Command',
                    text: 'Please set command word',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            if (title === '') {
                swal.fire({
                    title: 'Command',
                    text: 'Please set a title for command',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }
            /*if (donestate === '') {
             swal.fire({
             title: 'Command',
             text: 'Please set a function name for new Button!',
             //html: true,
             //                    timer: 2000,
             //icon: "warning",
             imageUrl: "images/error.png",
             imageWidth: 50,
             showConfirmButton: true
             });
             return;
             }*/
            if (newdevicetype.Commands.some(v => v.Command === command)) {
                swal.fire({
                    title: 'Command',
                    text: 'Command is duplicated',
                    //html: true,
                    //                    timer: 2000,
                    //icon: "warning",
                    imageUrl: "images/error.png",
                    imageWidth: 50,
                    showConfirmButton: true
                });
                return;
            }

            newdevicetype.Commands.push({
                'Command': command,
                'Title': $('#newcommandtitle').val(),
                'State': $('#newcommandstate').val()
            });
            $('#newcommand').val('');
            $('#newcommandtitle').val('');
            $('#newcommandstate').val('');
            ssbindRenderLevel('devtcommands');

            updateCommandsSample();
        });

        ssbindRenderLevel('devtcommands');
        ssbindRenderLevel('srvpublishes');
        ssbindRenderLevel('firmwares');
//        ssbindRenderLevel('srvaccess');
//        ssbindRenderLevel('oldserv');


        //drop-area
        var dropArea = document.getElementById('drop-area');

        dropArea.addEventListener('dragenter', handleFileSelect, false);
        dropArea.addEventListener('dragleave', handleFileSelect, false);
        dropArea.addEventListener('dragover', handleFileSelect, false);
        dropArea.addEventListener('drop', handleFileSelect, false);


        updateDataSample();
        updateCommandsSample();

        controllers_ = ace.edit("controllers");
        controllers_.session.setMode("ace/mode/javascript");

        /*blocks_ = ace.edit("blocks");
         blocksjs_ = ace.edit("blocksjs");
         //            blocks_.setTheme("ace/theme/solarized_dark");

         blocks_.session.setMode("ace/mode/javascript");
         blocksjs_.session.setMode("ace/mode/javascript");*/


    }

    //tag manager for newdatavalues input
    $('#newdatavalues').tagsManager();

    function selectAData(i){
        selectedData = i;
        $('#addData').hide();
        $('#editData').show();
        var data = newdevicetype.Data[i];
        $('#newdataname').val(data.Name);
        $('#newdatatype').val(data.Type);
        $('#newdatavalues').tagsManager('empty');
        for(var tag of data.Enum) {
            $('#newdatavalues').tagsManager('pushTag', tag);
        }
        $('#newdataunit').val(data.Unit);
        $('#newdataoption').prop('checked',data.isOption || false);
        sscicon_set('#newicon', data.iconclass);
    }

    function cancelEditData(){
        selectedData = null;
        $('#addData').show();
        $('#editData').hide();
        $('#newdataname').val('');
        $('#newdatavalues').tagsManager('empty');
        $('#newdataunit').val('');
        $('#newdataoption').prop('checked',false);
        sscicon_set('#newicon');
    }

    function uploadFirmware() {
        if (!$('#Version').val() || $('#Version').val() === 'UNKNOWN') {
            swal.fire({
                title: "Warning",
                html: 'Please set <b>file version</b>',
//                    timer: 2000,
//                icon: "warning",
                imageUrl: "images/error.png",
                imageWidth: 50,
                showConfirmButton: true
            });
            return;
        }
        if (!$('[name="firm-file"]').val() || $('[name="firm-file"]').val() === 'UNKNOWN') {
            swal.fire({
                title: "Warning",
                html: 'Please choose <b>a .bin file</b>',
//                    timer: 2000,
//                icon: "warning",
                imageUrl: "images/error.png",
                imageWidth: 50,
                showConfirmButton: true
            });
            return;
        }
        $("#Firmware-form").submit();
    }

    const Firmware_file = document.getElementById('Firmware-file');

    $("#Firmware-form").submit(function (e) {
        e.preventDefault();
        $("#uploadbtn").attr('disabled',true);
        $("#uploadprogress").show().val(0);
        $("input[name='DeviceType']").val(olddevicetype._id);
        var formData = new FormData(this);
        formData.append("DeviceTypeId", newdevicetype._id);
        $.ajax({
            type: "POST",
            url: "/iafs/firmware",
            data: formData,
            processData: false,
            contentType: false,
            xhr: function(){
                var xhr = new window.XMLHttpRequest();

                // Handle progress
                //Upload progress
                xhr.upload.addEventListener("progress", function(evt){
                    if (evt.lengthComputable) {
                        $("#uploadprogress").val((evt.loaded*100) / evt.total);
                        classnew = 'mdi-hexagon-slice-'+hex;

                    }
                }, false);
                //Download progress
                xhr.addEventListener("progress", function(evt){
                    if (evt.lengthComputable) {
                        var percentComplete = 'downloaded = '+evt.loaded / evt.total;
                        //Do something with download progress
                        console.log(percentComplete);
                    }
                }, false);

                return xhr;
            },
            complete:function(){
//                Firmware_file.value = '';
                console.log("Request finished.");
                $("#uploadbtn").attr('disabled',false);

                $('#devtfirmware > div.b-1.col-grey.p-l-20.p-t-10.p-b-10 > div').not(':first').remove();
                load_sspage($('#devinfoload'));
//                show_sspage('/customer/views/iadevice.customer.list.view.html');
//                $('#UPLD-size').text('');//Added
//                $('#UPLD-file-name').val('').addClass('disabled');
//                $('#UPLD-file-name').attr('placeholder',UPLD_placeholder);
//                $('#UPLD-duration').val('');
//                $('#UPLD-duration-show').text('');
//                $('#UPLD-file-label').removeClass('disabled');
//                $('#UPLD-btn').removeClass("col-red mdi-hexagon-slice-6").addClass("col-grey disabled UPLICON");
            },
            success: function(r){
                swal.fire({
                    title: "Done",
                    html: "File uploaded Successfully",
                    //                    timer: 2000,
                    icon: "success",
                    showConfirmButton: true
                });
                $('#Series').val('');
                $('#Version').val('');
                $('#Firmware-file').val('');
                $('#Firmware-file-label').text('Choose .bin File');
                $('#uploadprogress').val(0);
            },
            error: function (e) {
                console.error("some error", e);
            }
        });
    });
</script>
